<!DOCTYPE HTML>
<html lang="ja" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>爆速で身に着けるRuby on Rails：自分だけのCMSを開発しよう！</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="会員制メディア&amp;CMS開発による実践的アプローチ">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="welcome.html">Welcome to 爆速で身に着けるRuby on Rails：自分だけのCMSを開発しよう！</a></li><li class="chapter-item expanded "><a href="running-the-course.html"><strong aria-hidden="true">1.</strong> 本講座について</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="running-the-course/course-structure.html"><strong aria-hidden="true">1.1.</strong> 講座</a></li><li class="chapter-item expanded "><a href="running-the-course/course-building.html"><strong aria-hidden="true">1.2.</strong> 事前準備</a></li><li class="chapter-item expanded "><a href="running-the-course/demo-day.html"><strong aria-hidden="true">1.3.</strong> Demo Day</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Day 0: Ruby基礎</li><li class="chapter-item expanded "><a href="day-0/what-is-ruby.html"><strong aria-hidden="true">2.</strong> Rubyとは</a></li><li class="chapter-item expanded "><a href="day-0/exercise/welcome.html"><strong aria-hidden="true">3.</strong> Exercise</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="day-0/exercise/exercise-janken.html"><strong aria-hidden="true">3.1.</strong> Exercise - じゃんけんプログラム</a></li><li class="chapter-item expanded "><a href="day-0/exercise/exercise-vending-machine.html"><strong aria-hidden="true">3.2.</strong> Exercise - 自動販売機プログラム</a></li></ol></li><li class="chapter-item expanded "><a href="day-0/appendix/welcome.html"><strong aria-hidden="true">4.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="day-0/appendix/program.html"><strong aria-hidden="true">4.1.</strong> プログラム・文・式</a></li><li class="chapter-item expanded "><a href="day-0/appendix/variables.html"><strong aria-hidden="true">4.2.</strong> 変数と定数</a></li><li class="chapter-item expanded "><a href="day-0/appendix/literal.html"><strong aria-hidden="true">4.3.</strong> リテラル</a></li><li class="chapter-item expanded "><a href="day-0/appendix/operator.html"><strong aria-hidden="true">4.4.</strong> 演算子式</a></li><li class="chapter-item expanded "><a href="day-0/appendix/control.html"><strong aria-hidden="true">4.5.</strong> 制御構文</a></li><li class="chapter-item expanded "><a href="day-0/appendix/call.html"><strong aria-hidden="true">4.6.</strong> メソッド呼び出し(super・ブロック付き・yield)</a></li><li class="chapter-item expanded "><a href="day-0/appendix/def.html"><strong aria-hidden="true">4.7.</strong> クラス/メソッドの定義</a></li><li class="chapter-item expanded "><a href="day-0/appendix/flexical.html"><strong aria-hidden="true">4.8.</strong> 字句構造</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Day 0: Ruby on Rails基礎</li><li class="chapter-item expanded "><a href="day-0/what-is-ruby-on-rails.html"><strong aria-hidden="true">5.</strong> Ruby on Railsとは?</a></li><li class="chapter-item expanded "><a href="day-0/how-to-setup.html"><strong aria-hidden="true">6.</strong> Ruby on Railsの環境構築</a></li><li class="chapter-item expanded "><a href="day-0/web-development-overview.html"><strong aria-hidden="true">7.</strong> Ruby on Railsを用いたWeb開発の全体像</a></li><li class="chapter-item expanded affix "><li class="part-title">Day0: 事前学習</li><li class="chapter-item expanded "><a href="day-0/goal.html"><strong aria-hidden="true">8.</strong> 本講義プロジェクトMyCMSのER図</a></li><li class="chapter-item expanded "><a href="day-0/cms-sample.html"><strong aria-hidden="true">9.</strong> 記事管理機能⓪：サンプル</a></li><li class="chapter-item expanded affix "><li class="part-title">Day0 課題(Day1に向けた課題):</li><li class="chapter-item expanded "><a href="day-0/cms-tag.html"><strong aria-hidden="true">10.</strong> 記事管理機能①：タグ管理</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="day-0/cms-tag-index.html"><strong aria-hidden="true">10.1.</strong> 一覧画面</a></li><li class="chapter-item expanded "><a href="day-0/cms-tag-show.html"><strong aria-hidden="true">10.2.</strong> 詳細画面</a></li><li class="chapter-item expanded "><a href="day-0/cms-tag-edit.html"><strong aria-hidden="true">10.3.</strong> 編集画面</a></li><li class="chapter-item expanded "><a href="day-0/cms-tag-new.html"><strong aria-hidden="true">10.4.</strong> 作成画面</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">Day1 講義:</li><li class="chapter-item expanded "><a href="day-1/lecture.html"><strong aria-hidden="true">11.</strong> Day1 講義用ページ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="day-1/handson.html"><strong aria-hidden="true">11.1.</strong> Day1 ハンズオン</a></li></ol></li><li class="chapter-item expanded "><a href="day-1/theme.html"><strong aria-hidden="true">12.</strong> Day2に向けた課題</a></li><li class="chapter-item expanded affix "><li class="part-title">Day2 講義:</li><li class="chapter-item expanded "><a href="day-2/day-1-qa.html"><strong aria-hidden="true">13.</strong> Day1 QA</a></li><li class="chapter-item expanded "><a href="day-2/lecture.html"><strong aria-hidden="true">14.</strong> Day2 講義用ページ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="day-2/handson.html"><strong aria-hidden="true">14.1.</strong> Day2 ハンズオン</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="day-2/handson-auth-registration.html"><strong aria-hidden="true">14.1.1.</strong> 認証機能: 新規登録</a></li><li class="chapter-item expanded "><a href="day-2/handson-auth-session.html"><strong aria-hidden="true">14.1.2.</strong> 認証機能: ログイン</a></li><li class="chapter-item expanded "><a href="day-2/handson-payment.html"><strong aria-hidden="true">14.1.3.</strong> 決済機能</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="day-2/theme.html"><strong aria-hidden="true">15.</strong> Day3に向けた課題</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Day3 講義:</li><li class="chapter-item expanded "><a href="day-3/welcome.html"><strong aria-hidden="true">16.</strong> Day3用ページ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="day-3/short-url.html"><strong aria-hidden="true">16.1.</strong> Day3: 短縮URL管理画面</a></li><li class="chapter-item expanded "><a href="day-3/short-url-tracking.html"><strong aria-hidden="true">16.2.</strong> Day3: 短縮URLトラッキング機能</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">Appendix</li><li class="chapter-item expanded "><a href="appendix/welcome.html"><strong aria-hidden="true">17.</strong> Appendix</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="appendix/mvc-r.html"><strong aria-hidden="true">17.1.</strong> MVCとルーティング</a></li><li class="chapter-item expanded "><a href="appendix/routing.html"><strong aria-hidden="true">17.2.</strong> ルーティングについて</a></li><li class="chapter-item expanded "><a href="appendix/database-design.html"><strong aria-hidden="true">17.3.</strong> データベース構造と設計</a></li><li class="chapter-item expanded "><a href="appendix/database-migration.html"><strong aria-hidden="true">17.4.</strong> マイグレーション</a></li><li class="chapter-item expanded "><a href="appendix/active-record.html"><strong aria-hidden="true">17.5.</strong> ActiveRecordについて</a></li><li class="chapter-item expanded "><a href="appendix/controller.html"><strong aria-hidden="true">17.6.</strong> Controllerにまつわる処理ついて</a></li><li class="chapter-item expanded "><a href="appendix/rails-dev-command.html"><strong aria-hidden="true">17.7.</strong> Railsでよく使われるコマンド</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">爆速で身に着けるRuby on Rails：自分だけのCMSを開発しよう！</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="爆速で身に着けるruby-on-rails自分だけのcmsを開発しよう"><a class="header" href="#爆速で身に着けるruby-on-rails自分だけのcmsを開発しよう">爆速で身に着けるRuby on Rails：自分だけのCMSを開発しよう！</a></h1>
<blockquote>
<p><a href="https://gs-exp2023-rails.peatix.com/">【G's EXPANSION】 爆速で身に着けるRuby on Rails：自分だけのCMSを開発しよう！</a>の講座で使用する資料です。</p>
</blockquote>
<p>Rails Workbookは、Ruby on Rails(以下「Rails」といいます。)を使ってゼロからプロダクト開発を目指す人のためのアプリケーション構築ワークブックです。</p>
<p>本サイトは、Ruby・Railsの基本的な文法や構文から実際のプロダクト開発まで、Railsを使ったプロダクト開発を横断的にカバーすることを目指します。</p>
<p>本サイトの目標は、Railsを用いたWebサービス開発の理解を深めることです。本サイトを学ぶ読者には以下が身に付くことを期待します。</p>
<ul>
<li>
<p>Ruby、Railsの基本的な文法や構文を理解することができる</p>
</li>
<li>
<p>Railsを用いた開発（特にMVC）について理解することができる</p>
</li>
<li>
<p>Railsを用いたプロトタイプを作成することができる</p>
</li>
</ul>
<h2 id="題材---会員制メディアcms開発による実践的アプローチ"><a class="header" href="#題材---会員制メディアcms開発による実践的アプローチ">題材 - 会員制メディア&amp;CMS開発による実践的アプローチ</a></h2>
<p>以下題材として実践的なプロダクト開発を学びます。</p>
<ul>
<li>
<p>会員制メディア</p>
</li>
<li>
<p>CMS（コンテンツマネジメントシステム）</p>
</li>
</ul>
<p>題材を通じてRailsの理解が深まると、以下のようなサービスを開発する際に役立ちますと思います。</p>
<ul>
<li>
<p>ポートフォリオサイト</p>
</li>
<li>
<p>ブログ</p>
</li>
<li>
<p>ホームページ</p>
</li>
<li>
<p>NewsPicksや日経電子版のような会員制メディア</p>
</li>
<li>
<p>Substackのようなメルマガシステム</p>
</li>
<li>
<p>自社プロダクトの社内管理画面</p>
</li>
</ul>
<p>管理画面のスクリーションショット（イメージです）</p>
<p><img src="./welcome/sample1.png" alt="img" /></p>
<h2 id="本講座で行わないこと"><a class="header" href="#本講座で行わないこと">本講座で行わないこと</a></h2>
<p>まずはRailsの基礎を学ぶことを目的としているので、以下は本講座では扱いません。</p>
<ul>
<li>
<p>Railsのデプロイ方法</p>
</li>
<li>
<p>テスト</p>
</li>
<li>
<p>デザインやCSS</p>
</li>
<li>
<p>JavaScript</p>
</li>
</ul>
<h2 id="前提"><a class="header" href="#前提">前提</a></h2>
<p>本サイトは、プログラミングを学んだことがある人を対象としています。PHPやPython、JavaScriptなどの動的型付け言語でプログラミングする方法を知っている場合は、問題なく進めることができるかと思います。</p>
<!-- 本サイトで頻出する用語について記述します。
|  Target                       | std |rustc|cargo| notes                      | MIPS (LE) Linux (2.6.18+)  |
|-------------------------------|-----|-----|-----|----------------------------|----------------------------|
| `x86_64-unknown-linux-musl`   |  ✓  |     |     | 64-bit Linux with MUSL     | MIPS (LE) Linux (2.6.18+)  |
| `arm-linux-androideabi`       |  ✓  |     |     | ARM Android                | MIPS (LE) Linux (2.6.18+)  |
| `arm-unknown-linux-gnueabi`   |  ✓  |  ✓  |     | ARM Linux (2.6.18+)        | MIPS (LE) Linux (2.6.18+)  |
| `arm-unknown-linux-gnueabihf` |  ✓  |  ✓  |     | ARM Linux (2.6.18+)        | MIPS (LE) Linux (2.6.18+)  |
| `aarch64-unknown-linux-gnu`   |  ✓  |     |     | ARM64 Linux (2.6.18+)      | MIPS (LE) Linux (2.6.18+)  |
| `mips-unknown-linux-gnu`      |  ✓  |     |     | MIPS Linux (2.6.18+)       | MIPS (LE) Linux (2.6.18+)  |
| `mipsel-unknown-linux-gnu`    |  ✓  |     |     | MIPS (LE) Linux (2.6.18+)  | MIPS (LE) Linux (2.6.18+)  | -->
<!-- ## コマンドメモ

```bash

mdbook serve -p 9090 --open

``` --><div style="break-before: page; page-break-before: always;"></div><h1 id="本講座"><a class="header" href="#本講座">本講座</a></h1>
<blockquote>
<p>本講座を始める前に準備する内容についてのページです。</p>
</blockquote>
<p>講座を受講する前に、次のことを行う必要があります。</p>
<ol>
<li>Dockerのインストール</li>
<li>テキストエディタのインストール（今回は「Visual Studio Code」をメインに扱います）</li>
<li>Ruby、RailsでWebアプリケーション開発するための環境構築</li>
</ol>
<p>詳しくは <strong><a href="running-the-course/course-building.html">事前準備</a></strong> ページをご覧ください</p>
<p>本講座が、皆さんのWebアプリケーション開発に役立つことを願っています。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="講座について"><a class="header" href="#講座について">講座について</a></h1>
<blockquote>
<p>このページは、サイト構成についてです。基本的にそれぞれの日程は「課題」「講義」に分かれています。</p>
</blockquote>
<p>講義の関係上、課題時の実装ボリュームが大きくなります。</p>
<ol>
<li>Day 0: 環境構築、Ruby、Railsの基本的な文法や構文、ファイル構成について</li>
<li>Day 1: Day 0のサマリー、管理者画面でのメルマガ管理機能・記事管理機能、会員画面の記事表示について</li>
<li>Day 2: Day 1のサマリー、管理者画面での決済管理機能、会員画面の決済機能について</li>
<li>Day 3: それぞれが実装した機能をアウトプットします</li>
</ol>
<h2 id="day0"><a class="header" href="#day0">Day0</a></h2>
<p>講義前の準備になります。今回3回講座ですが、3日目は「Demo Day」を予定している関係で、事前に課題を多く出させていただきます。</p>
<p>事前準備:</p>
<ul>
<li>Ruby, Railsの環境構築</li>
<li>Ruby基礎</li>
<li>Rails基礎</li>
</ul>
<p>課題:</p>
<ul>
<li>本講座の全体像・ゴールの確認</li>
<li>サンプルコードの確認</li>
<li>【管理画面】記事管理機能をつくろう①</li>
</ul>
<h2 id="day1"><a class="header" href="#day1">Day1</a></h2>
<p>講義:</p>
<ul>
<li>Day0の振り返り</li>
<li>【管理画面】記事管理機能をつくろう②</li>
<li>【管理画面】メルマガ管理機能をつくろう</li>
</ul>
<p>Day2に向けた課題:</p>
<ul>
<li>【管理画面】記事管理機能をつくろう③</li>
<li>【ユーザー画面】トップページに記事を表示しよう</li>
</ul>
<h2 id="day2"><a class="header" href="#day2">Day2</a></h2>
<p>講義:</p>
<ul>
<li>Day1の振り返り</li>
<li>【ユーザー画面】決済機能をつくろう</li>
</ul>
<p>Day3に向けた課題:</p>
<ul>
<li>自分が実装したい機能を考えて実装してみましょう</li>
</ul>
<h2 id="day3-demo-day"><a class="header" href="#day3-demo-day">Day3: Demo Day</a></h2>
<p>講義:</p>
<ul>
<li>Day2の振り返り</li>
</ul>
<p>Demo Day:</p>
<ul>
<li>皆さんの発表とコードレビューなど</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="インストール"><a class="header" href="#インストール">インストール</a></h1>
<blockquote>
<p>このページは、講座準備に関するページです。</p>
</blockquote>
<h2 id="docker-desktopをインストールする"><a class="header" href="#docker-desktopをインストールする">Docker Desktopをインストールする</a></h2>
<p>まずはDocker Desktopをインストールします。以下Docker公式ページからインストールしてください。</p>
<p><a href="https://www.docker.com/products/docker-desktop/">Docker Desktopをインストール</a></p>
<h2 id="visual-studio-codeをインストールする"><a class="header" href="#visual-studio-codeをインストールする">Visual Studio Codeをインストールする</a></h2>
<p>今回Ruby, Railsを記述するためのテキストエディタとして、Visual Studio Codeを使用します。以下ダウンロードページからダウンロードをお願いします。</p>
<p><a href="https://code.visualstudio.com/download">Visual Studio Codeをインストール</a></p>
<p>またVisual Studio Codeの拡張機能である「Visual Studio Code Dev Containers」を使用します。
Dockerに慣れている方、ローカルにRuby, Railsの環境構築ができる方に関しては、Visual Studio Codeでなくても問題ありません。
普段お使いのエディアをご使用ください。</p>
<p><a href="https://code.visualstudio.com/docs/devcontainers/containers">Visual Studio Code Dev Containersを始める</a></p>
<h2 id="ruby-railsの環境構築"><a class="header" href="#ruby-railsの環境構築">Ruby, Railsの環境構築</a></h2>
<p>以下のぺージを参考に、Ruby, Railsの環境構築をお願いします。</p>
<p><a href="running-the-course/../day-0/how-to-setup.html">環境構築</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="demo-day"><a class="header" href="#demo-day">Demo Day</a></h1>
<p>最終日は皆さんが作ったプロダクトや機能を発表していただきます。</p>
<p>今回の講座で学んだことをフル活用して、自分が作りたいプロダクトや機能にチャレンジしてみてください。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rubyとは"><a class="header" href="#rubyとは">Rubyとは</a></h1>
<p>Rubyは、Matzことまつもとゆきひろ氏が1995年に公開されたプログラミング言語です。主にWebアプリケーション開発で使用されることが多く、Ruby on RailsというWebアプリケーションフレームワークが有名です。</p>
<blockquote>
<p><a href="https://www.ruby-lang.org/ja/">Ruby公式ドキュメント</a><br>
<a href="https://docs.ruby-lang.org/ja/3.2/doc/spec=2fintro.html">Ruby特長</a></p>
</blockquote>
<ul>
<li>
<p>シンプルで美しい構文</p>
<ul>
<li>Rubyは、読みやすく書きやすいシンプルで美しい構文が特長です。コードが自然言語に近く、プログラマが直感的に理解しやすいため、初心者にも取り組みやすい言語とされています。また、構文の柔軟性が高く、同じ処理をさまざまな方法で書くことができます。</li>
</ul>
</li>
<li>
<p>オブジェクト指向言語</p>
<ul>
<li>Rubyは、純粋なオブジェクト指向言語です。すべての値がオブジェクトであり、クラスとインスタンスを使用してデータと振る舞いをカプセル化できます。これにより、コードの再利用性や保守性が向上し、大規模なプロジェクトでも効率的に開発できます。</li>
</ul>
</li>
<li>
<p>豊富なライブラリとコミュニティ</p>
<ul>
<li>Rubyには、標準ライブラリや外部ライブラリ（gem）が豊富に用意されており、さまざまな機能を簡単に追加できます。また、活発なコミュニティがあり、開発者が互いに知識や技術を共有しています。これにより、新しい技術や手法が迅速に普及し、開発者が効率的に学び、スキルアップできます。</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise"><a class="header" href="#exercise">Exercise</a></h1>
<p>いくつか題材を元に、Rubyの基礎を学びたいと思います。</p>
<ul>
<li><a href="day-0/exercise/./exercise-janken.html">じゃんけんプログラム</a></li>
<li><a href="day-0/exercise/./exercise-vending-machine.html">自動販売機プログラム</a></li>
</ul>
<p>各ページで書き方の解説をしていますが、別途、<a href="day-0/exercise/../appendix/welcome.html">Appendix</a>にもまとめていますので、そちらも参照してください。</p>
<h2 id="環境構築"><a class="header" href="#環境構築">環境構築</a></h2>
<p><a href="day-0/exercise/../day-0/how-to-setup.html">環境構築</a>がまだの方は、先にこちらを行ってください。</p>
<h2 id="環境構築後の準備"><a class="header" href="#環境構築後の準備">環境構築後の準備</a></h2>
<p>Remote Containerを起動し、<code>/workspace</code>に移動します。</p>
<pre><code class="language-bash">pwd
#=&gt; /workspace
</code></pre>
<p>Ruby事前学習用に、<code>lib/training</code>ディレクトリを作成し、<code>janken.rb</code>と<code>vending_machine.rb</code>を作成します。</p>
<pre><code class="language-bash">mkdir -p lib/training &amp;&amp; touch lib/training/janken.rb &amp;&amp; touch lib/training/vending_machine.rb
</code></pre>
<p>実行するには、以下のコマンドを実行します。</p>
<pre><code class="language-bash">ruby lib/training/janken.rb
</code></pre>
<p>例えば、<code>janken.rb</code>の中身を以下のように書き換えてみてください。</p>
<p>Filename: <code>lib/training/janken.rb</code></p>
<pre><code class="language-ruby">puts &quot;Hello World!&quot;
</code></pre>
<p>実行すると、以下のように出力されます。</p>
<pre><code class="language-bash">ruby lib/training/janken.rb 
#=&gt; Hello World!
</code></pre>
<p>本講義資料は、サンプルコードベースを元に学習することを想定しているので、ご自身の環境で実行しながら学習を進めてください。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise---じゃんけんプログラム"><a class="header" href="#exercise---じゃんけんプログラム">Exercise - じゃんけんプログラム</a></h1>
<h2 id="なぜこのプログラムを作るのか"><a class="header" href="#なぜこのプログラムを作るのか">なぜこのプログラムを作るのか</a></h2>
<p>始めから文法を覚えるのではなく、実際どのようにソースコードが書かれているのかを軸として、Rubyの基礎を学びたいと思います。
おそらく何かしらプログラミング言語を用いて、プログラムを作成したことがある方が多いと思いますので、Rubyの雰囲気を感じていただきつつ、Rubyの基礎を学んでいただければと思います。
じゃんけんのロジックは、クラス、インスタンス、関数、条件分岐などを実際に学ぶことができるので、最初の題材として選択しました。</p>
<h2 id="じゃんけんプログラムの仕様"><a class="header" href="#じゃんけんプログラムの仕様">じゃんけんプログラムの仕様</a></h2>
<ul>
<li>じゃんけんの手は、グー・チョキ・パーの3つ</li>
<li>片方の手は、ランダムに決定する</li>
<li>片方の手は、クラスを初期化する際に指定する</li>
</ul>
<h2 id="完成形"><a class="header" href="#完成形">完成形</a></h2>
<p>まずはじゃんけんプログラムを使って、Rubyの基礎を学びます。</p>
<p>Filename: lib/training/janken.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

module Training
  class Janken
    attr_accessor :inputed_hand, :my_hand

    def initialize(inputed_hand = 0)
      @inputed_hand = inputed_hand
      @my_hand = self.class.my_hand
    end

    def self.my_hand
      rand(3)
    end

    def buttle
      (@inputed_hand - @my_hand + 3) % 3
    end

    def judge
      result = buttle
      if result == 0
        &quot;DRAW&quot;
      elsif result == 1
        &quot;WIN&quot;
      else
        &quot;LOSE&quot;
      end
    end
  end
end

a = Training::Janken.new(0)
puts a.inputed_hand
puts a.my_hand
puts a.buttle
puts a.judge
</code></pre>
<p>キーワード</p>
<blockquote>
<p>クラス(class), インスタンス(instance), attr_accessorアクセサリ, ゲッター, セッター, メソッド, インスタンス変数, モジュール(module), if文, case式</p>
</blockquote>
<h2 id="じゃんけんプログラムで使うrubyが定義するメソッドたまに使うが忘れても良い"><a class="header" href="#じゃんけんプログラムで使うrubyが定義するメソッドたまに使うが忘れても良い">じゃんけんプログラムで使うRubyが定義するメソッド（たまに使うが忘れても良い）</a></h2>
<h3 id="rand-メソッド"><a class="header" href="#rand-メソッド">rand メソッド</a></h3>
<p>参考</p>
<blockquote>
<p><a href="https://docs.ruby-lang.org/ja/latest/method/Kernel/m/rand.html">module function Kernel.#rand</a></p>
</blockquote>
<p><code>rand</code>メソッドは、疑似乱数を生成するメソッドです。今回は、グー・チョキ・パーの3つの手のうち、ランダムに1つを選択するために使用します(0〜3の範囲の整数をランダムに生成)。</p>
<pre><code class="language-ruby">def self.my_hand
  rand(3)
end
</code></pre>
<h3 id="じゃんけん勝敗ロジックrubyメソッドではないが記載"><a class="header" href="#じゃんけん勝敗ロジックrubyメソッドではないが記載">じゃんけん勝敗ロジック（Rubyメソッドではないが記載）</a></h3>
<p>参考</p>
<blockquote>
<p><a href="https://staku.designbits.jp/check-janken/">じゃんけん勝敗判定アルゴリズムの思い出</a></p>
</blockquote>
<p>以下のロジックを使用します</p>
<pre><code class="language-ruby">def buttle(a,b)
  (a - b + 3) % 3
end
</code></pre>
<h2 id="クラスとインスタンス"><a class="header" href="#クラスとインスタンス">クラスとインスタンス</a></h2>
<pre class="mermaid">graph TD;
  A[クラス];
  B[インスタンス];

  A-. &quot;newメソッド(初期化)&quot; -.-&gt;B;
</pre>
<h3 id="class"><a class="header" href="#class">Class</a></h3>
<p>クラスは特定の関心事を持つメソッドや定数をまとめたものです。クラスはオブジェクトであり、インスタンスを作成することができます。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Janken
  # メソッド
  # 変数・定数
  # などを定義する
end
</code></pre>
<h3 id="instance"><a class="header" href="#instance">Instance</a></h3>
<p>インスタンスは、クラスから生成されたオブジェクトのことを指します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Janken
  # newメソッドを使用してインスタンスを生成した場合に、initializeメソッドが呼び出される
  def initialize(inputed_hand = 0)
    @inputed_hand = inputed_hand
  end
end

a = Janken.new
</code></pre>
<h3 id="module"><a class="header" href="#module">Module</a></h3>
<p>Rubyのモジュールは、関連するメソッドや定数をグループ化するための仕組みです。クラスと同じように、モジュールもオブジェクトです。モジュールはインスタンスを作成することはできません。</p>
<ul>
<li>定数やメソッドをまとめる</li>
<li>クラスに組み込んで多重継承を実現する(ミックスイン)</li>
<li>名前空間を提供する</li>
</ul>
<pre><code class="language-ruby"># frozen_string_literal: true

module Training
  class Janken
  end
end
</code></pre>
<h2 id="変数とメソッド"><a class="header" href="#変数とメソッド">変数とメソッド</a></h2>
<p>参考</p>
<blockquote>
<p><a href="day-0/exercise/variables.html">変数と定数</a> <br>
<a href="day-0/exercise/def.html">クラス/メソッドの定義</a></p>
</blockquote>
<h3 id="インスタンス変数とインスタンス関数"><a class="header" href="#インスタンス変数とインスタンス関数">インスタンス変数とインスタンス関数</a></h3>
<h2 id="ゲッターとセッター"><a class="header" href="#ゲッターとセッター">ゲッターとセッター</a></h2>
<p>Filename: lib/training/janken.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

module Training
  class Janken
    def initialize(inputed_hand = 0)
      @inputed_hand = inputed_hand
    end

    # Getter
    def inputed_hand
      @inputed_hand
    end

    # Setter
    def inputed_hand=(inputed_hand)
      @inputed_hand = inputed_hand
    end
  end  
end

a = Training::Janken.new(0)
puts a.inputed_hand
#=&gt; 0
</code></pre>
<h2 id="アクセサリメソッド"><a class="header" href="#アクセサリメソッド">アクセサリメソッド</a></h2>
<p>参考</p>
<blockquote>
<p><a href="https://docs.ruby-lang.org/ja/latest/method/Module/i/attr_accessor.html">instance method Module#attr_accessor</a></p>
</blockquote>
<p>ゲッター/セッターは、<code>attr_accessor</code>メソッドを使用して簡略化して記述することができます。上記コードを<code>attr_accessor</code>メソッドを使用して書き直すと以下になります。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

module Training
  class Janken
    attr_accessor :inputed_hand

    def initialize(inputed_hand = 0)
      @inputed_hand = inputed_hand
    end

    # attr_accessor :inputed_handによって、以下のメソッドが定義される
    # def inputed_hand
    #   @inputed_hand
    # end
    # def inputed_hand=(inputed_hand)
    #   @inputed_hand = inputed_hand
    # end
  end
end

a = Training::Janken.new(0)
puts a.inputed_hand
</code></pre>
<p><code>attr_accessor</code>メソッドを使用して複数の名前を定義したい場合は、カンマで区切って記述します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

module Training
  class Janken
    attr_accessor :inputed_hand, :my_hand, :sample, ...

    # 省略
  end
end
</code></pre>
<p><code>attr_accessor</code>以外のメソッドもあります。プログラムの要件によって使い分けます。</p>
<div class="table-wrapper"><table><thead><tr><th>定義式</th><th>機能</th></tr></thead><tbody>
<tr><td><code>attr_reader</code></td><td>参照（ゲッター）</td></tr>
<tr><td><code>attr_writer</code></td><td>更新（セッター）</td></tr>
<tr><td><code>attr_accessor</code></td><td>参照&amp;更新（ゲッター/ゲッター）</td></tr>
</tbody></table>
</div>
<h2 id="演算子式と制御構文"><a class="header" href="#演算子式と制御構文">演算子式と制御構文</a></h2>
<p>参考</p>
<blockquote>
<p><a href="day-0/exercise/operator.html">演算子式</a> <br>
<a href="day-0/exercise/control.html">制御構文</a></p>
</blockquote>
<h2 id="おまけ"><a class="header" href="#おまけ">おまけ</a></h2>
<p>プログラムは要件によって書き方が変わります。いくつか他の書き方を紹介します。</p>
<h3 id="1-case-when式を使用したversion"><a class="header" href="#1-case-when式を使用したversion">1. case when式を使用したversion</a></h3>
<pre><code class="language-ruby"># frozen_string_literal: true

module Training
  class Janken
    TXT_DRAW = &quot;DRAW&quot;
    TXT_WIN = &quot;WIN&quot;
    TXT_LOSE = &quot;LOSE&quot;

    attr_accessor :inputed_hand, :my_hand

    def initialize(inputed_hand = 0)
      @inputed_hand = inputed_hand
      @my_hand = self.class.my_hand
    end

    def self.my_hand
      rand(3)
    end

    def buttle
      (@inputed_hand - @my_hand + 3) % 3
    end

    # if文をcase when式に書き換える
    def judge
      case buttle
      when 0
        TXT_DRAW
      when 1
        TXT_WIN
      else
        TXT_LOSE
      end
    end
  end
end

a = Training::Janken.new(0)
puts a.inputed_hand
puts a.my_hand
puts a.buttle
puts a.judge
</code></pre>
<h3 id="2-ハッシュを用いたversion"><a class="header" href="#2-ハッシュを用いたversion">2. ハッシュを用いたversion</a></h3>
<pre><code class="language-ruby"># frozen_string_literal: true

module Training
  class Janken
    TXT_DRAW = &quot;DRAW&quot;
    TXT_WIN = &quot;WIN&quot;
    TXT_LOSE = &quot;LOSE&quot;
    # ハッシュを定義
    RESULT = {
      &quot;0&quot;: TXT_DRAW,
      &quot;1&quot;: TXT_WIN,
      &quot;2&quot;: TXT_LOSE
    }.freeze

    attr_accessor :inputed_hand, :my_hand

    def initialize(inputed_hand = 0)
      @inputed_hand = inputed_hand
      @my_hand = self.class.my_hand
    end

    def self.my_hand
      rand(3)
    end

    def buttle
      (@inputed_hand - @my_hand + 3) % 3
    end

    # ハッシュを用いて結果を返します。条件分岐が不要になります。
    def judge
      RESULT[buttle.to_s.to_sym]
    end

    def test
      RESULT
    end
  end
end

a = Training::Janken.new(0)
puts a.inputed_hand
puts a.my_hand
puts a.buttle
puts a.judge
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="exercise---自動販売機プログラム"><a class="header" href="#exercise---自動販売機プログラム">Exercise - 自動販売機プログラム</a></h1>
<h2 id="なぜこのプログラムを作るのか-1"><a class="header" href="#なぜこのプログラムを作るのか-1">なぜこのプログラムを作るのか</a></h2>
<p>自動販売機のロジックは、じゃんけんロジックよりも難しいですが、じゃんけんロジックで学んだことを使いながら、
さらに発展的な学習ができると考え、題材として選択しました。</p>
<h2 id="自動販売機プログラムの仕様"><a class="header" href="#自動販売機プログラムの仕様">自動販売機プログラムの仕様</a></h2>
<ul>
<li>飲み物を自由に設定できる</li>
<li>支払い方法は、現金と電子マネーを設定できる</li>
</ul>
<h2 id="完成形-1"><a class="header" href="#完成形-1">完成形</a></h2>
<p>Filename: lib/training/vending_machine.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

module VendingMachine
  class VendingMachine
    attr_accessor :drinks, :payments, :inventories, :person

    def initialize(person:)
      @person = person
      @drinks = Drink.initialize_drinks
      @payments = Payment.initialize_payments
      @inventories = Hash[*@drinks.map do |drink|
        [drink.key.to_sym, drink.inventory]
      end.flatten]
    end

    def buy!
      @person.display
      drink = choose_drink(@person)
      payment = choose_payment(@person)
      payment.transact(@person, drink)
      manage_invetory!(drink)
    end

    def choose_drink(person)
      display_drinks
      drink_inputed = gets
      selected_drink = select_drink(drink_inputed.to_i)
      selected_drink.display(person.name)
      selected_drink
    end

    def display_drinks
      puts &quot;飲み物を番号で選んでください。\n#{format_drinks}&quot;
    end

    def format_drinks
      @drinks.map do |drink|
        &quot;#{drink.id}: #{drink.name}&quot;
      end
    end

    def select_drink(id)
      selected_drink = select_drink_by_id(id)
      return selected_drink unless selected_drink.nil?

      puts &quot;飲み物が見つかりませんでした。終了します&quot;
      exit
    end

    def select_drink_by_id(id)
      @drinks.find { |drink| drink.id == id }
    end

    def choose_payment(person)
      display_payments
      payment_inputed = gets
      selected_payment = select_payment(payment_inputed.to_i)
      selected_payment.display(person.name)
      selected_payment
    end

    def select_payment(id)
      selected_payment = select_payment_by_id(id)
      return selected_payment unless selected_payment.nil?

      puts &quot;支払い方法が見つかりませんでした。終了します&quot;
      exit
    end

    def select_payment_by_id(id)
      @payments.find { |payment| payment.id == id }
    end

    def display_payments
      puts &quot;支払い方法を番号で選んでください。\n#{format_payments}&quot;
    end

    def format_payments
      @payments.map do |payment|
        &quot;#{payment.id}: #{payment.name}&quot;
      end
    end

    def manage_invetory!(drink)
      target_drink_inventory = @inventories[drink.key.to_sym]
      rest_of_inventory = target_drink_inventory - 1
      @inventories[drink.key.to_sym] = rest_of_inventory
      puts &quot;#{drink.name}の在庫：#{rest_of_inventory}個&quot;
      puts &quot;全体の在庫：#{@inventories}&quot;
    end
  end

  class Drink
    attr_accessor :id, :key, :name, :price, :temperature_type, :inventory

    def initialize(id, key, name, price, temperature_type, inventory)
      @id = id
      @key = key
      @name = name
      @price = price
      @temperature_type = temperature_type
      @inventory = inventory
    end

    def self.initialize_drinks
      [
        new(1, &quot;cola&quot;, &quot;Cola&quot;, 100, &quot;cold&quot;, 10),
        new(2, &quot;tea&quot;, &quot;お〜いお茶&quot;, 150, &quot;hot&quot;, 5),
        new(3, &quot;pepsi&quot;, &quot;ペプシ&quot;, 100, &quot;cold&quot;, 7),
        new(4, &quot;oshiruko&quot;, &quot;おしるこ&quot;, 80, &quot;hot&quot;, 9),
        new(5, &quot;water&quot;, &quot;水&quot;, 130, &quot;cold&quot;, 12)
      ]
    end

    def display(person_name)
      puts &quot;#{person_name}が選んだ飲み物は：#{@name}, #{@price}円&quot;
    end
  end

  class Person
    attr_accessor :name, :cash, :e_cash

    def initialize(name = &quot;Noname&quot;, cash = 0, e_cash = 0)
      @name = name
      @cash = cash
      @e_cash = e_cash
    end

    def display
      puts &quot;購入者：#{@name}, 現金：#{@cash}円, 電子マネー：#{@e_cash}円&quot;
    end
  end

  class Payment
    TXT_CASH = &quot;cash&quot;
    TXT_E_CASH = &quot;e_cash&quot;

    attr_accessor :id, :name, :payment_type

    def initialize(id, name, payment_type)
      @id = id
      @name = name
      @payment_type = payment_type
    end

    def self.initialize_payments
      [
        new(1, &quot;現金&quot;, TXT_CASH),
        new(2, &quot;電子マネー&quot;, TXT_E_CASH)
      ]
    end

    def display(person_name)
      puts &quot;#{person_name}が選んだ支払い方法は：#{@name}&quot;
    end

    def transact(person, drink)
      person_money = get_person_money(person)
      drink_price = drink.price

      if can_buy?(person_money, drink_price, drink.inventory)
        change = charge!(person_money, drink_price)
        puts &quot;購入者の#{@name}残高：#{change}円&quot;
      else
        puts &quot;#{@name}もしくは在庫が不足しています。プログラムを終了します&quot;
        exit
      end
    end

    def get_person_money(person)
      case @payment_type
      when TXT_CASH
        person.cash
      when TXT_E_CASH
        person.e_cash
      end
    end

    def can_buy?(person_money, drink_price, drink_inventory)
      person_money &gt;= drink_price &amp;&amp; drink_inventory.positive?
    end

    def charge!(person_money, drink_price)
      person_money - drink_price
    end
  end
end

# 呼び出し側
person = VendingMachine::Person.new(&quot;Taro&quot;, 10, 2000)
vending_machine = VendingMachine::VendingMachine.new(person: person)
vending_machine.buy!
#=&gt; 購入者：Taro, 現金：10円, 電子マネー：2000円
# 飲み物を番号で選んでください。
# [&quot;1: Cola&quot;, &quot;2: お〜いお茶&quot;, &quot;3: ペプシ&quot;, &quot;4: おしるこ&quot;, &quot;5: 水&quot;]
# 1
# Taroが選んだ飲み物は：Cola, 100円
# 支払い方法を番号で選んでください。
# [&quot;1: 現金&quot;, &quot;2: 電子マネー&quot;]
# 2
# Taroが選んだ支払い方法は：電子マネー
# 購入可能です
# Colaの在庫：9個
# 全体の在庫：{:cola=&gt;9, :tea=&gt;5, :pepsi=&gt;7, :oshiruko=&gt;9, :water=&gt;12}
</code></pre>
<p>キーワード</p>
<blockquote>
</blockquote>
<h2 id="自動販売機プログラムで使うrubyが定義するメソッド忘れても良い"><a class="header" href="#自動販売機プログラムで使うrubyが定義するメソッド忘れても良い">自動販売機プログラムで使うRubyが定義するメソッド（忘れても良い）</a></h2>
<h3 id="gets"><a class="header" href="#gets">gets</a></h3>
<p>getsメソッドは、標準入力から文字列を取得するメソッドです。</p>
<p>※標準入力とは、キーボードからの入力や、ファイルからの入力など、プログラムに入力を与えることができるものを指します。</p>
<pre><code class="language-ruby">drink_inputed = gets

#=&gt; 飲み物を番号で選んでください。
# [&quot;1: Cola&quot;, &quot;2: お〜いお茶&quot;, &quot;3: ペプシ&quot;, &quot;4: おしるこ&quot;, &quot;5: 水&quot;]
#
</code></pre>
<p>1が入力された場合、<code>drink_inputed</code>には<code>1\n</code>が代入されます。</p>
<h2 id="rubyのreturn"><a class="header" href="#rubyのreturn">Rubyのreturn</a></h2>
<p>プログラミング言語を学ぶと、必ず出てくるのがreturnです。Rubyにおいてもreturnは存在しますが、returnを書かなくてもメソッドの最後に評価した値が返り値となります。</p>
<p>※明示的にreturnを書くこともありますが、基本的には書かなくても良いです。</p>
<pre><code class="language-ruby">def format_payments
  @payments.map do |payment|
    &quot;#{payment.id}: #{payment.name}&quot;
  end
end
</code></pre>
<p>明示的にreturnを書く場合は、以下のように書きます。</p>
<pre><code class="language-ruby">def format_payments
  return @payments.map do |payment|
    &quot;#{payment.id}: #{payment.name}&quot;
  end
end
</code></pre>
<p>ただ多くの場合は、returnを書かない方がRubyらしい書き方となります。</p>
<h3 id="早期リターン"><a class="header" href="#早期リターン">早期リターン</a></h3>
<p>早期リターンとは、メソッドの途中でreturnを書くことです。以下のように、メソッドの途中でreturnを書くことで、メソッドの処理を途中で終了させることができます。いくつかの書き換え方がありますが、どれも同義で、主に可読性を考慮して書き換えます。</p>
<pre><code class="language-ruby">def print_message(user)
  return puts &quot;ユーザーが存在しません&quot; if user.nil?

  puts &quot;ユーザー名：#{user.name}&quot;
end

# 1. 上記の書き換え
# def print_message(user)
#   if user.nil?
#     puts &quot;ユーザーが存在しません&quot;
#     return
#   end

#   puts &quot;ユーザー名：#{user.name}&quot;
# end

# 2. 上記の書き換え
# def print_message(user)
#   if user.nil?
#     puts &quot;ユーザーが存在しません&quot;
#   else
#     puts &quot;ユーザー名：#{user.name}&quot;
#   end
# end
</code></pre>
<pre><code class="language-ruby">def select_drink(id)
  selected_drink = select_drink_by_id(id)
  return selected_drink unless selected_drink.nil?

  puts &quot;飲み物が見つかりませんでした。終了します&quot;
  exit
end
</code></pre>
<h2 id="クラスメソッド"><a class="header" href="#クラスメソッド">クラスメソッド</a></h2>
<p>Rubyにおけるクラスメソッドは、特定のクラスに関連付けられたメソッドのことを指します。クラスメソッドはそのクラスのインスタンスではなく、クラス自体に対して呼び出します。これらは、通常、そのクラス全体に関連する動作を定義するために使用されます。</p>
<p>クラスメソッドは、メソッド名の前に「self.」を付けることで定義します。ここでの「self」は、そのメソッドが定義されているコンテキスト（この場合はクラス）を参照します。</p>
<pre><code class="language-ruby">class Drink
  # クラスメソッド
  def self.initialize_drinks
    [
      new(1, &quot;cola&quot;, &quot;Cola&quot;, 100, &quot;cold&quot;, 10),
      new(2, &quot;tea&quot;, &quot;お〜いお茶&quot;, 150, &quot;hot&quot;, 5),
      new(3, &quot;pepsi&quot;, &quot;ペプシ&quot;, 100, &quot;cold&quot;, 7),
      new(4, &quot;oshiruko&quot;, &quot;おしるこ&quot;, 80, &quot;hot&quot;, 9),
      new(5, &quot;water&quot;, &quot;水&quot;, 130, &quot;cold&quot;, 12)
    ]
  end

  # 上記は以下のように書き換えることもできます。
  # class &lt;&lt; self
  #   [
  #     new(1, &quot;cola&quot;, &quot;Cola&quot;, 100, &quot;cold&quot;, 10),
  #     new(2, &quot;tea&quot;, &quot;お〜いお茶&quot;, 150, &quot;hot&quot;, 5),
  #     new(3, &quot;pepsi&quot;, &quot;ペプシ&quot;, 100, &quot;cold&quot;, 7),
  #     new(4, &quot;oshiruko&quot;, &quot;おしるこ&quot;, 80, &quot;hot&quot;, 9),
  #     new(5, &quot;water&quot;, &quot;水&quot;, 130, &quot;cold&quot;, 12)
  #   ]
  # end

  # インスタンスメソッド
  def display(person_name)
    puts &quot;#{person_name}が選んだ飲み物は：#{@name}, #{@price}円&quot;
  end
end
</code></pre>
<p>それぞれのメソッドを呼び出す場合は、以下のように呼び出します。</p>
<pre><code class="language-ruby"># クラスメソッドの呼び出し
# クラスメソッドは、クラス名.メソッド名で呼び出します。クラスから直接呼び出すことができます。
Drink.initialize_drinks
#=&gt; ドリンク情報が初期化される

# インスタンスメソッドの呼び出し
# インスタンスメソッドは、インスタンスを生成してから呼び出します。
drink = Drink.new(1, &quot;cola&quot;, &quot;Cola&quot;, 100, &quot;cold&quot;, 10)
drink.display(&quot;たろう&quot;)
#=&gt; たろうが選んだ飲み物は：Cola, 100円
</code></pre>
<h2 id="関数の引数"><a class="header" href="#関数の引数">関数の引数</a></h2>
<h3 id="デフォルト引数"><a class="header" href="#デフォルト引数">デフォルト引数</a></h3>
<p>ソッド定義の中で引数にデフォルトの値を設定することです。これにより、メソッド呼び出し時にその引数を省略した場合、デフォルトの値が自動的に使用されます。</p>
<pre><code class="language-ruby">def greet(name = &quot;world&quot;)
  puts &quot;Hello, #{name}!&quot;
end

greet(&quot;Ruby&quot;)  # =&gt; &quot;Hello, Ruby!&quot;
greet          # =&gt; &quot;Hello, world!&quot;
</code></pre>
<h3 id="名前付き引数またはキーワード引数"><a class="header" href="#名前付き引数またはキーワード引数">名前付き引数（またはキーワード引数）</a></h3>
<p>メソッド呼び出し時に引数名（キー）とその値を指定することです。これにより、引数の順序を気にせずにメソッドを呼び出すことができます。また、メソッド定義の可読性も向上します。</p>
<pre><code class="language-ruby">def person_info(name:, age:, city:)
  puts &quot;#{name} is #{age} years old and lives in #{city}.&quot;
end

person_info(name: &quot;Alice&quot;, age: 25, city: &quot;Tokyo&quot;)
# =&gt; &quot;Alice is 25 years old and lives in Tokyo.&quot;
</code></pre>
<h2 id="メソッド群"><a class="header" href="#メソッド群">メソッド群</a></h2>
<p>自動販売機プログラムで使用されるメソッドについていくつか紹介します。</p>
<h3 id="map-と-each"><a class="header" href="#map-と-each">map と each</a></h3>
<p>よく使うメソッドとして、<code>map</code>と<code>each</code>があります。どちらも配列の要素を順番に取り出して、ブロックの処理を実行します。違いは、<code>map</code>はブロックの戻り値を配列にして返すことです。<code>each</code>はブロックの戻り値を返しません。</p>
<pre><code class="language-ruby">array = [1, 2, 3]

array.each do |num|
  num * 2
end

#=&gt; [1, 2, 3]

array.map do |num|
  num * 2
end

#=&gt; [2, 4, 6]
</code></pre>
<p>基本的に<code>each</code>は単純な繰り返し処理、<code>map</code>は繰り返し処理を行いながら配列を作成したい場合に使います。</p>
<h3 id="find-と-select"><a class="header" href="#find-と-select">find と select</a></h3>
<p>findは、ブロックの戻り値が真になった最初の要素を返します。selectは、ブロックの戻り値が真になった要素を全て返します。</p>
<pre><code class="language-ruby">array = [1, 2, 3, 4, 5]

array.find do |num|
  num.even?
end

#=&gt; 2

array.select do |num|
  num.even?
end

#=&gt; [2, 4]
</code></pre>
<h3 id="flatten"><a class="header" href="#flatten">flatten</a></h3>
<p>flattenは、多次元配列を一次元配列にします。</p>
<pre><code class="language-ruby">array = [[1, 2], [3, 4], [5, 6]]

array.flatten
#=&gt; [1, 2, 3, 4, 5, 6]
</code></pre>
<h2 id="とのつくメソッドのつくり方"><a class="header" href="#とのつくメソッドのつくり方">「?」と「!」のつくメソッドのつくり方</a></h2>
<p>Rubyでは、メソッド名の最後に「?」や「!」をつけることができます。これらのメソッドは、Rubyの慣習として、以下のような意味を持ちます。</p>
<h3 id="をつけるメソッド"><a class="header" href="#をつけるメソッド">?をつけるメソッド</a></h3>
<p>メソッド名の最後に「?」がついていると、そのメソッドは真偽値（真または偽）を返すことを示しています。これは、ある条件が真であるか偽であるかを問い合わせるメソッドであることを示します。たとえば、RubyのArrayクラスのempty?メソッドは、配列が空であるかどうかを確認します。</p>
<pre><code class="language-ruby">array = []
puts array.empty?
# =&gt; true
</code></pre>
<h3 id="をつけるメソッド-1"><a class="header" href="#をつけるメソッド-1">!をつけるメソッド</a></h3>
<p>メソッド名の最後に「!」がついていると、そのメソッドが何らかの形で「危険」な動作を行うことを示しています。たとえば、オブジェクトを変更する（つまり、副作用を持つ）メソッドや、エラーを引き起こす可能性があるメソッドなどです。この記号は、メソッドが通常の動作とは異なる何らかの振る舞いをすることを示しています。</p>
<pre><code class="language-ruby">str = &quot;Hello, world!&quot;
str.gsub!('world', 'Ruby')
puts str  # =&gt; &quot;Hello, Ruby!&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ruby基礎-appendix"><a class="header" href="#ruby基礎-appendix">Ruby基礎 Appendix</a></h1>
<p>Ruby基礎に関する補足情報をまとめています。以下の項目を参照してください。</p>
<ul>
<li><a href="day-0/appendix/./program.html">プログラム・文・式</a></li>
<li><a href="day-0/appendix/./variables.html">変数と定数</a></li>
<li><a href="day-0/appendix/./literal.html">リテラル</a></li>
<li><a href="day-0/appendix/./operator.html">演算子式</a></li>
<li><a href="day-0/appendix/./control.html">制御構文</a></li>
<li><a href="day-0/appendix/./call.html">メソッド呼び出し(super・ブロック付き・yield)</a></li>
<li><a href="day-0/appendix/./def.html">クラス/メソッドの定義</a></li>
<li><a href="day-0/appendix/./flexical.html">字句構造</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="プログラム文式"><a class="header" href="#プログラム文式">プログラム・文・式</a></h1>
<p>プログラムは、式を並べたものです。まずは恒例の <code>Hello World!</code>を表示させましょう。</p>
<pre><code class="language-ruby">print &quot;hello world!\n&quot;  #=&gt; Hello World!
</code></pre>
<pre><code class="language-ruby">puts &quot;Hello World!\n&quot;  #=&gt; Hello World!
</code></pre>
<p>上記は同じ出力結果になります。違う書き方だけど同じような出力結果になる</p>
<h2 id="式"><a class="header" href="#式">式</a></h2>
<pre><code class="language-ruby">true
false
1+2+3+4+5*3
filter_articles()
if true then puts &quot;ok&quot; else &quot;ng&quot; end
</code></pre>
<p>Rubyの式</p>
<div class="table-wrapper"><table><thead><tr><th>項目</th><th></th></tr></thead><tbody>
<tr><td>式</td><td><a href="day-0/appendix/variables.html">変数と定数</a></td></tr>
<tr><td></td><td><a href="day-0/appendix/literal.html">リテラル</a></td></tr>
<tr><td></td><td><a href="day-0/appendix/operator.html">演算子式</a></td></tr>
<tr><td></td><td><a href="day-0/appendix/control.html">制御構文</a></td></tr>
<tr><td></td><td><a href="day-0/appendix/call.html">メソッド呼び出し(super・ブロック付き・yield)</a></td></tr>
<tr><td></td><td><a href="day-0/appendix/def.html">クラス/メソッドの定義</a></td></tr>
<tr><td>式のグルーピング</td><td>(), {}, do end</td></tr>
<tr><td>式の評価</td><td>式は評価されると値(評価値)が決まり、その値を返します。<br>ただし、return、break、nextといったものは値を返しません。これらは評価された時点で制御が移ってしまいます</td></tr>
<tr><td>空の式</td><td>nilを返します。</td></tr>
<tr><td>メソッドの引数に指定できるか否か</td><td>メソッドの引数に指定できない式を「文」と呼び分ける場合があります。</td></tr>
<tr><td>文：メソッドの引数に指定できない式</td><td>and, or, not, if/unless/rescue修飾式, ...</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="変数と定数"><a class="header" href="#変数と定数">変数と定数</a></h1>
<p>Rubyはいくつかの変数を持ちます。</p>
<div class="table-wrapper"><table><thead><tr><th>変数名</th><th>宣言例</th><th>命名規則</th></tr></thead><tbody>
<tr><td><code>ローカル変数</code></td><td><code>name = &quot;Yuki Tanaka&quot;; age = 25</code></td><td></td></tr>
<tr><td><code>インスタンス変数</code></td><td><code>@name = &quot;Yuki Tanaka&quot;; @age = 25</code></td><td><code>@</code>で始まります</td></tr>
<tr><td><code>クラス変数</code></td><td><code>@@name = &quot;Yuki Tanaka&quot;; @@age = 25</code></td><td><code>@@</code>で始まります</td></tr>
<tr><td><code>グローバル変数</code></td><td><code>$name = &quot;Yuki Tanaka&quot;; $age = 25</code></td><td><code>$</code>で始まります</td></tr>
<tr><td><code>定数</code></td><td><code>NAME = &quot;Yuki Tanaka&quot;; AGE = 25</code></td><td>アルファベット大文字([A-Z])で始まる識別子</td></tr>
</tbody></table>
</div>
<p>本ページで登場するクラスについては<a href="day-0/appendix/def.html">クラス/メソッドの定義</a>で詳しく確認します。</p>
<h2 id="ローカル変数"><a class="header" href="#ローカル変数">ローカル変数</a></h2>
<p>ローカル変数のスコープは、宣言した位置からその変数が宣言されたブロック、メソッド定義、またはクラス/モジュール定義の終りまでです。</p>
<pre><code class="language-ruby">
# (A)の部分はスコープに入らない
3.times do |t|
  p defined?(v)          # (A)
  v = &quot;Hello World #{t}&quot; # ここ(宣言開始)から
  p v                    # ここ(ブロックの終わり)までが v のスコープ
end

# =&gt; nil
# &quot;Hello World 0&quot;
# nil
# &quot;Hello World 1&quot;
# nil
# &quot;Hello World 2&quot;
</code></pre>
<p>宣言は、実行されなかったとしても宣言とみなされます。</p>
<pre><code class="language-ruby">v = &quot;Hello World!&quot; unless true  # 代入は行われないが宣言は有効
p defined?(v)                   # =&gt; &quot;local-variable&quot;
p v                             # =&gt; nil
</code></pre>
<h2 id="インスタンス変数"><a class="header" href="#インスタンス変数">インスタンス変数</a></h2>
<p>インスタンス変数は、クラスのインスタンス（オブジェクト）ごとに独立した値を保持するために使用されます。インスタンス変数の名前は、<code>@</code>で始まります。</p>
<pre><code class="language-ruby">@name
@articles
</code></pre>
<p>例えば、GPT3.5-turboをAPIでコールするときには、以下のような記述をします。インスタンス化された時に、<code>@client</code>というインスタンス変数が定義されます。この例では、インスタンス変数に<code>OpenAI::Clientインスタンス</code>が格納され、<code>OpenAI::Client</code>のインスタンス関数である<code>chat</code>をコールしています。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

# [!!!COUTION]そのままコピペしても動きません。雰囲気を掴んでください
class OpenAIGptClient
  # newで自動的に呼ばれるオブジェクト初期化メソッド
  def initialize
    # インスタンス変数
    @client = OpenAI::Client.new(
      access_token: &quot;Input access token&quot;,
      organization_id: &quot;Input organization_id&quot;
    )
  end

  # インスタンス関数
  def process
    @client.chat(
      {
        :parameters =&gt; {
          :model =&gt; &quot;gpt-3.5-turbo&quot;,
          :messages =&gt; [],
          :max_tokens =&gt; 1024,
        }
      }
    )
  end
end

# 呼び出し方の例
@gpt_client = OpenAIGptClient.new
@gpt_client.process
</code></pre>
<p>例：オブジェクトごとに異なる設定を保持する</p>
<pre><code class="language-ruby">class Circle
  def initialize(radius, color = 'red')
    @radius = radius
    @color = color
  end

  def area
    Math::PI * @radius * @radius
  end

  def describe
    puts &quot;この円は#{@color}色で、面積は#{area}です。&quot;
  end
end

circle1 = Circle.new(5)
circle1.describe  #=&gt; &quot;この円はred色で、面積は78.53981633974483です。&quot;

circle2 = Circle.new(3, 'blue')
circle2.describe  #=&gt; &quot;この円はblue色で、面積は28.274333882308138です。&quot;
</code></pre>
<h2 id="クラス変数"><a class="header" href="#クラス変数">クラス変数</a></h2>
<p>クラス変数は、クラス内のすべてのインスタンスで共有される変数です。そのため、クラス全体で状態を保持したり、情報を共有する際に役立ちます。</p>
<p>例：ユニークなIDをインスタンスに割り当てる</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Item
  # クラス変数
  @@next_id = 1

  def initialize(name)
    @name = name # インスタンス変数
    @id = @@next_id # インスタンス変数@idに、クラス変数@@next_idを代入
    @@next_id += 1 # クラス変数をカウントアップ
  end

  def display_id
    puts &quot;ID: #{@id}&quot;
  end
end

item1 = Item.new(&quot;Item1&quot;)
item1.display_id  #=&gt; &quot;ID: 1&quot;

item2 = Item.new(&quot;Item2&quot;)
item2.display_id #=&gt; &quot;ID: 2&quot;
</code></pre>
<h2 id="グローバル変数"><a class="header" href="#グローバル変数">グローバル変数</a></h2>
<p>グローバル変数は、プログラム全体でアクセスできる変数で、$で始まる名前が付けられます。ただし、グローバル変数は使用を避けるべきです。なぜなら、コードの可読性と保守性を低下させ、デバッグが困難になるからです。代わりに、オブジェクト指向プログラミングの原則に従って、クラスやモジュールを使用することが推奨されます。</p>
<pre><code class="language-ruby">$default_tax_rate = 0.1

def calculate_price(price)
  price * (1 + $default_tax_rate)
end

puts calculate_price(100)  #=&gt; 110.0
</code></pre>
<h2 id="定数"><a class="header" href="#定数">定数</a></h2>
<p>定数は、プログラムの実行中に変更されない値を保持するために使用されます。定数の名前は、すべて大文字で表記し、単語間にアンダースコアを使用します。</p>
<pre><code class="language-ruby">class MathConstants
  PI = 3.141592653589793
  E = 2.718281828459045
end

def calculate_area_of_circle(radius)
  MathConstants::PI * radius * radius
end

puts calculate_area_of_circle(5)  #=&gt; 78.53981633974483
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="リテラル"><a class="header" href="#リテラル">リテラル</a></h1>
<p>数字の1や文字列&quot;hello world&quot;のようにRubyのプログラムの中に直接記述できる値の事をリテラルといいます。</p>
<div class="table-wrapper"><table><thead><tr><th>リテラル</th><th></th><th></th></tr></thead><tbody>
<tr><td><code>数値リテラル</code></td><td><code>整数</code><br><code>符号付き整数</code><br><code>浮動小数点</code><br><code>16進整数</code></td><td><code>123</code><br><code>-123</code><br><code>123.45</code><br><code>0xffff</code></td></tr>
<tr><td><code>文字列リテラル</code></td><td></td><td><code>&quot;Yuki Tanaka&quot;</code><br><code>'This is a string expression'</code></td></tr>
<tr><td><code>配列式</code></td><td></td><td><code>[1, 2, 3]</code><br><code>%w(a b c)</code><br><code>%W(a b c)</code></td></tr>
<tr><td><code>ハッシュ式</code></td><td></td><td><code>{ 1 =&gt; 2, 2 =&gt; 4, 3 =&gt; 6}</code><br><code>{ :a =&gt; &quot;A&quot;, :b =&gt; &quot;B&quot;, :c =&gt; &quot;C&quot; }</code><br><code>{ a:&quot;A&quot;, b:&quot;B&quot;, c:&quot;C&quot; }</code><br><code>{ &quot;a&quot;:&quot;A&quot;, 'b':&quot;B&quot;, &quot;c&quot;:&quot;C&quot; }</code></td></tr>
<tr><td><code>シンボル</code></td><td></td><td><code>:class</code><br><code>:method!</code><br><code>:andthisis?</code><br><code>:@var</code><br><code>:@@var</code><br><code>:+</code></td></tr>
<tr><td><code>%記法</code></td><td></td><td><code>%w!STRING! : 要素が文字列の配列(空白区切り)</code><br><code>%i!STRING! : 要素がシンボルの配列(空白区切り)</code></td></tr>
</tbody></table>
</div>
<h2 id="数値リテラル"><a class="header" href="#数値リテラル">数値リテラル</a></h2>
<p>例</p>
<pre><code class="language-ruby">def main
  default_tax = 0.1
  price = 100
  result = (price * (1 + default_tax)).to_i
  puts &quot;result: #{result}&quot;
end

main
#=&gt; 110
</code></pre>
<h2 id="文字列リテラル"><a class="header" href="#文字列リテラル">文字列リテラル</a></h2>
<p>例</p>
<pre><code class="language-ruby">def main
  name = &quot;Yuki Tanaka&quot;
  puts name
  puts &quot;My name is #{name}.&quot; # 式展開
  puts &quot;My name is&quot; + name + &quot;.&quot;
end

main
#=&gt; Yuki Tanaka
#=&gt; My name is Yuki Tanaka.
#=&gt; My name is Yuki Tanaka.
</code></pre>
<h2 id="配列式"><a class="header" href="#配列式">配列式</a></h2>
<p>例</p>
<pre><code class="language-ruby">def main
  arr = [1, 2, 3]
  for arr in a
    puts a
  end
end

main
#=&gt; 1
# 2
# 3
</code></pre>
<h2 id="ハッシュ式"><a class="header" href="#ハッシュ式">ハッシュ式</a></h2>
<p>例</p>
<pre><code class="language-ruby">def main
  hash = {
    :name =&gt; &quot;Yuki Tanaka&quot;,
    :age =&gt; 25,
    :company =&gt; &quot;Kidsweekend Inc.&quot;
  }
  hash.each do |k, v|
    puts &quot;key: #{k}, value: #{v}&quot;
  end
end

main
#=&gt; key: name, value: Yuki Tanaka
# key: age, value: 25
# key: company, value: Kidsweekend Inc.
</code></pre>
<h2 id="シンボル"><a class="header" href="#シンボル">シンボル</a></h2>
<p>例</p>
<pre><code class="language-ruby">def main
  puts :'foo-bar'
  puts :&quot;foo-bar&quot; 
  puts %s{foo-bar}
end

main
#=&gt; :&quot;foo-bar&quot;
#=&gt; :&quot;foo-bar&quot;
#=&gt; :&quot;foo-bar&quot;
</code></pre>
<h2 id="記法"><a class="header" href="#記法">%記法</a></h2>
<p>文字列リテラル、コマンド出力、正規表現リテラル、配列式、シンボルでは、 %で始まる形式の記法を用いることができます。</p>
<p>例</p>
<pre><code class="language-ruby">def main
  %w(foo bar baz) # ['foo', 'bar', 'baz']と同じ
  %i(foo bar baz) # [:foo, :bar, :baz]と同じ
end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="演算子式"><a class="header" href="#演算子式">演算子式</a></h1>
<h2 id="代入"><a class="header" href="#代入">代入</a></h2>
<pre><code class="language-ruby">article = Article.find(1)
articles[0] = 1
article.key = &quot;value&quot;
</code></pre>
<h2 id="自己代入"><a class="header" href="#自己代入">自己代入</a></h2>
<pre><code class="language-ruby">count += 12 # count = count + 12
a ||= 1 #  a が偽か未定義ならば1を代入。初期化時のイディオムの一種。
</code></pre>
<h2 id="多重代入"><a class="header" href="#多重代入">多重代入</a></h2>
<pre><code class="language-ruby">article, tag, keyword = Article.find(1), Tag.last, Keyword.first
sum, average = 0, 0
</code></pre>
<h2 id="範囲式"><a class="header" href="#範囲式">範囲式</a></h2>
<pre><code class="language-ruby">1..20 # 1&lt;=n&lt;=20
1...20 # 1&lt;=n&lt;20
Article.where(started_at: Date.new(2023,4,1)..Date.new(2023,4,30)) # 2023/04/01&lt;=n&lt;=2023/04/30
</code></pre>
<h2 id="and"><a class="header" href="#and">and</a></h2>
<pre><code class="language-ruby">tokyo &amp;&amp; kyoto
tokyo and kyoto
</code></pre>
<p>左辺を評価し、結果が偽であった場合はその値(つまり nil か false) を返します。左辺の評価結果が真であった場合には右辺を評価しその結果を返します。</p>
<pre><code class="language-ruby">nil &amp;&amp; false # =&gt; nil
false &amp;&amp; nil # =&gt; false
1 &amp;&amp; 2 # =&gt; 2
</code></pre>
<h2 id="or"><a class="header" href="#or">or</a></h2>
<pre><code class="language-ruby">deploy || die
deploy or die
</code></pre>
<p>左辺を評価し、結果が真であった場合にはその値を返します。左辺の評価結果が偽であった場合には右辺を評価しその評価結果を返します。</p>
<pre><code class="language-ruby">1 || 2 # =&gt; 1
nil || false # =&gt; false
false || nil # =&gt; nil
</code></pre>
<h2 id="not"><a class="header" href="#not">not</a></h2>
<pre><code class="language-ruby">!false
not false
</code></pre>
<h2 id="条件演算子"><a class="header" href="#条件演算子">条件演算子</a></h2>
<pre><code class="language-ruby">sum == 100 ? &quot;合計が正しい&quot; : &quot;合計が正しくない&quot;
# 同義: if sum == 100 then &quot;合計が正しい&quot; else &quot;合計が正しくない&quot; end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="制御構文"><a class="header" href="#制御構文">制御構文</a></h1>
<h2 id="条件分岐"><a class="header" href="#条件分岐">条件分岐</a></h2>
<h3 id="if"><a class="header" href="#if">if</a></h3>
<pre><code class="language-ruby">if sum &gt;= 100
  print &quot;合計が100を超えている&quot;
else
  print &quot;合計が100を超えていない&quot;
end
</code></pre>
<p>Rubyでは、<code>if</code>、<code>elsif</code>、<code>else</code>を使う</p>
<pre><code class="language-ruby">if sum &gt;= 200
  print &quot;合計が200を超えている&quot;
elsif sum &gt;= 100
  print &quot;合計が100を超えている&quot;
else
  print &quot;合計が100を超えていない&quot;
end
</code></pre>
<p>if 修飾子。こんな書き方もできます。</p>
<pre><code class="language-ruby">print &quot;合計が100を超えている&quot; if sum &gt;= 100
</code></pre>
<h3 id="unless"><a class="header" href="#unless">unless</a></h3>
<pre><code class="language-ruby">unless sum &gt;= 100
  print &quot;合計が100を超えていない&quot;
else
  print &quot;合計が100を超えている&quot;
end
</code></pre>
<p>unless 修飾子。こんな書き方もできます。</p>
<pre><code class="language-ruby">print &quot;合計が99以下&quot; unless sum &gt;= 100
</code></pre>
<h3 id="case"><a class="header" href="#case">case</a></h3>
<p>case は一つの式に対する一致判定による分岐を行います。when 節で指定された値と最初の式を評価した結果とを演算子 === を用いて比較して、一致する場合には when 節の本体を評価します。</p>
<p>例1</p>
<pre><code class="language-ruby">case $age
when 0 .. 2
  &quot;baby&quot;
when 3 .. 6
  &quot;little child&quot;
when 7 .. 12
  &quot;child&quot;
when 13 .. 18
  &quot;youth&quot;
else
  &quot;adult&quot;
end
</code></pre>
<p><code>if</code>を使って書き直すと以下になります。</p>
<pre><code class="language-ruby">if $age &gt;= 0 &amp;&amp; $age &lt;= 2
  &quot;baby&quot;
elsif $age &gt;= 3 &amp;&amp; $age &lt;= 6
  &quot;little child&quot;
elsif $age &gt;= 7 &amp;&amp; $age &lt;= 12
  &quot;child&quot;
elsif $age &gt;= 13 &amp;&amp; $age &lt;= 18
  &quot;youth&quot;
else
  &quot;adult&quot;
end
</code></pre>
<p>例2</p>
<pre><code class="language-ruby">case $status
when &quot;opened&quot;, &quot;accepting&quot;
  &quot;Can apply&quot;
when &quot;closed&quot;, &quot;suspended&quot;
  &quot;Cannot apply&quot;
else
  &quot;Not permitted&quot;
end
</code></pre>
<p><code>if</code>を使って書き直すと以下になります。</p>
<pre><code class="language-ruby">if $status === &quot;opened&quot; || $status === &quot;accepting&quot;
  &quot;Can apply&quot;
elsif $status === &quot;closed&quot; || $status === &quot;suspended&quot;
  &quot;Cannot apply&quot;
else
  &quot;Not permitted&quot;
end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="メソッド呼び出しsuperブロック付きyield"><a class="header" href="#メソッド呼び出しsuperブロック付きyield">メソッド呼び出し(super・ブロック付き・yield)</a></h1>
<blockquote>
<p><a href="https://docs.ruby-lang.org/ja/3.2/doc/spec=2fcall.html">メソッド呼び出し(super・ブロック付き・yield)</a></p>
</blockquote>
<h2 id="関数と定数の呼び出し方法"><a class="header" href="#関数と定数の呼び出し方法">関数と定数の呼び出し方法</a></h2>
<pre><code class="language-ruby">person.calc_age()
person.calc_age
calc_age()
print &quot;Hello World\n&quot;
print
Person.new
Person::new
Person::TEXT_LENGTH
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>変数名</th><th>宣言例</th><th>命名規則</th></tr></thead><tbody>
<tr><td><code>インスタンスメソッド</code></td><td><code>person.calc_age(); person.calc_age</code></td><td><code>.</code>を使用してメソッドを呼び出すことができます</td></tr>
<tr><td><code>クラスメソッド</code></td><td><code>Person.new; Person::new</code></td><td><code>::</code>か<code>.</code>を使用してメソッド呼び出すことができます</td></tr>
<tr><td><code>定数</code></td><td><code>Person::TEXT_LENGTH</code></td><td><code>Person.TEXT_LENGTH</code>はNG</td></tr>
</tbody></table>
</div>
<h2 id="super"><a class="header" href="#super">super</a></h2>
<p>Rubyのsuperは、特殊なキーワードであり、サブクラス（子クラス）からスーパークラス（親クラス）のメソッドを呼び出すために使用されます。</p>
<p>superを呼び出すと、現在のメソッドと同じ名前のスーパークラスのメソッドが実行されます。superは引数を取ることができ、それらの引数はスーパークラスのメソッドに渡されます。</p>
<pre><code class="language-ruby">class MySample
  def test(arg = nil)
    p arg
  end
end

class Sample &lt; MySample
  def test(arg)
    super(&quot;test from inside&quot;)
    super(arg)
    super
    p &quot;Called sample class&quot;
  end
end

Sample.new.test(&quot;test from argument&quot;)
#=&gt; &quot;test from inside&quot;
#=&gt; &quot;test from argument&quot;
#=&gt; &quot;test from argument&quot;
#=&gt; &quot;Called sample class&quot;
</code></pre>
<p>別サンプル</p>
<pre><code class="language-ruby">class Animal
  def speak
    &quot;I'm an animal!&quot;
  end
end

class Dog &lt; Animal
  def speak
    &quot;#{super} And I'm a dog!&quot;
  end
end

dog = Dog.new
puts dog.speak
# =&gt; &quot;I'm an animal! And I'm a dog!&quot;
</code></pre>
<h2 id="ブロック"><a class="header" href="#ブロック">ブロック</a></h2>
<p>Rubyにおけるブロックは、メソッドを呼び出す際にコードのブロックを渡すことができる特性を指します。ブロックは、実行される一連の命令をカプセル化したものです。ブロックは {}（ブレース）または do..end を使って定義され、メソッド呼び出しの最後に配置されます。</p>
<div class="table-wrapper"><table><thead><tr><th>ブロックの特徴</th></tr></thead><tbody>
<tr><td><code>{}（ブレース）または do..endのことをブロックと呼ぶ</code></td></tr>
<tr><td><code>単独では存在できず，関数の引数にしかなれない</code></td></tr>
<tr><td><code>ブロックをProc.newでProcオブジェクトに変換すれば，callで呼び出せる</code></td></tr>
<tr><td><code>関数の引数にする場合は，最後の引数に &amp; を付与する。そうするとProcオブジェクトに変換される</code></td></tr>
</tbody></table>
</div>
<pre><code class="language-ruby"># {}（ブレース）を使用したブロック
[1, 2, 3].each { |num| puts num * 2 }

# do..endを使用したブロック
[1, 2, 3].each do |num|
  puts num * 2
end
</code></pre>
<p>ブロックの使い分けは、以下のようになります。</p>
<ul>
<li>一行のブロック: 一行のブロックを書くときは、ブレース {} を使用するのが一般的です。これは読みやすさのための慣習です。</li>
<li>複数行のブロック: 複数行のブロックを書くときは、do..end を使用するのが一般的です。これも読みやすさのための慣習です。</li>
<li>優先度: do..end と {} は異なる優先順位を持っています。{} は do..end よりも高い優先順位を持つため、メソッドチェインの一部としてブロックを使用する場合は {} を使用することが推奨されます。</li>
</ul>
<h3 id="優先度結合度の違い"><a class="header" href="#優先度結合度の違い">優先度(結合度)の違い</a></h3>
<pre><code class="language-ruby">names = ['Alice', 'Bob', 'Charlie']

# ブロックをdo..endで定義
puts names.map do |name|
  name.upcase
end.join(', ')

#=&gt; undefined method `join' for nil:NilClass (NoMethodError)

# ブロックを{}で定義
puts names.map {
  |name| name.upcase
}.join(', ')

#=&gt; ALICE, BOB, CHARLIE
</code></pre>
<p>このコードでは、names配列の各要素を大文字に変換し、その結果をカンマで連結して出力しようとしています。</p>
<p>しかし、do..endを使用した最初の例では、予想外の結果が得られます。このコードはnames.map do..end.join(', ')と解釈され、join(', ')メソッドがmapメソッドの戻り値ではなくmapメソッド自体に対して呼び出されてしまいます。これはdo..endの優先順位が低いためです。</p>
<p>一方、{}を使用した2つ目の例では、期待通りの結果が得られます。このコードはnames.map { |name| name.upcase }.join(', ')と解釈され、join(', ')メソッドがmapメソッドの戻り値に対して呼び出されます。これは{}の優先順位が高いためです。</p>
<p>したがって、メソッドチェインの中でブロックを使用する場合には、{}を使用することが推奨されます。</p>
<p>内部的な優先度として、以下のような流れで処理が行われているため、do..endでエラーが生じます。</p>
<div class="table-wrapper"><table><thead><tr><th>実行順番</th><th>do..end</th><th>{}</th></tr></thead><tbody>
<tr><td><code>1</code></td><td><code>mapメソッド</code></td><td><code>mapメソッド</code></td></tr>
<tr><td><code>2</code></td><td><code>joinメソッド</code></td><td><code>{}</code></td></tr>
<tr><td><code>3</code></td><td><code>do..end</code></td><td><code>joinメソッド</code></td></tr>
<tr><td><code>結果</code></td><td><code>undefined method 'join' for nil:NilClass</code></td><td><code>ALICE, BOB, CHARLIE</code></td></tr>
<tr><td><code>説明</code></td><td><code>mapメソッド自体にjoinメソッドが実行された</code></td><td><code>mapメソッドの戻り値にjoinメソッドが実行された</code></td></tr>
</tbody></table>
</div>
<h2 id="ブロック付きメソッド呼び出し"><a class="header" href="#ブロック付きメソッド呼び出し">ブロック付きメソッド呼び出し</a></h2>
<p>Rubyにおけるブロック付きメソッド呼び出しは、メソッドを呼び出す際にコードのブロックを渡すことができる特性を指します。ブロックは、実行される一連の命令をカプセル化したもので、それはメソッド内で yield を使用して呼び出すことができます。</p>
<pre><code class="language-ruby">def greet(&amp;block)
  puts &quot;Hello, #{block.call}!&quot;
end

greet { &quot;world&quot; }  # =&gt; &quot;Hello, world!&quot;
</code></pre>
<p>block.call は、ブロックを呼び出すための方法の1つです。他にも、yield を使用する方法があります。</p>
<pre><code class="language-ruby">def greet(&amp;block)
  puts &quot;Hello, #{yield}!&quot;
end

greet { &quot;world&quot; }  # =&gt; &quot;Hello, world!&quot;
</code></pre>
<p>yieldを使用する場合、blockという変数は不要になるため、以下のように書くこともできます。</p>
<pre><code class="language-ruby">def greet
  puts &quot;Hello, #{yield}!&quot;
end

greet { &quot;world&quot; }  # =&gt; &quot;Hello, world!&quot;
</code></pre>
<h3 id="ブロックを使用した例"><a class="header" href="#ブロックを使用した例">ブロックを使用した例</a></h3>
<pre><code class="language-ruby">def to_darling
  puts &quot;愛する人に送るメールです&quot;
  # 愛する人に送るメールの内容を書く
  # eg: DarlingMailer.i_love_you.deliver_now
  puts &quot;送信したよ♡&quot;
end

def to_friend
  puts &quot;友達に送るメールです&quot;
  # 友達に送るメールの内容を書く
  # eg: FriendMailer.what_is_up.deliver_now
  puts &quot;送った！&quot;
end

def send_mail
  puts &quot;メールを送信開始します&quot;
  yield
end
</code></pre>
<p>愛する人にメールを送る場合は、to_darlingメソッドを呼び出すだけで良いので、以下のように書くことができます。</p>
<pre><code class="language-ruby">send_mail do
  to_darling
end
#=&gt;メールを送信開始します
# 愛する人に送るメールです
# 送信したよ♡
</code></pre>
<p>友達にメールを送る場合は、to_friendメソッドを呼び出すだけで良いので、以下のように書くことができます。</p>
<pre><code class="language-ruby">send_mail do
  to_friend
end
#=&gt; メールを送信開始します
# 友達に送るメールです
# 送った！
</code></pre>
<p>ブロックごとに処理を定義しておけば、メールを送る相手によって、メールの内容を変えることができます。ブロック機能により、メソッドの処理を柔軟に変更することができます。</p>
<blockquote>
<p><a href="https://qiita.com/kidach1/items/15cfee9ec66804c3afd2">Ruby block/proc/lambdaの使いどころ</a> <br>
<a href="https://language-and-engineering.hatenablog.jp/entry/20101118/p1">Rubyの動かないコード　（初級編）　ブロックとクロージャの性質</a></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="クラスメソッドの定義"><a class="header" href="#クラスメソッドの定義">クラス/メソッドの定義</a></h1>
<h2 id="クラスとインスタンス-1"><a class="header" href="#クラスとインスタンス-1">クラスとインスタンス</a></h2>
<pre class="mermaid">graph TD;
  A[クラス];
  B[インスタンス];

  A-. &quot;newメソッド(初期化)&quot; -.-&gt;B;
</pre>
<h3 id="class-1"><a class="header" href="#class-1">Class</a></h3>
<p>クラスは特定の関心事を持つメソッドや定数をまとめたものです。クラスはオブジェクトであり、インスタンスを作成することができます。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Janken
  # メソッド
  # 変数・定数
  # などを定義する
end
</code></pre>
<h3 id="instance-1"><a class="header" href="#instance-1">Instance</a></h3>
<p>インスタンスは、クラスから生成されたオブジェクトのことを指します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Janken
  # newメソッドを使用してインスタンスを生成した場合に、initializeメソッドが呼び出される
  def initialize(inputed_hand = 0)
    @inputed_hand = inputed_hand
  end
end

a = Janken.new
</code></pre>
<h3 id="module-1"><a class="header" href="#module-1">Module</a></h3>
<p>Rubyのモジュールは、関連するメソッドや定数をグループ化するための仕組みです。クラスと同じように、モジュールもオブジェクトです。モジュールはインスタンスを作成することはできません。</p>
<ul>
<li>定数やメソッドをまとめる</li>
<li>クラスに組み込んで多重継承を実現する(ミックスイン)</li>
<li>名前空間を提供する</li>
</ul>
<pre><code class="language-ruby"># frozen_string_literal: true

module Training
  class Janken
  end
end
</code></pre>
<h2 id="メソッド"><a class="header" href="#メソッド">メソッド</a></h2>
<h3 id="メソッドの定義"><a class="header" href="#メソッドの定義">メソッドの定義</a></h3>
<p>Rubyでは、<code>def</code> というキーワードを使ってメソッドを定義します。</p>
<pre><code class="language-ruby">def sample_method
  # 処理
end
</code></pre>
<h3 id="メソッドの呼び出し"><a class="header" href="#メソッドの呼び出し">メソッドの呼び出し</a></h3>
<pre><code class="language-ruby">def sample_method
  puts &quot;This is sample method.&quot;
end

# 1.
sample_method
#=&gt; This is sample method.

# 2. この呼び方でもOK
sample_method()
#=&gt; This is sample method.
</code></pre>
<h3 id="引数"><a class="header" href="#引数">引数</a></h3>
<pre><code class="language-ruby"># arg1, arg2 は引数
def sample_method(arg1, arg2)
  puts arg1
  puts arg2
end

sample_method(&quot;Hello&quot;, &quot;World&quot;)
#=&gt; Hello
#=&gt; World
</code></pre>
<p>これでもOK</p>
<pre><code class="language-ruby"># かっこを省略してもOK
def sample_method1 arg1, arg2
  puts arg1
  puts arg2
end

sample_method1(&quot;Hello&quot;, &quot;World&quot;)
#=&gt; Hello
#=&gt; World

# 初期値を設定することもできる
def sample_method2 arg1=&quot;Hello&quot;, arg2=&quot;World&quot;
  puts arg1
  puts arg2
end

sample_method2(&quot;Hello&quot;, &quot;World&quot;)
#=&gt; Hello
#=&gt; World

# キーワードを指定して引数を渡すこともできる
def sample_method3 arg1: &quot;Hello&quot;, arg2: &quot;World&quot;
  puts arg1
  puts arg2
end

# キーワードを指定する場合は、関数を呼び出すときもキーワードを指定する必要がある
sample_method3(arg1: &quot;Hello&quot;, arg2: &quot;World&quot;)
#=&gt; Hello
#=&gt; World
</code></pre>
<h2 id="クラスのメソッド"><a class="header" href="#クラスのメソッド">クラスのメソッド</a></h2>
<h3 id="インスタンスメソッド"><a class="header" href="#インスタンスメソッド">インスタンスメソッド</a></h3>
<p>クラスから生成されたインスタンスから呼び出すことができるメソッドです。</p>
<pre><code class="language-ruby">
class Janken
  def initialize(inputed_hand = 0)
    @inputed_hand = inputed_hand
  end

  def inputed_hand
    @inputed_hand
  end
end

# インスタンスを生成
janken = Janken.new(1)

# インスタンスメソッドを呼び出す
janken.inputed_hand
</code></pre>
<h3 id="クラスメソッド-1"><a class="header" href="#クラスメソッド-1">クラスメソッド</a></h3>
<p>クラスから直接呼び出すことができるメソッドです。</p>
<pre><code class="language-ruby">class Janken
  def initialize(inputed_hand = 0)
    @inputed_hand = inputed_hand
  end

  def self.hands
    %w[グー チョキ パー]
  end
end

# クラスメソッドを呼び出す
Janken.hands
#=&gt; [&quot;グー&quot;, &quot;チョキ&quot;, &quot;パー&quot;]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="字句構造"><a class="header" href="#字句構造">字句構造</a></h1>
<h2 id="識別子"><a class="header" href="#識別子">識別子</a></h2>
<p>識別子は、英文字またはアンダースコアから始まり、英文字、アンダースコアまたは数字から表されます。識別子の長さに制限はありません。</p>
<h3 id="例"><a class="header" href="#例">例</a></h3>
<pre><code class="language-ruby">gs_academy
degital_hollywood_is_awsome
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="what-is-ruby-on-rails"><a class="header" href="#what-is-ruby-on-rails">What is Ruby on Rails</a></h1>
<p>Rails Workbookは、Ruby on Railsを使ってゼロからプロダクト開発を目指す人のためのアプリケーション構築ワークブックを目指すサイトです。</p>
<p>Ruby on Rails（ルビーオンレイルズ）は、Rubyというプログラミング言語で開発されたWebアプリケーションフレームワークです。短縮形としてRails（レイルズ）とも呼ばれます（本サイトでは以下「Rails」といいます）。</p>
<p>Railsは、MVC（Model-View-Controller）アーキテクチャに基づいており、アプリケーション開発を迅速かつ効率的に行うことができます。主にデータベースとのやり取りやルーティング、テンプレート処理などをサポートしており、開発者は簡単に拡張性のあるWebアプリケーションを構築することができます。</p>
<h2 id="railsのメリット"><a class="header" href="#railsのメリット">Railsのメリット</a></h2>
<ul>
<li>
<p>生産性向上: Railsは「Convention over Configuration（設定より規約）」の原則に従っており、開発者が多くの設定を行わずに済むよう、デフォルトの設定が用意されています。これにより、開発者はプロジェクトの立ち上げや機能追加に集中でき、効率的な開発が可能になります。</p>
</li>
<li>
<p>DRY（Don't Repeat Yourself）原則: Railsはコードの重複を避けることを重視しています。DRY原則に従って、一度書いたコードは再利用されることを意識して設計されているため、可読性や保守性が向上します。</p>
</li>
<li>
<p>豊富なエコシステム: Railsには多くのライブラリ（gem）が存在し、開発者が必要な機能を簡単に追加・組み込むことができます。これにより、開発スピードが上がり、さまざまなプロジェクトに対応することが容易になります。また、Railsのコミュニティは非常に活発であり、情報交換やサポートがしやすい環境が整っています。</p>
</li>
<li>
<p>柔軟な拡張性: Railsはモジュール式で設計されており、プラグインやgemの形で機能を追加・変更することが容易です。このため、アプリケーションの要件が変化しても柔軟に対応することができます。</p>
</li>
<li>
<p>テストしやすい設計: Railsは、テスト駆動開発（TDD）やビヘイビア駆動開発（BDD）を容易に実践できるよう、テスト環境が整備されています。また、MVCアーキテクチャにより、モデル、ビュー、コントローラーが疎結合で設計されているため、各コンポーネントを個別にテストしやすくなっています。これにより、品質の高いアプリケーション開発が促進されます。</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ruby-on-railsの環境構築"><a class="header" href="#ruby-on-railsの環境構築">Ruby on Railsの環境構築</a></h1>
<h2 id="ソースコードをダウンロードする"><a class="header" href="#ソースコードをダウンロードする">ソースコードをダウンロードする</a></h2>
<p>まずは今回使用するソースコードを、GithubからHTTPSでクローンします。</p>
<p>Gitをインストールしていない場合は、<a href="https://git-scm.com/downloads">こちら</a>からインストールしてください。</p>
<pre><code class="language-console">git clone https://github.com/matakitanakajp09/gs-expansion-rails-sample.git
</code></pre>
<h2 id="vscode-remote-containerでコンテナを起動する"><a class="header" href="#vscode-remote-containerでコンテナを起動する">VSCode Remote Containerでコンテナを起動する</a></h2>
<p>今回の作業ディレクトリ<code>gs-expansion-rails-sample</code>に移動します。</p>
<pre><code class="language-console">cd gs-expansion-rails-sample
</code></pre>
<p>このディレクトリを、Visual Studio Codeで開きます。</p>
<p>Codeコマンドとは. ターミナルからVSCodeを起動するために用意されたコマンドです。もし、Codeコマンドが使えないor使っていない場合は、VSCodeで直接開いてください。</p>
<pre><code class="language-console"># ./gs-expansion-rails-sample
code .
</code></pre>
<p>VSCodeで開いたら、Remote Containerでコンテナを起動します。</p>
<p><img src="day-0/./rails/how-to-setup5.png" alt="img" /></p>
<p>起動すると初回のDockerイメージのビルドが始まります。最初は時間がかかるので気長に待ちましょう。</p>
<p><img src="day-0/./rails/how-to-setup1.png" alt="img" /></p>
<p>Thanks for installing Config の文字が出れば成功です。</p>
<p><img src="day-0/./rails/how-to-setup2.png" alt="img" /></p>
<h3 id="vscode内のターミナルを開く"><a class="header" href="#vscode内のターミナルを開く">VSCode内のターミナルを開く</a></h3>
<p>これから実行するコマンドは、作業ディレクトリで実行してください。</p>
<pre><code class="language-console">pwd
#=&gt; /workspace
</code></pre>
<h2 id="railsを起動する"><a class="header" href="#railsを起動する">Railsを起動する</a></h2>
<p>Railsを起動するために、データベースの設定を行います。</p>
<h3 id="データベースの設定"><a class="header" href="#データベースの設定">データベースの設定</a></h3>
<p><code>config/database.yml</code>ファイルは、データベースの接続設定を記述するファイルです。環境ごとに設定を変更することができます。</p>
<p>Rails(puma)が起動すると、config/database.ymlの設定に従ってデータベースの接続を試みます。</p>
<p>Filename: config/database.sample.yml</p>
<pre><code class="language-console">cp config/database.sample.yml config/database.yml
</code></pre>
<h3 id="データベースの確認"><a class="header" href="#データベースの確認">データベースの確認</a></h3>
<p>db:migrate:statusタスクを実行して、現在のマイグレーションの状態を確認します。</p>
<pre><code class="language-console">bin/rails db:migrate:status
</code></pre>
<p>まだデータベースが存在していないので、以下のようなエラーが表示されます。</p>
<pre><code class="language-console">rails aborted!
ActiveRecord::NoDatabaseError: We could not find your database: gs_expansion_rails_sample_db. Which can be found in the database configuration file located at config/database.yml.

To resolve this issue:

- Did you create the database for this app, or delete it? You may need to create your database.
- Has the database name changed? Check your database.yml config has the correct database name.

To create your database, run:

        bin/rails db:create


Caused by:
PG::ConnectionBad: FATAL:  database &quot;gs_expansion_rails_sample_db&quot; does not exist

Tasks: TOP =&gt; db:migrate:status
(See full trace by running task with --trace)
</code></pre>
<h3 id="データベースを作成する"><a class="header" href="#データベースを作成する">データベースを作成する</a></h3>
<p>開発で使用するデータベースを作成します。</p>
<pre><code class="language-console">bin/rails db:create
</code></pre>
<pre><code class="language-console">Created database 'gs_expansion_rails_sample_db'
</code></pre>
<h3 id="マイグレーションを実行する"><a class="header" href="#マイグレーションを実行する">マイグレーションを実行する</a></h3>
<h4 id="再度データベースの確認する"><a class="header" href="#再度データベースの確認する">再度データベースの確認する</a></h4>
<pre><code class="language-console">bin/rails db:migrate:status
</code></pre>
<p>まだマイグレーションが実行されていないので、以下のようなエラーが表示されます。</p>
<pre><code class="language-console">Schema migrations table does not exist yet.
</code></pre>
<h4 id="データベースのマイグレーションを行う"><a class="header" href="#データベースのマイグレーションを行う">データベースのマイグレーションを行う</a></h4>
<p>初回のマイグレーションを行います。</p>
<pre><code class="language-console">bin/rails db:migrate
</code></pre>
<p>以下のように表示されれば成功です。</p>
<pre><code class="language-console">bin/rails db:migrate
== 20230521111713 CreateActiveStorageTables: migrating ========================
-- create_table(:active_storage_blobs, {:id=&gt;:uuid})
   -&gt; 0.0227s
-- create_table(:active_storage_attachments, {:id=&gt;:uuid})
   -&gt; 0.0227s
-- create_table(:active_storage_variant_records, {:id=&gt;:uuid})
   -&gt; 0.0124s
== 20230521111713 CreateActiveStorageTables: migrated (0.0580s) ===============

== 20230521112655 CreateUsers: migrating ======================================
-- create_table(:users, {:id=&gt;:uuid})
   -&gt; 0.0050s
== 20230521112655 CreateUsers: migrated (0.0051s) =============================

== 20230521113755 CreateUserRegistrations: migrating ==========================
-- create_table(:user_registrations, {:id=&gt;:uuid})
   -&gt; 0.0128s
-- add_index(:user_registrations, :confirmation_token, {:unique=&gt;true})
   -&gt; 0.0040s
-- add_index(:user_registrations, :unconfirmed_email, {:unique=&gt;true})
   -&gt; 0.0025s
== 20230521113755 CreateUserRegistrations: migrated (0.0195s) =================

== 20230521113756 CreateUserDatabaseAuthentications: migrating ================
-- create_table(:user_database_authentications, {:id=&gt;false, :primary_key=&gt;&quot;user_id&quot;})
   -&gt; 0.0130s
-- add_index(:user_database_authentications, :email, {:unique=&gt;true})
   -&gt; 0.0024s
== 20230521113756 CreateUserDatabaseAuthentications: migrated (0.0155s) =======

== 20230521113757 CreateUserAccountLockings: migrating ========================
-- create_table(:user_account_lockings, {:id=&gt;false, :primary_key=&gt;&quot;user_id&quot;})
   -&gt; 0.0144s
-- add_index(:user_account_lockings, :unlock_token, {:unique=&gt;true})
   -&gt; 0.0026s
== 20230521113757 CreateUserAccountLockings: migrated (0.0171s) ===============

== 20230521113758 CreateUserAccountTrackings: migrating =======================
-- create_table(:user_account_trackings, {:id=&gt;false, :primary_key=&gt;&quot;user_id&quot;})
   -&gt; 0.0173s
== 20230521113758 CreateUserAccountTrackings: migrated (0.0180s) ==============

== 20230521113759 CreateUserPasswordResetRequests: migrating ==================
-- create_table(:user_password_reset_requests, {:id=&gt;false, :primary_key=&gt;&quot;user_id&quot;})
   -&gt; 0.0125s
-- add_index(:user_password_reset_requests, :reset_password_token, {:unique=&gt;true})
   -&gt; 0.0031s
== 20230521113759 CreateUserPasswordResetRequests: migrated (0.0162s) =========

== 20230522112655 CreateAdmins: migrating =====================================
-- create_table(:admins, {:id=&gt;:uuid})
   -&gt; 0.0071s
== 20230522112655 CreateAdmins: migrated (0.0072s) ============================

== 20230522113755 CreateAdminRegistrations: migrating =========================
-- create_table(:admin_registrations, {:id=&gt;:uuid})
   -&gt; 0.0149s
-- add_index(:admin_registrations, :confirmation_token, {:unique=&gt;true})
   -&gt; 0.0028s
-- add_index(:admin_registrations, :unconfirmed_email, {:unique=&gt;true})
   -&gt; 0.0044s
== 20230522113755 CreateAdminRegistrations: migrated (0.0225s) ================

== 20230522113756 CreateAdminDatabaseAuthentications: migrating ===============
-- create_table(:admin_database_authentications, {:id=&gt;false, :primary_key=&gt;&quot;admin_id&quot;})
   -&gt; 0.0156s
-- add_index(:admin_database_authentications, :email, {:unique=&gt;true})
   -&gt; 0.0022s
== 20230522113756 CreateAdminDatabaseAuthentications: migrated (0.0179s) ======

== 20230522113757 CreateAdminAccountLockings: migrating =======================
-- create_table(:admin_account_lockings, {:id=&gt;false, :primary_key=&gt;&quot;admin_id&quot;})
   -&gt; 0.0185s
-- add_index(:admin_account_lockings, :unlock_token, {:unique=&gt;true})
   -&gt; 0.0039s
== 20230522113757 CreateAdminAccountLockings: migrated (0.0225s) ==============

== 20230522113758 CreateAdminAccountTrackings: migrating ======================
-- create_table(:admin_account_trackings, {:id=&gt;false, :primary_key=&gt;&quot;admin_id&quot;})
   -&gt; 0.0188s
== 20230522113758 CreateAdminAccountTrackings: migrated (0.0189s) =============

== 20230522113759 CreateAdminPasswordResetRequests: migrating =================
-- create_table(:admin_password_reset_requests, {:id=&gt;false, :primary_key=&gt;&quot;admin_id&quot;})
   -&gt; 0.0135s
-- add_index(:admin_password_reset_requests, :reset_password_token, {:unique=&gt;true})
   -&gt; 0.0042s
== 20230522113759 CreateAdminPasswordResetRequests: migrated (0.0178s) ========

== 20230529075027 CreateAuthors: migrating ====================================
-- create_table(:authors, {:id=&gt;:uuid})
   -&gt; 0.0118s
== 20230529075027 CreateAuthors: migrated (0.0119s) ===========================

== 20230529085435 CreateCurrentStatusEnum: migrating ==========================
-- create_enum(:current_status, [&quot;draft&quot;, &quot;published&quot;, &quot;archived&quot;, &quot;trashed&quot;])
   -&gt; 0.0048s
== 20230529085435 CreateCurrentStatusEnum: migrated (0.0053s) =================

== 20230529085530 CreateCategories: migrating =================================
-- create_table(:categories, {:id=&gt;:uuid})
   -&gt; 0.0085s
== 20230529085530 CreateCategories: migrated (0.0086s) ========================

== 20230529113755 CreateActionTextTables: migrating ===========================
-- create_table(:action_text_rich_texts, {:id=&gt;:uuid})
   -&gt; 0.0110s
== 20230529113755 CreateActionTextTables: migrated (0.0111s) ==================
</code></pre>
<h3 id="静的ファイル関連設定"><a class="header" href="#静的ファイル関連設定">静的ファイル関連設定</a></h3>
<p>esbuildをインストールします</p>
<pre><code class="language-bash">bin/rails javascript:install:esbuild
</code></pre>
<h3 id="railspumaを起動する"><a class="header" href="#railspumaを起動する">Rails(puma)を起動する</a></h3>
<p>Railsを起動するには、以下のコマンドを実行します。</p>
<pre><code class="language-bash">bin/rails s
</code></pre>
<p>ターミナルに以下のような表示が出たら、Railsが起動しています。</p>
<pre><code class="language-console">=&gt; Booting Puma
=&gt; Rails 7.0.3 application starting in development 
=&gt; Run `bin/rails server --help` for more startup options
Puma starting in single mode...
* Puma version: 5.6.4 (ruby 3.1.2-p20) (&quot;Birdie's Version&quot;)
*  Min threads: 5
*  Max threads: 5
*  Environment: development
*          PID: 5305
* Listening on http://127.0.0.1:3000
Use Ctrl-C to stop

</code></pre>
<p>ブラウザで<code>http://localhost:3000</code>にアクセスしてみましょう。</p>
<p><img src="day-0/./rails/how-to-setup3.png" alt="img" /></p>
<p>ブラウザで<code>http://localhost:3000/admin</code>にアクセスしてみましょう。</p>
<p><img src="day-0/./rails/how-to-setup4.png" alt="img" /></p>
<p>以下の画面が表示されれば環境構築は完了です。</p>
<h4 id="railsが起動しない場合"><a class="header" href="#railsが起動しない場合">Railsが起動しない場合</a></h4>
<p>以下のような表示が出た場合は、すでにRailsが起動しているので、一度停止してから再度実行してください。</p>
<pre><code class="language-console">bin/rails s
=&gt; Booting Puma
=&gt; Rails 7.0.3 application starting in development 
=&gt; Run `bin/rails server --help` for more startup options
A server is already running. Check /workspace/tmp/pids/server.pid.
Exiting
</code></pre>
<h4 id="pumaのプロセスを確認する"><a class="header" href="#pumaのプロセスを確認する">pumaのプロセスを確認する</a></h4>
<pre><code class="language-bash">ps aux | grep puma
</code></pre>
<p>例えば以下の場合、<code>800</code>がpumaのプロセスIDです。プロセスIDを指定してkillコマンドを実行すると、pumaを停止することができます。</p>
<pre><code class="language-console">root       800  0.2  1.8 1028168 149416 pts/1  Sl+  12:17   0:02 puma 5.6.4 (tcp://localhost:3000) [workspace]
root      4351  0.0  0.0   4796   640 pts/2    S+   12:32   0:00 grep puma
</code></pre>
<p>以下のコマンドを実行して、pumaを停止します。</p>
<pre><code class="language-bash">kill -9 800
</code></pre>
<p>プロセスがkillされていることを確認します。</p>
<pre><code class="language-bash">ps aux | grep puma
root      4509  0.0  0.0   4796   632 pts/2    S+   12:32   0:00 grep puma
</code></pre>
<p>再度、<code>bin/rails s</code>を実行して、Railsを起動します。</p>
<p>これでRuby, Railsの環境構築は終了です。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ruby-on-railsを用いたweb開発の全体像"><a class="header" href="#ruby-on-railsを用いたweb開発の全体像">Ruby on Railsを用いたWeb開発の全体像</a></h1>
<!-- - [Webサーバとアプリケーションサーバの理解](day-0/web-and-application-server.md)
- [MVC+MR(ミドルウェア、ルーティング)基礎](day-0/mvc-architecture-and-routing.md)
- [フォルダ/ファイルの関係性](day-0/folders-and-files.md)
- [データベース管理とマイグレーション](day-0/databse-management-and-migration.md) -->
<h2 id="web開発で理解したい大枠の知識"><a class="header" href="#web開発で理解したい大枠の知識">Web開発で理解したい大枠の知識</a></h2>
<p>以下に記載する知識は、Ruby on Railsに限らず、Python、PHP、Java、JavaScriptなどの言語を用いたWeb開発においても必要な知識です。複雑な知識が多いため、理解するのに時間がかかると思いますが、理解することで、Web開発の全体像が見えてきます。</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">用語</th><th style="text-align: left">名称</th><th style="text-align: left">説明</th></tr></thead><tbody>
<tr><td style="text-align: left"><code>DNS</code></td><td style="text-align: left"><code>Domain Name System</code></td><td style="text-align: left"><code>ドメイン名とIPアドレスの対応付けや、 メールの宛先ホストを指示するためのシステム</code></td></tr>
<tr><td style="text-align: left"><code>IP address</code>, <code>IPアドレス</code></td><td style="text-align: left"><code>Internet Protocol Address</code></td><td style="text-align: left"><code>通信相手を識別するための番号</code></td></tr>
<tr><td style="text-align: left"><code>Server</code>, <code>サーバ</code></td><td style="text-align: left"><code>サーバ</code></td><td style="text-align: left"><code>クライアントからのリクエストに応じて、データや処理結果などを提供する機能を果たす側のシステムやソフトウェア</code></td></tr>
<tr><td style="text-align: left"><code>HTTP</code></td><td style="text-align: left"><code>Hypertext Transfer Protocol</code></td><td style="text-align: left"><code>通信プロトコル</code></td></tr>
<tr><td style="text-align: left"><code>Database</code>, <code>DB</code></td><td style="text-align: left"><code>Database</code></td><td style="text-align: left"><code>電子的に保存され、アクセスできる組織化されたデータの集合。RDB、NoSQLなどの種類がある</code></td></tr>
<tr><td style="text-align: left"><code>Scale up</code>, <code>Vertical scaling</code></td><td style="text-align: left"><code>スケールアップ</code></td><td style="text-align: left"><code>サーバそのもののパフォーマンスを向上させることでシステムの処理機能を高める</code></td></tr>
<tr><td style="text-align: left"><code>Scale out</code>, <code>Horizontal scaling</code></td><td style="text-align: left"><code>スケールアウト</code></td><td style="text-align: left"><code>サーバを増やすことでシステムの処理機能を高める</code></td></tr>
<tr><td style="text-align: left"><code>Load balancer</code></td><td style="text-align: left"><code>ロードバランサ</code></td><td style="text-align: left"><code>外部からの通信（トラフィック）を複数のサーバーに分散する仕組みを提供する装置</code></td></tr>
<tr><td style="text-align: left"><code>Database replication</code></td><td style="text-align: left"><code>データベースレプリケーション</code></td><td style="text-align: left"><code>データベースを複製すること。source/replica構成ともいう(master/slaveは廃止)。</code></td></tr>
<tr><td style="text-align: left"><code>Cache</code></td><td style="text-align: left"><code>キャッシュ</code></td><td style="text-align: left"><code>データなどを一時的に保存し、次回に表示する際にこのデータを使いすばやく表示する機能</code></td></tr>
<tr><td style="text-align: left"><code>CDN</code></td><td style="text-align: left"><code>Content delivery network</code></td><td style="text-align: left"><code>インターネットコンテンツを高速配信するために連携する地理的に分散されたサーバーのグループ</code></td></tr>
<tr><td style="text-align: left"><code>Message queue</code></td><td style="text-align: left"><code>メッセージキュー</code></td><td style="text-align: left"><code>システム間で流れるデータ（メッセージ）をためておくキュー</code></td></tr>
<tr><td style="text-align: left"><code>Logging</code>, <code>Metrics</code>, <code>Monitoring</code>, <code>Automation</code></td><td style="text-align: left"><code>ログ</code>, <code>メトリクス</code>, <code>モニタリング</code>, <code>オートメーション</code></td><td style="text-align: left"><code>サービス運用上で必要な機能や指標</code></td></tr>
<tr><td style="text-align: left"><code>Latency</code></td><td style="text-align: left"><code>レイテンシ</code></td><td style="text-align: left"><code>データ転送における指標の一つ。通信の遅延時間のことを指す</code></td></tr>
<tr><td style="text-align: left"><code>WAF</code></td><td style="text-align: left"><code>Web Application Firewall</code></td><td style="text-align: left"><code>Webアプリケーションの脆弱性を悪用した攻撃」からWebサイトを保護するセキュリティ対策</code></td></tr>
<tr><td style="text-align: left"><code>Object Storage</code></td><td style="text-align: left"><code>オブジェクトストレージ</code></td><td style="text-align: left"><code>非構造化データを保存するためのデータ ストレージ アーキテクチャのこと。S3, Cloud Storage, Filestore, R2などの製品がオブジェクトストレージに当たります。</code></td></tr>
<tr><td style="text-align: left"><code>Data centers</code></td><td style="text-align: left"><code>データセンター</code></td><td style="text-align: left"><code>各種のコンピュータ（メインフレーム、ミニコンピュータ、サーバ等）やデータ通信などの装置を設置・運用することに特化した施設の総称</code></td></tr>
</tbody></table>
</div>
<h2 id="web開発でよく見る一般的な構成"><a class="header" href="#web開発でよく見る一般的な構成">web開発でよく見る一般的な構成</a></h2>
<p><img src="day-0/../day-0/rails/web-overview.jpg" alt="img" /></p>
<h2 id="ruby-on-railsを理解するための図解"><a class="header" href="#ruby-on-railsを理解するための図解">Ruby on Railsを理解するための図解</a></h2>
<p><img src="day-0/../day-0/rails/rails-overview.jpg" alt="img" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="本講義プロジェクトmycmsのer図"><a class="header" href="#本講義プロジェクトmycmsのer図">本講義プロジェクトMyCMSのER図</a></h1>
<h2 id="記事関連er図"><a class="header" href="#記事関連er図">記事関連ER図</a></h2>
<pre class="mermaid">erDiagram
  authors ||--o{ articles : &quot;&quot;
  categories ||--o{ articles : &quot;&quot;
  articles ||--o{ article_tags : &quot;&quot;
  tags ||--o{ article_tags : &quot;&quot;
  articles ||--o{ article_series : &quot;&quot;
  series ||--o{ article_series : &quot;&quot;
</pre>
<h2 id="メディア関連er図"><a class="header" href="#メディア関連er図">メディア関連ER図</a></h2>
<pre class="mermaid">erDiagram
  pickups
  banners
</pre>
<h2 id="ニュースレター関連er図"><a class="header" href="#ニュースレター関連er図">ニュースレター関連ER図</a></h2>
<pre class="mermaid">erDiagram
  newsletters ||--o{ delivered_newsletters : &quot;&quot;
  newsletter_subscribers ||--o{ delivered_newsletters : &quot;&quot;
  deleted_newsletter_subscribers
  bounced_emails
</pre>
<h2 id="管理者関連er図"><a class="header" href="#管理者関連er図">管理者関連ER図</a></h2>
<pre class="mermaid">erDiagram
  admins ||--o| admin_database_authentications : &quot;&quot;
  admins ||--o| admin_account_lockings : &quot;&quot;
  admins ||--o| admin_account_trackings : &quot;&quot;
  admins ||--o| admin_password_reset_requests : &quot;&quot;
  admin_registrations
</pre>
<h2 id="ユーザー関連er図"><a class="header" href="#ユーザー関連er図">ユーザー関連ER図</a></h2>
<pre class="mermaid">erDiagram
  users ||--o| user_database_authentications : &quot;&quot;
  users ||--o| user_account_lockings : &quot;&quot;
  users ||--o| user_account_trackings : &quot;&quot;
  users ||--o| user_password_reset_requests : &quot;&quot;
  user_registrations
</pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="記事管理機能⓪実装済みサンプル"><a class="header" href="#記事管理機能⓪実装済みサンプル">記事管理機能⓪：実装済みサンプル</a></h1>
<h2 id="実装済みサンプル"><a class="header" href="#実装済みサンプル">実装済みサンプル</a></h2>
<ul>
<li>
<p>著者管理機能</p>
</li>
<li>
<p>カテゴリ管理機能</p>
</li>
</ul>
<h2 id="著者管理機能"><a class="header" href="#著者管理機能">著者管理機能</a></h2>
<h3 id="できること"><a class="header" href="#できること">できること</a></h3>
<ul>
<li>著者情報を一覧で閲覧することができる</li>
<li>著者詳細情報を閲覧することができる</li>
<li>著者情報を新規登録することができる</li>
<li>著者情報を編集することができる</li>
</ul>
<h3 id="一覧画面"><a class="header" href="#一覧画面">一覧画面</a></h3>
<div class="table-wrapper"><table><thead><tr><th>File</th><th>Path</th></tr></thead><tbody>
<tr><td>Route</td><td><code>config/routes/admin/authors.rb</code></td></tr>
<tr><td>Controller</td><td><code>app/controllers/admin/authors_controller.rb#index</code></td></tr>
<tr><td>View</td><td><code>app/views/admin/authors/index.html.erb</code></td></tr>
<tr><td>Model</td><td><code>app/models/author.rb</code></td></tr>
<tr><td>Url</td><td><code>http://localhost:3000/admin/authors</code></td></tr>
</tbody></table>
</div>
<p><img src="day-0/./rails/cms-sample1.png" alt="img" /></p>
<h3 id="詳細画面"><a class="header" href="#詳細画面">詳細画面</a></h3>
<div class="table-wrapper"><table><thead><tr><th>File</th><th>Path</th></tr></thead><tbody>
<tr><td>Route</td><td><code>config/routes/admin/authors.rb</code></td></tr>
<tr><td>Controller</td><td><code>app/controllers/admin/authors_controller.rb#show</code></td></tr>
<tr><td>View</td><td><code>app/views/admin/authors/show.html.erb</code></td></tr>
<tr><td>Model</td><td><code>app/models/author.rb</code></td></tr>
<tr><td>Url</td><td><code>http://localhost:3000/admin/authors/:id</code></td></tr>
</tbody></table>
</div>
<p><img src="day-0/./rails/cms-sample2.png" alt="img" /></p>
<h3 id="新規登録画面"><a class="header" href="#新規登録画面">新規登録画面</a></h3>
<div class="table-wrapper"><table><thead><tr><th>File</th><th>Path</th></tr></thead><tbody>
<tr><td>Route</td><td><code>config/routes/admin/authors.rb</code></td></tr>
<tr><td>Controller(画面表示用)</td><td><code>app/controllers/admin/authors_controller.rb#new</code></td></tr>
<tr><td>Controller(データ作成用)</td><td><code>app/controllers/admin/authors_controller.rb#create</code></td></tr>
<tr><td>View</td><td><code>app/views/admin/authors/new.html.erb</code></td></tr>
<tr><td>Model</td><td><code>app/models/author.rb</code></td></tr>
<tr><td>Url</td><td><code>http://localhost:3000/admin/authors/new</code></td></tr>
</tbody></table>
</div>
<p><img src="day-0/./rails/cms-sample3.png" alt="img" /></p>
<h3 id="編集画面"><a class="header" href="#編集画面">編集画面</a></h3>
<div class="table-wrapper"><table><thead><tr><th>File</th><th>Path</th></tr></thead><tbody>
<tr><td>Route</td><td><code>config/routes/admin/authors.rb</code></td></tr>
<tr><td>Controller(画面表示用)</td><td><code>app/controllers/admin/authors_controller.rb#edit</code></td></tr>
<tr><td>Controller(データ更新用)</td><td><code>app/controllers/admin/authors_controller.rb#update</code></td></tr>
<tr><td>View</td><td><code>app/views/admin/authors/edit.html.erb</code></td></tr>
<tr><td>Model</td><td><code>app/models/author.rb</code></td></tr>
<tr><td>Url</td><td><code>http://localhost:3000/admin/authors/:id/edit</code></td></tr>
</tbody></table>
</div>
<p><img src="day-0/./rails/cms-sample4.png" alt="img" /></p>
<h3 id="実際のソースコードcontroller"><a class="header" href="#実際のソースコードcontroller">実際のソースコード（Controller）</a></h3>
<p>キーワード</p>
<blockquote>
<p>ActiveRecord, Strong Parameters</p>
</blockquote>
<p>※本プロジェクトでは、Ransack, Pagyというgemを使用しています。</p>
<p>Ransak: 検索機能, Pagy: ページネーション機能</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::AuthorsController &lt; Admin::ApplicationController
  def index
    @q = Author.ransack(params[:q])
    @pagy, @authors = pagy(@q.result(distinct: true))
  end

  def show
    @author = Author.find(params[:id])
  end

  def new
    @author = Author.new
  end

  def create
    @author = Author.new(create_params)
    if @author.save
      flash.now.notice = t(&quot;admin.create.success&quot;)
      redirect_to admin_authors_path
    else
      flash.now.alert = t(&quot;admin.create.failed&quot;)
      render :new, status: :unprocessable_entity
    end
  end

  def edit
    @author = Author.find(params[:id])
  end

  def update
    @author = Author.find(params[:id])
    if @author.update(update_params)
      flash.now.notice = t(&quot;admin.update.success&quot;)
      redirect_to admin_author_path
    else
      flash.now.alert = t(&quot;admin.update.failed&quot;)
      render :edit, status: :unprocessable_entity
    end
  end

  private

  def create_params
    params.require(:author).permit(
      :name,
      :bio
    )
  end

  def update_params
    create_params
  end
end
</code></pre>
<h4 id="activerecord"><a class="header" href="#activerecord">ActiveRecord</a></h4>
<p>ActiveRecordとは、RailsのORM(Object Relational Mapping)のことです。データベースのテーブルと、Rubyのオブジェクトをマッピングすることで、データベースの操作をRubyのコードで行うことができます。</p>
<p>例えば、<code>show</code>アクションのコードを見てみましょう。</p>
<pre><code class="language-ruby">def show
  @author = Author.find(params[:id])

  # `http://localhost:3000/admin/authors/1`というURLにアクセスした場合、
  # `params[:id]`は`1`という値になります。
  # そのため、`Author.find(params[:id])`というコードは、
  # `authors`テーブルから`id`が`1`のレコードを取得するという意味になります。
  # つまり、Author.find(&quot;1&quot;)となります。
end
</code></pre>
<ul>
<li>
<p><code>Author.find(params[:id])</code>というコードがありますが、これは、<code>authors</code>テーブルから<code>id</code>が<code>params[:id]</code>のレコードを取得するという意味です。</p>
</li>
<li>
<p><code>find</code>メソッドは、<code>ActiveRecord::Base</code>クラスのメソッドです。<code>Author</code>モデルは、<code>ActiveRecord::Base</code>クラスを継承しているので、<code>find</code>メソッドを使用することができます。<code>find</code>メソッドは、指定された<code>id</code>のレコードを取得することができます。</p>
</li>
<li>
<p>params[:id]は、URLのパスに含まれる<code>:id</code>という名前のパラメータの値を取得することができます。例えば、<code>http://localhost:3000/admin/authors/1</code>というURLの場合、<code>:id</code>の値は<code>1</code>になります。</p>
</li>
</ul>
<p><strong>save, updateメソッド</strong></p>
<p>saveメソッドは、レコードを保存するメソッドです。<code>create</code>メソッドや<code>update</code>メソッドを実行すると、内部で<code>save</code>メソッドが実行されます。</p>
<pre><code class="language-ruby">def create
  @author = Author.new(create_params)
  # 以下の部分
  if @author.save
    flash.now.notice = t(&quot;admin.create.success&quot;)
    redirect_to admin_authors_path
  else
    flash.now.alert = t(&quot;admin.create.failed&quot;)
    render :new, status: :unprocessable_entity
  end
end
</code></pre>
<p>レコード保存関連のメソッドまとめ</p>
<p>戻り値が重要です。true/falseで判定したい場合は、saveメソッドを使用する。失敗した時に例外を投げたい場合は、ビックリマークが使用されているsave!やupdate!メソッドを使用します。</p>
<div class="table-wrapper"><table><thead><tr><th>メソッド名</th><th>使用例</th><th>戻り値</th><th>備考</th></tr></thead><tbody>
<tr><td>save</td><td><code>user.save</code></td><td>成功時は<code>true</code>、失敗時は<code>false</code></td><td>レコードを保存します。バリデーションに失敗した場合でも例外を投げません。</td></tr>
<tr><td>save!</td><td><code>user.save!</code></td><td>成功時は<code>true</code></td><td>レコードを保存します。バリデーションに失敗すると例外(ActiveRecord::RecordInvalid)を投げます。</td></tr>
<tr><td>create</td><td><code>User.create(name: 'Alice')</code></td><td>新規作成したオブジェクト</td><td>新規レコードを生成し、成功時に保存します。バリデーションに失敗した場合でも例外を投げません。</td></tr>
<tr><td>create!</td><td><code>User.create!(name: 'Alice')</code></td><td>新規作成したオブジェクト</td><td>新規レコードを生成し、保存します。バリデーションに失敗すると例外(ActiveRecord::RecordInvalid)を投げます。</td></tr>
<tr><td>update</td><td><code>user.update(name: 'Bob')</code></td><td>成功時は<code>true</code>、失敗時は<code>false</code></td><td>レコードを更新します。バリデーションに失敗した場合でも例外を投げません。</td></tr>
<tr><td>update!</td><td><code>user.update!(name: 'Bob')</code></td><td>成功時は<code>true</code></td><td>レコードを更新します。バリデーションに失敗すると例外(ActiveRecord::RecordInvalid)を投げます。</td></tr>
</tbody></table>
</div>
<h4 id="strong-parameters"><a class="header" href="#strong-parameters">Strong Parameters</a></h4>
<pre><code class="language-ruby">private

def create_params
  params.require(:author).permit(
    :name,
    :bio
  )
end
</code></pre>
<ul>
<li>
<p>Strong Parametersとは、Railsで提供されている機能で、フォームから送信されたデータを安全に取得することができます。</p>
</li>
<li>
<p><code>Parameters: {&quot;authenticity_token&quot;=&gt;&quot;[FILTERED]&quot;, &quot;author&quot;=&gt;{&quot;name&quot;=&gt;&quot;Yuki Tanaka&quot;, &quot;bio&quot;=&gt;&quot;Yuki Tanaka2&quot;}, &quot;id&quot;=&gt;&quot;326b474f-908b-490d-8d61-9b8d024a677f&quot;}</code>というようなデータがあるとします。このデータは、<code>params</code>というメソッドで取得することができます。</p>
</li>
<li>
<p><code>params</code>メソッドは、<code>ActionController::Parameters</code>クラスのインスタンスを返します。このクラスは、<code>Hash</code>クラスを継承しているので、<code>Hash</code>クラスのメソッドを使用することができます。</p>
</li>
<li>
<p><code>params</code>メソッドで取得したデータは、<code>require</code>メソッドで指定したキーの値を取得することができます。例えば、<code>params.require(:author)</code>とすると、<code>params</code>メソッドで取得したデータの<code>:author</code>というキーの値を取得することができます。</p>
</li>
<li>
<p><code>permit</code>メソッドは、<code>require</code>メソッドで取得したデータのうち、指定したキーの値を取得することができます。例えば、<code>params.require(:author).permit(:name, :bio)</code>とすると、<code>params</code>メソッドで取得したデータの<code>:author</code>というキーの値のうち、<code>:name</code>と<code>:bio</code>というキーの値のみ取得することができます。</p>
</li>
<li>
<p>ブラウザなどから予期しないデータが送信されたとしても、<code>permit</code>メソッドで指定したキーの値のみ取得することができるので、安全にデータを取得することができます。</p>
</li>
</ul>
<h2 id="カテゴリ管理機能"><a class="header" href="#カテゴリ管理機能">カテゴリ管理機能</a></h2>
<p>上記の著者管理機能と同様の機能を持つので省略します。基本的なCRUD機能はほとんど同じです。
削除機能はスキップしているので、興味のある方は実装してみてください。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="記事管理機能①タグ管理"><a class="header" href="#記事管理機能①タグ管理">記事管理機能①：タグ管理</a></h1>
<p>Author, Categoryを参考に、タグ管理機能を実装してみましょう。</p>
<h2 id="要件"><a class="header" href="#要件">要件</a></h2>
<ul>
<li>タグを管理することができる。</li>
<li>タグは、タグ名のデータを持つ。</li>
</ul>
<h2 id="やること"><a class="header" href="#やること">やること</a></h2>
<ul>
<li>マイグレーション</li>
<li>モデル作成</li>
<li>コントローラ作成</li>
<li>ルーティングの設定</li>
<li>ビュー作成
<ul>
<li>一覧画面</li>
<li>詳細画面</li>
<li>新規作成画面</li>
<li>編集画面</li>
</ul>
</li>
</ul>
<p>今回はコマンドラインからの作成をしつつ、手動で作成する方法も紹介します。</p>
<h2 id="マイグレーション"><a class="header" href="#マイグレーション">マイグレーション</a></h2>
<p>タグを管理するためのテーブルを作成するマイグレーションを作成します。</p>
<p>[command]</p>
<pre><code class="language-bash">bin/rails g migration CreateTags
</code></pre>
<p>[code]</p>
<p>タグ名用のカラムを追加したいので、以下のようにマイグレーションファイルを編集します。</p>
<p>Filename: db/migrate/20230708053757_create_tags.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class CreateTags &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :tags, id: :uuid do |t|
      t.string :name, null: false, comment: &quot;タグ名&quot;
      t.timestamps
    end
  end
end
</code></pre>
<p>[command]</p>
<p>以下コマンドを実行すると、データベースにTagテーブルが作成されます。</p>
<pre><code class="language-bash">bin/rails db:migrate
</code></pre>
<p>[output]</p>
<pre><code class="language-console">== 20230708053757 CreateTags: migrating =======================================
-- create_table(:tags, {:id=&gt;:uuid})
   -&gt; 0.0091s
== 20230708053757 CreateTags: migrated (0.0092s) ==============================
</code></pre>
<p>[command]</p>
<p>Tagテーブルの状態を確認するには、以下コマンドを実行します。</p>
<pre><code class="language-bash">bin/rails db:migrate:status
</code></pre>
<p>[output]</p>
<p>Create Tags がupになっていることが確認できます。</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   ...
   up     20230708053757  Create tags
</code></pre>
<h2 id="モデル作成"><a class="header" href="#モデル作成">モデル作成</a></h2>
<p>タグを管理するためのモデルを作成します。</p>
<p>[command]</p>
<pre><code class="language-bash">touch app/models/tag.rb
</code></pre>
<p>[code]</p>
<p>Filename: app/models/tag.rb</p>
<p>以下ファイルにモデルの定義を記述します。</p>
<p>基本的にActiveRecordを継承したクラスを作成します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Tag &lt; ApplicationRecord
end
</code></pre>
<h2 id="コントローラ作成"><a class="header" href="#コントローラ作成">コントローラ作成</a></h2>
<p>タグを管理するためのコントローラを作成します。</p>
<p>[command]</p>
<pre><code class="language-bash">touch app/controllers/admin/tags_controller.rb
</code></pre>
<p>[code]</p>
<p>Filename: app/controllers/admin/tags_controller.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::TagsController &lt; Admin::ApplicationController
end
</code></pre>
<h2 id="ルーティングの設定"><a class="header" href="#ルーティングの設定">ルーティングの設定</a></h2>
<p>画面表示やデータの作成、更新、削除を行うためのルーティングを設定します。</p>
<p>以下のコマンドでTag用のルーティングファイルを作成します。</p>
<p>[command]</p>
<pre><code class="language-bash">touch config/routes/admin/tags.rb
</code></pre>
<p>以下のようにルーティングを設定します。</p>
<p>[code]</p>
<p>Filename: config/routes/admin/tags.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

Rails.application.routes.draw do
  namespace :admin do
    resources :tags
  end
end
</code></pre>
<p>詳しいルーティングの詳細については、<a href="day-0/../appendix/routing.html">ルーティングについて</a>を参照してください。</p>
<h3 id="ルーティングをコマンドで確認する"><a class="header" href="#ルーティングをコマンドで確認する">ルーティングをコマンドで確認する</a></h3>
<p>Railsには、設定したルーティングを確認するコマンドが用意されています。</p>
<p><code>bin/rails routes</code> コマンドを実行すると、設定したルーティングを確認することができます。</p>
<p>[command]</p>
<pre><code class="language-bash">bin/rails routes -g tag
</code></pre>
<p>[output]</p>
<pre><code class="language-console">        Prefix Verb   URI Pattern                    Controller#Action
    admin_tags GET    /admin/tags(.:format)          admin/tags#index
               POST   /admin/tags(.:format)          admin/tags#create
 new_admin_tag GET    /admin/tags/new(.:format)      admin/tags#new
edit_admin_tag GET    /admin/tags/:id/edit(.:format) admin/tags#edit
     admin_tag GET    /admin/tags/:id(.:format)      admin/tags#show
               PATCH  /admin/tags/:id(.:format)      admin/tags#update
               PUT    /admin/tags/:id(.:format)      admin/tags#update
               DELETE /admin/tags/:id(.:format)      admin/tags#destroy
</code></pre>
<p>上記のように表示されていれば、ルーティングの設定は正しく行われています。</p>
<h2 id="ビュー作成"><a class="header" href="#ビュー作成">ビュー作成</a></h2>
<p>画面表示を行うために、ビューを作成します。まずは一覧画面から作成していきます。</p>
<h3 id="一覧画面-1"><a class="header" href="#一覧画面-1">一覧画面</a></h3>
<p>以下のコマンドで、一覧画面用のビューを作成します。</p>
<h4 id="ビューフォルダとファイル作成"><a class="header" href="#ビューフォルダとファイル作成">ビューフォルダとファイル作成</a></h4>
<p>[command]</p>
<pre><code class="language-bash">mkdir -p app/views/admin/tags &amp;&amp; touch app/views/admin/tags/index.html.erb
</code></pre>
<h4 id="コントローラーのアクション作成"><a class="header" href="#コントローラーのアクション作成">コントローラーのアクション作成</a></h4>
<p>[code]</p>
<p>ビューに対応するコントローラーのアクションを作成します。今回は、Tag一覧画面を作成するので、indexアクションを追加します。</p>
<p>Filename: app/controllers/admin/tags_controller.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::TagsController &lt; Admin::ApplicationController
  def index; end
end
</code></pre>
<h4 id="ビューの作成"><a class="header" href="#ビューの作成">ビューの作成</a></h4>
<p>[code]</p>
<p>Filename: app/views/admin/tags/index.html.erb</p>
<pre><code class="language-erb">Tags
</code></pre>
<h4 id="ルーティングの更新"><a class="header" href="#ルーティングの更新">ルーティングの更新</a></h4>
<p>[command]</p>
<p>ルーティングを更新する際は、一度サーバーを停止してから再起動する必要があります。</p>
<p><code>bin/rails s</code>でサーバーを起動している場合は、以下のように<code>Ctrl + C</code>でサーバーを停止してください。</p>
<pre><code class="language-bash">Ctrl + C
</code></pre>
<p>再度サーバーを起動します。</p>
<pre><code class="language-bash">bin/rails s
</code></pre>
<h4 id="ブラウザで確認"><a class="header" href="#ブラウザで確認">ブラウザで確認</a></h4>
<p>[output]</p>
<p>ブラウザで以下のURLにアクセスすると、一覧画面が表示されます。</p>
<p><img src="day-0/./images/cms-tag-1.png" alt="img" /></p>
<h4 id="一覧画面のまとめ"><a class="header" href="#一覧画面のまとめ">一覧画面のまとめ</a></h4>
<ul>
<li>ルーティングを設定する</li>
<li>(モデルを作成する)</li>
<li>コントローラーとコントローラーのアクションを作成する</li>
<li>ビューを作成する</li>
</ul>
<p>基本的に画面を作成する際に必要なことは、ルーティング、モデル、コントローラー、ビューの4つです。</p>
<p>※ モデルは、データベースにデータを保存するためのものなので、画面を作成する際には必ずしも必要ではありません。</p>
<p>次のページから画面にまつわる処理を詳しく見ていきます。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tag一覧画面"><a class="header" href="#tag一覧画面">Tag一覧画面</a></h1>
<h2 id="一覧画面の改善"><a class="header" href="#一覧画面の改善">一覧画面の改善</a></h2>
<p><a href="day-0/./cms-tag.html">記事管理機能①：タグ管理</a>で作成した一覧画面を、より使いやすく改善します。</p>
<p>[command]</p>
<p>以下のコマンドで、一覧画面を改善します。</p>
<ul>
<li><code>app/views/admin/tags/breadcrumb</code>フォルダと<code>_index.html.erb</code>ファイルを作成します。</li>
<li><code>app/views/admin/tags/_index_table.html.erb</code>ファイルを作成します。</li>
</ul>
<pre><code class="language-bash">mkdir -p app/views/admin/tags/breadcrumb &amp;&amp; touch app/views/admin/tags/breadcrumb/_index.html.erb &amp;&amp; touch app/views/admin/tags/_index_table.html.erb
</code></pre>
<h2 id="indexアクションの更新"><a class="header" href="#indexアクションの更新">indexアクションの更新</a></h2>
<p>[code]</p>
<p>先ほど作成したindexアクションを以下のように更新します。Tagモデルを使用して、全てのTagデータを取得します。</p>
<p>モデルの全てのデータを取得したい時は、<code>モデル名.all</code>と記述します。</p>
<p>Filename: app/controllers/admin/tags_controller.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::TagsController &lt; Admin::ApplicationController
  def index
    @tags = Tag.all
  end
end
</code></pre>
<h2 id="パンくずリストの作成"><a class="header" href="#パンくずリストの作成">パンくずリストの作成</a></h2>
<p>[code]</p>
<p>パンくずリストは、画面の上部に表示されるリストです。パンくずリストを作成することで、どの画面にいるのかをユーザーに伝えることができます。</p>
<p><code>admin_tags_path</code>は、<code>/admin/tags</code>のパスを返します。ルーティングの設定を行ったので、ヘルパーメソッドを使用することでパスを取得できます。</p>
<p>Filename: app/views/admin/tags/breadcrumb/_index.html.erb</p>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to admin_tags_path do %&gt;
    &lt;%= t &quot;.title&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<p>もしヘルパーメソッドを使わない書き方をしたい場合は、以下のように記述します。</p>
<h3 id="例1"><a class="header" href="#例1">例1</a></h3>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to &quot;/admin/tags&quot; do %&gt;
    &lt;%= t &quot;.title&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<h3 id="例2"><a class="header" href="#例2">例2</a></h3>
<pre><code class="language-erb">&lt;li&gt;
  &lt;a href=&quot;/admin/tags&quot;&gt;&lt;%= t &quot;.title&quot; %&gt;&lt;/a&gt;
&lt;/li&gt;
</code></pre>
<h2 id="一覧表示のテーブルの作成"><a class="header" href="#一覧表示のテーブルの作成">一覧表示のテーブルの作成</a></h2>
<p>[code]</p>
<p>Filename: app/views/admin/tags/_index_table.html.erb</p>
<pre><code class="language-erb">&lt;div class=&quot;sw-main-body-table table-responsive&quot;&gt;
  &lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;&lt;/th&gt;
        &lt;th&gt;名前&lt;/th&gt;
        &lt;th&gt;作成日&lt;/th&gt;
      &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
      &lt;% @tags.each do |tag| %&gt;
        &lt;tr&gt;
          &lt;td class=&quot;rowlink&quot;&gt;
            &lt;%= link_to admin_tag_path(id: tag&amp;.id) do %&gt;
            &lt;% end %&gt;
          &lt;/td&gt;
          &lt;td style=&quot;min-width: 100px;&quot;&gt;
            &lt;%= tag&amp;.name %&gt;
          &lt;/td&gt;
          &lt;td style=&quot;min-width: 150px;&quot;&gt;
            &lt;%= tag&amp;.created_at %&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
      &lt;% end %&gt;
    &lt;/tbody&gt;
  &lt;/table&gt;
&lt;/div&gt;
</code></pre>
<h3 id="eachメソッド"><a class="header" href="#eachメソッド">eachメソッド</a></h3>
<p><code>each</code>メソッドは、配列やハッシュの要素を順番に取り出すことができます。</p>
<h3 id="演算子"><a class="header" href="#演算子">&amp;.演算子</a></h3>
<p><code>&amp;.演算子</code>は、<code>nil</code>の場合にエラーを発生させないようにするための演算子です。</p>
<h2 id="tagデータの作成"><a class="header" href="#tagデータの作成">Tagデータの作成</a></h2>
<p>一覧画面に、Tagデータを表示したいですが、まだデータが存在しないため、表示することができません。</p>
<p>Railsコンソールを使用して、Tagデータを作成します。</p>
<p>[command]</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>[code]</p>
<p>Railsコンソール内で、以下のコードを実行します。</p>
<pre><code class="language-ruby">Tag.create(name: &quot;Ruby&quot;)
</code></pre>
<p>[output]</p>
<p>Tagモデルを使用して、Tagデータを作成します。</p>
<pre><code class="language-ruby">/workspace# bin/rails c
Loading development environment (Rails 7.0.3)
[1] pry(main)&gt; Tag.create(name: &quot;Ruby&quot;)
  TRANSACTION (0.1ms)  BEGIN
  Tag Create (0.9ms)  INSERT INTO &quot;tags&quot; (&quot;name&quot;, &quot;created_at&quot;, &quot;updated_at&quot;) VALUES ($1, $2, $3) RETURNING &quot;id&quot;  [[&quot;name&quot;, &quot;Ruby&quot;], [&quot;created_at&quot;, &quot;2023-07-08 15:35:31.415910&quot;], [&quot;updated_at&quot;, &quot;2023-07-08 15:35:31.415910&quot;]]
  TRANSACTION (0.9ms)  COMMIT
=&gt; #&lt;Tag:0x0000ffff852366a0
 id: &quot;a764bb18-6a57-49e6-8d4e-58a2d75b0210&quot;,
 name: &quot;Ruby&quot;,
 created_at: Sat, 08 Jul 2023 15:35:31.415910000 JST +09:00,
 updated_at: Sat, 08 Jul 2023 15:35:31.415910000 JST +09:00&gt;
</code></pre>
<p>上記の結果から、<code>id: &quot;a764bb18-6a57-49e6-8d4e-58a2d75b0210&quot;, name: &quot;Ruby&quot;</code>のTagデータが作成されたことがわかります。</p>
<h2 id="一覧画面用のテーブルを表示する"><a class="header" href="#一覧画面用のテーブルを表示する">一覧画面用のテーブルを表示する</a></h2>
<p>[code]</p>
<p>Filename: app/views/admin/tags/index.html.erb</p>
<pre><code class="language-erb">&lt;div class=&quot;l-container&quot;&gt;
  &lt;%= render partial: &quot;layouts/admin/article_menu&quot; %&gt;
  &lt;div class=&quot;l-main-view&quot;&gt;
    &lt;div class=&quot;sw-main-header&quot;&gt;
      &lt;div class=&quot;sw-main-header-title&quot;&gt;
        &lt;%= t &quot;.title&quot; %&gt;
      &lt;/div&gt;
      &lt;div class=&quot;sw-main-header-buttons&quot;&gt;
        &lt;div class=&quot;sw-main-header-button&quot;&gt;
          &lt;%= link_to new_admin_tag_path, class: &quot;btn btn-primary&quot; do %&gt;
            &lt;%= t &quot;buttons.create&quot; %&gt;
          &lt;% end %&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;sw-main-body&quot;&gt;
      &lt;ul class=&quot;breadcrumb p-3&quot;&gt;
        &lt;%= render partial: &quot;admin/tags/breadcrumb/index&quot; %&gt;
      &lt;/ul&gt;
      &lt;%= render partial: &quot;admin/tags/index_table&quot; %&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h2 id="一覧画面の確認"><a class="header" href="#一覧画面の確認">一覧画面の確認</a></h2>
<p>[output]</p>
<p>ブラウザで以下のURLにアクセスすると、以下のような画面が表示されます。</p>
<p><img src="day-0/./images/cms-tag-2.png" alt="img" /></p>
<p>※ 注意点</p>
<ul>
<li>RubyのTagデータが表示されていることを確認してください</li>
<li>Rubyをクリックしても、詳細画面に遷移しないことを確認してください。
<ul>
<li>なぜなら、詳細画面の作成を行っていないため、詳細画面に遷移することができないからです。</li>
</ul>
</li>
</ul>
<p>次に、詳細画面の作成を行います。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tag詳細画面"><a class="header" href="#tag詳細画面">Tag詳細画面</a></h1>
<h2 id="showアクション"><a class="header" href="#showアクション">showアクション</a></h2>
<p>[code]</p>
<p>Tagモデルのidを元に、データを取得します。params[:id]は、ルーティングで設定した:idに対応しています。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::TagsController &lt; Admin::ApplicationController
  # 省略

  def show
    @tag = Tag.find(params[:id])
  end
end
</code></pre>
<p><code>/admin/tags/a764bb18-6a57-49e6-8d4e-58a2d75b0210</code>のようなURLでアクセスされた場合、<code>params[:id]</code>には<code>a764bb18-6a57-49e6-8d4e-58a2d75b0210</code>が入ります。
つまり、<code>Tag.find(&quot;a764bb18-6a57-49e6-8d4e-58a2d75b0210&quot;)</code>と同じ意味になります。</p>
<pre><code class="language-ruby">@tag = Tag.find(params[:id])
# ↓
@tag = Tag.find(&quot;a764bb18-6a57-49e6-8d4e-58a2d75b0210&quot;)
# ↓
# ActiveRecord形式で取得できる
&lt;Tag:0x0000ffff9c9bbe40
 id: &quot;a764bb18-6a57-49e6-8d4e-58a2d75b0210&quot;,
 name: &quot;Ruby&quot;,
 created_at: Sat, 08 Jul 2023 15:35:31.415910000 JST +09:00,
 updated_at: Sat, 08 Jul 2023 15:35:31.415910000 JST +09:00&gt;
</code></pre>
<h2 id="パンくずリストの作成-1"><a class="header" href="#パンくずリストの作成-1">パンくずリストの作成</a></h2>
<p>[command]</p>
<pre><code class="language-bash">touch app/views/admin/tags/breadcrumb/_show.html.erb
</code></pre>
<p>[code]</p>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to admin_tag_path do %&gt;
    &lt;%= t &quot;breadcrumb.show&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<h2 id="詳細画面の作成"><a class="header" href="#詳細画面の作成">詳細画面の作成</a></h2>
<p>[code]</p>
<pre><code class="language-erb">&lt;div class=&quot;l-container&quot;&gt;
  &lt;%= render partial: &quot;layouts/admin/article_menu&quot; %&gt;
  &lt;div class=&quot;l-main-view&quot;&gt;
    &lt;div class=&quot;sw-main-header&quot;&gt;
      &lt;div class=&quot;sw-main-header-title&quot;&gt;
        &lt;%= @tag&amp;.name %&gt;
      &lt;/div&gt;
      &lt;div class=&quot;sw-main-header-buttons&quot;&gt;
        &lt;div class=&quot;sw-main-header-button&quot;&gt;
          &lt;%= link_to edit_admin_tag_path, class: &quot;btn btn-primary&quot; do %&gt;
            &lt;%= t &quot;buttons.edit&quot; %&gt;
          &lt;% end %&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;sw-main-body&quot;&gt;
      &lt;ul class=&quot;breadcrumb p-3&quot;&gt;
        &lt;%= render partial: &quot;admin/tags/breadcrumb/index&quot; %&gt;
        &lt;%= render partial: &quot;admin/tags/breadcrumb/show&quot; %&gt;
      &lt;/ul&gt;
      &lt;div class=&quot;section&quot;&gt;
        &lt;%= render :partial =&gt; &quot;admin/flash&quot; %&gt;
      &lt;/div&gt;
      &lt;div class=&quot;section&quot;&gt;
        &lt;h2 class=&quot;admin-title&quot;&gt;タグ&lt;/h2&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;div class=&quot;card-body&quot;&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-6 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.tag.id&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @tag&amp;.id %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-6 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.tag.name&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @tag&amp;.name %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-6 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;common.created_at&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @tag&amp;.created_at %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;div class=&quot;col-md-6 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;common.updated_at&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @tag&amp;.updated_at %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="詳細画面の確認"><a class="header" href="#詳細画面の確認">詳細画面の確認</a></h3>
<p>[output]</p>
<p><img src="day-0/./images/cms-tag-3.png" alt="img" /></p>
<p>※ 注意点</p>
<ul>
<li>RubyのTagデータが表示されていることを確認してください</li>
<li>編集画面に遷移しないことを確認してください。
<ul>
<li>なぜなら、編集画面の作成を行っていないため、編集画面に遷移することができないからです。</li>
</ul>
</li>
</ul>
<p>次は、Tagの編集画面を作成します。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tag編集画面"><a class="header" href="#tag編集画面">Tag編集画面</a></h1>
<h2 id="編集画面の概要"><a class="header" href="#編集画面の概要">編集画面の概要</a></h2>
<p>編集画面は、2つのアクションで構成されています。</p>
<ul>
<li><code>edit</code>アクション：編集画面を表示するアクション</li>
<li><code>update</code>アクション：編集画面から送信されたデータを受け取り、データを更新するアクション</li>
</ul>
<h3 id="フォーム送信の流れ"><a class="header" href="#フォーム送信の流れ">フォーム送信の流れ</a></h3>
<pre class="mermaid">sequenceDiagram
  autonumber
  participant browser as ブラウザ：HTML/CSS/JS
  participant rails as Rails
  participant db as データベース

  browser-&gt;&gt;rails: フォーム送信
  rails-&gt;&gt;db: データ更新
  db-&gt;&gt;rails: データ更新結果
  rails-&gt;&gt;browser: データ更新結果
</pre>
<h2 id="editアクション"><a class="header" href="#editアクション">editアクション</a></h2>
<h3 id="コントローラーのアクション作成-1"><a class="header" href="#コントローラーのアクション作成-1">コントローラーのアクション作成</a></h3>
<p>[code]</p>
<p><code>edit</code>アクションは、編集画面を表示するアクションです。</p>
<p><code>@tag</code>には、<code>params[:id]</code>で取得したIDを使用して、<code>Tag</code>モデルからデータを取得しています。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::TagsController &lt; Admin::ApplicationController
  # 省略

  def edit
    @tag = Tag.find(params[:id])
  end
end
</code></pre>
<h3 id="パンくずリストの作成-2"><a class="header" href="#パンくずリストの作成-2">パンくずリストの作成</a></h3>
<p>[command]</p>
<pre><code class="language-bash">touch app/views/admin/tags/breadcrumb/_edit.html.erb
</code></pre>
<p>[code]</p>
<p>Filename: app/views/admin/tags/breadcrumb/_edit.html.erb</p>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to edit_admin_tag_path do %&gt;
    &lt;%= t &quot;breadcrumb.edit&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<h3 id="ビューの作成-1"><a class="header" href="#ビューの作成-1">ビューの作成</a></h3>
<p>[command]</p>
<p>以下2つのファイルを作成します。</p>
<ul>
<li>edit.html.erb</li>
<li>_form_attributes.html.erb</li>
</ul>
<pre><code class="language-bash">touch app/views/admin/tags/edit.html.erb &amp;&amp; touch app/views/admin/tags/_form_attributes.html.erb
</code></pre>
<p><code>edit.html.erb</code>は、編集画面のHTMLを記述するファイルです。</p>
<p><code>_form_attributes.html.erb</code>は、フォームのHTMLを記述するファイルです。作成画面でも使用するため、予めコンポーネント化しています。
コンポーネントファイルの特徴は、ファイル名の先頭に<code>_</code>が付くことです。</p>
<p>[code]</p>
<p>Filename: app/views/admin/tags/_form_attributes.html.erb</p>
<pre><code class="language-erb">&lt;%= form_with model: [:admin, @tag], local: true do |f| %&gt;
  &lt;div class=&quot;section&quot;&gt;
    &lt;div class=&quot;d-flex justify-content-between border-bottom pb-3&quot;&gt;
      &lt;div&gt;&lt;/div&gt;
      &lt;div class=&quot;d-flex&quot;&gt;
        &lt;div&gt;
          &lt;button class=&quot;btn btn-primary&quot;&gt;&lt;%= t &quot;buttons.save&quot; %&gt;&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class=&quot;section&quot;&gt;
    &lt;div class=&quot;card border-0&quot;&gt;
      &lt;div class=&quot;card-body&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
          &lt;div class=&quot;col-md-12 mt-3&quot;&gt;
            &lt;%= f.label :name, class: &quot;mb-1 form-label text-small text-muted&quot; do %&gt;
              &lt;%= t &quot;activerecord.attributes.tag.name&quot; %&gt;
            &lt;% end %&gt;
            &lt;%= f.text_field :name, autofocus: true, class: &quot;form-control&quot;, placeholder: &quot;&quot; %&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>
<p>Filename: app/views/admin/tags/edit.html.erb</p>
<pre><code class="language-erb">&lt;div class=&quot;l-container&quot;&gt;
  &lt;%= render partial: &quot;layouts/admin/article_menu&quot; %&gt;
  &lt;div class=&quot;l-main-view&quot;&gt;
    &lt;div class=&quot;sw-main-header&quot;&gt;
      &lt;div class=&quot;sw-main-header-title&quot;&gt;
        &lt;%= @tag&amp;.name %&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;sw-main-body&quot;&gt;
      &lt;ul class=&quot;breadcrumb p-3&quot;&gt;
        &lt;%= render :partial =&gt; &quot;admin/tags/breadcrumb/index&quot; %&gt;
        &lt;%= render :partial =&gt; &quot;admin/tags/breadcrumb/show&quot; %&gt;
        &lt;%= render :partial =&gt; &quot;admin/tags/breadcrumb/edit&quot; %&gt;
      &lt;/ul&gt;
      &lt;div class=&quot;section&quot;&gt;
        &lt;%= render :partial =&gt; &quot;admin/flash&quot; %&gt;
      &lt;/div&gt;
      &lt;%= render :partial =&gt; &quot;admin/tags/form_attributes&quot; %&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="編集画面の確認"><a class="header" href="#編集画面の確認">編集画面の確認</a></h3>
<p>[output]</p>
<p><img src="day-0/./images/cms-tag-4.png" alt="img" /></p>
<p>編集画面が表示されました。次に、<code>update</code>アクションを作成します。</p>
<h2 id="updateアクション"><a class="header" href="#updateアクション">updateアクション</a></h2>
<h3 id="コントローラーのアクション作成-2"><a class="header" href="#コントローラーのアクション作成-2">コントローラーのアクション作成</a></h3>
<p>[code]</p>
<p><code>update</code>アクションは、編集画面から送信されたデータを受け取り、データを更新するアクションです。</p>
<p><code>@tag</code>には、<code>params[:id]</code>で取得したIDを使用して、<code>Tag</code>モデルからデータを取得しています。</p>
<p>Filename: app/controllers/admin/tags_controller.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::TagsController &lt; Admin::ApplicationController
  # 省略

  def edit
    @tag = Tag.find(params[:id])
  end

  def update
    @tag = Tag.find(params[:id])
    if @tag.update(update_params)
      flash.now.notice = t(&quot;admin.update.success&quot;)
      redirect_to admin_tag_path
    else
      flash.now.alert = t(&quot;admin.update.failed&quot;)
      render :edit, status: :unprocessable_entity
    end
  end

  private

  def create_params
    params.require(:tag).permit(
      :name
    )
  end

  def update_params
    create_params
  end
end
</code></pre>
<h3 id="動作確認"><a class="header" href="#動作確認">動作確認</a></h3>
<p><code>Ruby</code>という文字列を、<code>Ruby2</code>に変更して「保存」ボタンを押下します。</p>
<p>[output]</p>
<p>以下のように、<code>Ruby2</code>に変更されていることが確認できます。</p>
<p><img src="day-0/./images/cms-tag-5.png" alt="img" /></p>
<h3 id="updateアクションの深掘り"><a class="header" href="#updateアクションの深掘り">Updateアクションの深掘り</a></h3>
<h4 id="strong-parameters-1"><a class="header" href="#strong-parameters-1">Strong Parameters</a></h4>
<blockquote>
<p><a href="day-0/../appendix/controller.html#strong-parameters.html">Strong Parameters</a>については、別途解説しています</p>
</blockquote>
<p>Strong Parametersとは、Railsで提供されている機能で、フォームから送信されたデータを安全に取得することができる機能です。</p>
<p>[code]</p>
<p>Updateアクションでは、<code>update_params</code>メソッドを使用して、フォームから送信されたデータを取得しています。</p>
<p>Filename: app/controllers/admin/tags_controller.rb</p>
<pre><code class="language-ruby"># 省略

def create_params
  params.require(:tag).permit(
    :name
  )
end

def update_params
  create_params
end
</code></pre>
<p>[log]</p>
<p><code>bin/rails</code>コマンドを実行しているターミナルに、以下のようなログが出力されます。開発中はログを見ながら開発することが多いので、ぜひログを確認する習慣をつけてみてください。
ログを見る習慣は障害対応の際にも役立ちます。</p>
<pre><code class="language-bash">Started PATCH &quot;/admin/tags/a764bb18-6a57-49e6-8d4e-58a2d75b0210&quot; for 127.0.0.1 at 2023-07-08 17:42:24 +0900
Processing by Admin::TagsController#update as TURBO_STREAM
  Parameters: {&quot;authenticity_token&quot;=&gt;&quot;[FILTERED]&quot;, &quot;tag&quot;=&gt;{&quot;name&quot;=&gt;&quot;Ruby2&quot;}, &quot;id&quot;=&gt;&quot;a764bb18-6a57-49e6-8d4e-58a2d75b0210&quot;}
</code></pre>
<p><code>params</code>の中身は、Railsのログから確認することができます。以下の<code>parameters</code>が、<code>params</code>に当たります。</p>
<pre><code class="language-console">Parameters: {&quot;authenticity_token&quot;=&gt;&quot;[FILTERED]&quot;, &quot;tag&quot;=&gt;{&quot;name&quot;=&gt;&quot;Ruby2&quot;}, &quot;id&quot;=&gt;&quot;a764bb18-6a57-49e6-8d4e-58a2d75b0210&quot;}
</code></pre>
<p><code>create_params</code>メソッドでは、<code>params</code>の中の<code>tag</code>を取得して、name属性のみ許可(permit)しています。</p>
<h4 id="updateメソッド"><a class="header" href="#updateメソッド">updateメソッド</a></h4>
<blockquote>
<p><a href="day-0/./appendix/active-record.html">Updateメソッド</a>については、こちらで補足しています。</p>
</blockquote>
<p>[code]</p>
<p>Updateアクションは、該当するTagのデータを取得しデータの更新行う際に、以下のような処理を行っています。</p>
<ul>
<li>データの更新が成功したら、<code>flash.now.notice</code>に成功メッセージを設定し、<code>admin_tag_path</code>にリダイレクトする</li>
<li>データの更新が失敗したら、<code>flash.now.alert</code>に失敗メッセージを設定し、<code>edit</code>アクションをレンダリングする</li>
</ul>
<p>Filename: app/controllers/admin/tags_controller.rb</p>
<pre><code class="language-ruby"># 省略

def update
  @tag = Tag.find(params[:id])
  if @tag.update(update_params)
    flash.now.notice = t(&quot;admin.update.success&quot;)
    redirect_to admin_tag_path
  else
    flash.now.alert = t(&quot;admin.update.failed&quot;)
    render :edit, status: :unprocessable_entity
  end
end
</code></pre>
<p>最終的に<code>@tag.update(update_params)</code>は、以下のように更新されます。</p>
<pre><code class="language-ruby">@tag.update({name: &quot;Ruby2&quot;})
</code></pre>
<p>最後に、新規作成画面の作成を行います。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tag作成画面"><a class="header" href="#tag作成画面">Tag作成画面</a></h1>
<h2 id="作成画面の概要"><a class="header" href="#作成画面の概要">作成画面の概要</a></h2>
<p>作成画面は、2つのアクションで構成されています。</p>
<ul>
<li><code>new</code>アクション：作成画面を表示するアクション</li>
<li><code>create</code>アクション：作成画面から送信されたデータを受け取り、データを更新するアクション</li>
</ul>
<h3 id="フォーム送信の流れ-1"><a class="header" href="#フォーム送信の流れ-1">フォーム送信の流れ</a></h3>
<pre class="mermaid">sequenceDiagram
  autonumber
  participant browser as ブラウザ：HTML/CSS/JS
  participant rails as Rails
  participant db as データベース

  browser-&gt;&gt;rails: フォーム送信
  rails-&gt;&gt;db: データ作成
  db-&gt;&gt;rails: データ作成結果
  rails-&gt;&gt;browser: データ作成結果
</pre>
<h2 id="newアクション"><a class="header" href="#newアクション">newアクション</a></h2>
<h3 id="コントローラーのアクション作成-3"><a class="header" href="#コントローラーのアクション作成-3">コントローラーのアクション作成</a></h3>
<p>[code]</p>
<p><code>new</code>アクションは、作成画面を表示するアクションです。</p>
<p><code>Tag.new</code>で、<code>Tag</code>モデルのインスタンスを作成しています。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::TagsController &lt; Admin::ApplicationController
  # 省略

  def new
    @tag = Tag.new
  end
end
</code></pre>
<h3 id="パンくずリストの作成-3"><a class="header" href="#パンくずリストの作成-3">パンくずリストの作成</a></h3>
<p>[command]</p>
<pre><code class="language-bash">touch app/views/admin/tags/breadcrumb/_new.html.erb
</code></pre>
<p>[code]</p>
<p>Filename: app/views/admin/tags/breadcrumb/_new.html.erb</p>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to new_admin_tag_path do %&gt;
    &lt;%= t &quot;breadcrumb.new&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<h3 id="ビューの作成-2"><a class="header" href="#ビューの作成-2">ビューの作成</a></h3>
<p>[command]</p>
<pre><code class="language-bash">touch app/views/admin/tags/new.html.erb
</code></pre>
<p>[code]</p>
<p>編集画面と同様のレイアウトを使用します。</p>
<p>Filename: app/views/admin/tags/new.html.erb</p>
<pre><code class="language-erb">&lt;div class=&quot;l-container&quot;&gt;
  &lt;%= render partial: &quot;layouts/admin/article_menu&quot; %&gt;
  &lt;div class=&quot;l-main-view&quot;&gt;
    &lt;div class=&quot;sw-main-header&quot;&gt;
      &lt;div class=&quot;sw-main-header-title&quot;&gt;
        &lt;%= t &quot;.title&quot; %&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;sw-main-body&quot;&gt;
      &lt;ul class=&quot;breadcrumb p-3&quot;&gt;
        &lt;%= render partial: &quot;admin/tags/breadcrumb/index&quot; %&gt;
        &lt;%= render partial: &quot;admin/tags/breadcrumb/new&quot; %&gt;
      &lt;/ul&gt;
      &lt;div class=&quot;section&quot;&gt;
        &lt;%= render :partial =&gt; &quot;admin/flash&quot; %&gt;
      &lt;/div&gt;
      &lt;%= render :partial =&gt; &quot;admin/tags/form_attributes&quot; %&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="作成画面の確認"><a class="header" href="#作成画面の確認">作成画面の確認</a></h3>
<p><img src="day-0/./images/cms-tag-6.png" alt="タグ作成画面" /></p>
<p>作成画面が表示されました。次に、<code>create</code>アクションを作成します。</p>
<h2 id="createアクション"><a class="header" href="#createアクション">createアクション</a></h2>
<h3 id="コントローラーのアクション作成-4"><a class="header" href="#コントローラーのアクション作成-4">コントローラーのアクション作成</a></h3>
<p>[code]</p>
<p>Tagモデルのインスタンスを作成し、<code>save</code>メソッドでデータを保存します。</p>
<p>Filename: app/controllers/admin/tags_controller.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::TagsController &lt; Admin::ApplicationController
  # 省略

  def create
    @tag = Tag.new(create_params)
    if @tag.save
      flash.now.notice = t(&quot;admin.create.success&quot;)
      redirect_to admin_tags_path
    else
      flash.now.alert = t(&quot;admin.create.failed&quot;)
      render :new, status: :unprocessable_entity
    end
  end

  private

  # 編集画面で作成したStrong Parametersを使用する
  def create_params
    params.require(:tag).permit(
      :name
    )
  end
end
</code></pre>
<p>基本的には、<code>update</code>アクションと同様の処理です。</p>
<p>Createアクションは、Tagモデルのインスタンスを作成し、<code>save</code>メソッドでデータを保存します。</p>
<ul>
<li>データの更新が成功したら、<code>flash.now.notice</code>に成功メッセージを設定し、<code>admin_tags_path</code>にリダイレクトする</li>
<li>データの更新が失敗したら、<code>flash.now.alert</code>に失敗メッセージを設定し、<code>new</code>アクションをレンダリングする</li>
</ul>
<p><code>Ruby on Rails</code>という文字列を入力して、保存ボタンを押下します。以下のようにTag一覧画面に<code>Ruby on Rails</code>が追加されたら成功です。</p>
<p><img src="day-0/./images/cms-tag-7.png" alt="タグ作成" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day1-講義用ページ"><a class="header" href="#day1-講義用ページ">Day1 講義用ページ</a></h1>
<h2 id="このページの目的"><a class="header" href="#このページの目的">このページの目的</a></h2>
<p>「【G's EXPANSION】 爆速で身に着けるRuby on Rails：自分だけのCMSを開発しよう！」のDay1の講義用ページです。</p>
<h2 id="今日の講義の目的"><a class="header" href="#今日の講義の目的">今日の講義の目的</a></h2>
<ul>
<li>答えをお伝えするのではなく、答えを見つけるための武器をお伝えする</li>
<li>Railsの基礎を学ぶ</li>
<li>MVCとルーティングについて理解する</li>
<li>エラーが出た時の対処法を学ぶ</li>
</ul>
<h2 id="day1講義の流れ"><a class="header" href="#day1講義の流れ">Day1講義の流れ</a></h2>
<ul>
<li>自己紹介</li>
<li>ハンズオンの準備</li>
<li>ハンズオン</li>
<li>質問会</li>
</ul>
<h2 id="自己紹介"><a class="header" href="#自己紹介">自己紹介</a></h2>
<p><img src="day-1/./images/gs-profile.png" alt="img" /></p>
<p>&quot;<a href="https://gsacademy.jp/mentor-lecturer">G's ACADEMY HP</a>から引用&quot;</p>
<h3 id="キッズウィークエンド"><a class="header" href="#キッズウィークエンド">キッズウィークエンド</a></h3>
<p>「社会を丸ごと教科書に」学びが好きになる探究型オンライン教育のキッズウィークエンドです。子育てとキャリアのトレードオフを解消し誰もが挑戦できる社会を目指して事業展開しています。</p>
<ul>
<li>2020年4月スタート（サービス開始3年）</li>
<li>子育て世帯の狭いターゲットで、会員登録者は4万5千人超</li>
<li>累計500万PV超のwebサービスを開発</li>
<li>18万人以上の親子が参加</li>
<li>Ruby on Railsで開発</li>
<li>テスト版を含めて4年くらい同じサービスを開発してます</li>
<li>フロントエンド/サーバーサイド/インフラ/デザイン/データ分析/PM/CSなどやってます</li>
<li>テーブル数は200ほど(小規模サービス)</li>
</ul>
<h4 id="個人"><a class="header" href="#個人">個人</a></h4>
<ul>
<li>Ruby/Rust/TypeScrpt/Next.js/Python/Goなどが好きです</li>
<li>10ヶ月の息子がいます</li>
<li>オーマイライク株式会社の代表をやっていて、たまに案件を受けたりサービスを作ったりしてます</li>
</ul>
<h2 id="day1のハンズオン準備"><a class="header" href="#day1のハンズオン準備">Day1のハンズオン準備</a></h2>
<p><a href="day-1/./handson.html">Day1のハンズオン準備</a>を使用します。</p>
<h2 id="質問会"><a class="header" href="#質問会">質問会</a></h2>
<p>Ruby, Railsに関する質問を受け付けます。</p>
<h2 id="day2に向けたハンズオン"><a class="header" href="#day2に向けたハンズオン">Day2に向けたハンズオン</a></h2>
<p><a href="day-1/./handson.html">Day1のハンズオン準備</a>を使用します。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day1-ハンズオン"><a class="header" href="#day1-ハンズオン">Day1 ハンズオン</a></h1>
<p>Day1のハンズオンページです。</p>
<h2 id="目次"><a class="header" href="#目次">目次</a></h2>
<ul>
<li>ハンズオンの準備</li>
<li>ハンズオンの前に
<ul>
<li>Web開発の全体像</li>
<li>MVCとルーティングについて</li>
<li>データベースについて</li>
</ul>
</li>
<li>ハンズオン
<ul>
<li>Day0の振り返り</li>
<li>Day1で使用するソースコードの共有</li>
<li>User側の記事詳細画面を実装する</li>
</ul>
</li>
<li>Day2に向けて
<ul>
<li>Rails開発でよく使うファイル場所やコマンド</li>
<li>課題について</li>
</ul>
</li>
</ul>
<h2 id="ハンズオンの準備"><a class="header" href="#ハンズオンの準備">ハンズオンの準備</a></h2>
<h3 id="git-pull"><a class="header" href="#git-pull">git pull</a></h3>
<p>Day1は、<code>lesson-day-1</code>ブランチを使用します。お使いの環境にソースコードを取り込んでください。</p>
<p>[command]</p>
<p>作業中の場合は、一旦コミットするか、stashしてからpullしてください。</p>
<pre><code class="language-console">git pull origin lesson-day-1
</code></pre>
<h3 id="git-commitが必要な場合"><a class="header" href="#git-commitが必要な場合">git commitが必要な場合</a></h3>
<p>[command]</p>
<pre><code class="language-console">git add -p
git commit -m &quot;commit message&quot;
</code></pre>
<h3 id="git-stashが必要な場合"><a class="header" href="#git-stashが必要な場合">git stashが必要な場合</a></h3>
<p>[command]</p>
<pre><code class="language-consoe">git stash
</code></pre>
<p>※ VSCode Remote Containerに接続前提で進みます。</p>
<h3 id="データベースの再作成"><a class="header" href="#データベースの再作成">データベースの再作成</a></h3>
<p>[command]</p>
<p>db/migrate以下のファイルを追加しましたので、データベースを再作成してください。</p>
<pre><code class="language-console">bin/rails db:reset
</code></pre>
<p><code>bin/rails db:reset</code>は、以下のコマンドをまとめて実行しています。</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">コマンド</th><th style="text-align: left">内容</th></tr></thead><tbody>
<tr><td style="text-align: left">bin/rails db:drop</td><td style="text-align: left">データベースのドロップ</td></tr>
<tr><td style="text-align: left">bin/rails db:create</td><td style="text-align: left">データベースの作成</td></tr>
<tr><td style="text-align: left">bin/rails db:schema:load</td><td style="text-align: left">スキーマのロード</td></tr>
<tr><td style="text-align: left">bin/rails db:seed</td><td style="text-align: left">シードデータのロード。db/seeds.rbに記述されたコードが実行され、データベースに初期データが投入される</td></tr>
</tbody></table>
</div>
<h3 id="動作確認-1"><a class="header" href="#動作確認-1">動作確認</a></h3>
<p>[command]</p>
<p>ターミナルで以下のコマンドを実行し、Railsサーバーを起動してください。</p>
<pre><code class="language-console">bin/rails s
</code></pre>
<p>もう一つターミナルを開き、以下のコマンドを実行してください。</p>
<pre><code class="language-console">sh entrypoint.local.sh
</code></pre>
<p>[output]</p>
<p>ブラウザで以下のURLにアクセスしてください。</p>
<p><a href="http://localhost:3000/admin">http://localhost:3000/admin</a></p>
<h2 id="ハンズオンの前に"><a class="header" href="#ハンズオンの前に">ハンズオンの前に</a></h2>
<h3 id="web開発の全体像"><a class="header" href="#web開発の全体像">Web開発の全体像</a></h3>
<p><a href="day-1/../day-0/web-development-overview.html">Ruby on Railsを用いたWeb開発の全体像</a>のページを参照ください。</p>
<h3 id="mvcとルーティングについて"><a class="header" href="#mvcとルーティングについて">MVCとルーティングについて</a></h3>
<ul>
<li><a href="day-1/../appendix/mvc-r.html">MVCとルーティング</a></li>
<li><a href="day-1/../appendix/routing.html">ルーティングについて</a></li>
</ul>
<h3 id="データベースについて"><a class="header" href="#データベースについて">データベースについて</a></h3>
<ul>
<li><a href="day-1/../appendix/database-design.html">データベース構造と設計</a></li>
<li><a href="day-1/../day-0/goal.html">MyCMSのER図</a></li>
</ul>
<h2 id="ハンズオン"><a class="header" href="#ハンズオン">ハンズオン</a></h2>
<h3 id="day0の振り返り"><a class="header" href="#day0の振り返り">Day0の振り返り</a></h3>
<p><a href="day-1/../day-0/cms-tag.html">タグ管理</a>のページを使用する</p>
<h3 id="day1で使用するソースコードの共有"><a class="header" href="#day1で使用するソースコードの共有">Day1で使用するソースコードの共有</a></h3>
<p>lesson-day-1ブランチの内容は、以下の通りです。</p>
<h4 id="admin側"><a class="header" href="#admin側">Admin側</a></h4>
<ul>
<li>記事管理機能
<ul>
<li>記事一覧ページ</li>
<li>記事詳細ページ</li>
<li>記事作成ページ</li>
<li>記事編集ページ</li>
</ul>
</li>
<li>著者管理機能
<ul>
<li>著者一覧ページ</li>
<li>著者詳細ページ</li>
<li>著者作成ページ</li>
<li>著者編集ページ</li>
</ul>
</li>
<li>連載管理機能
<ul>
<li>連載一覧ページ</li>
<li>連載詳細ページ</li>
<li>連載作成ページ</li>
<li>連載編集ページ</li>
</ul>
</li>
<li>カテゴリ管理機能
<ul>
<li>カテゴリ一覧ページ</li>
<li>カテゴリ詳細ページ</li>
<li>カテゴリ作成ページ</li>
<li>カテゴリ編集ページ</li>
</ul>
</li>
<li>タグ管理機能
<ul>
<li>タグ一覧ページ</li>
<li>タグ詳細ページ</li>
<li>タグ作成ページ</li>
<li>タグ編集ページ</li>
</ul>
</li>
<li>イチオシ管理機能
<ul>
<li>イチオシ一覧ページ</li>
<li>イチオシ詳細ページ</li>
<li>イチオシ作成ページ</li>
<li>イチオシ編集ページ</li>
</ul>
</li>
<li>バナー管理機能
<ul>
<li>バナー一覧ページ</li>
<li>バナー詳細ページ</li>
<li>バナー作成ページ</li>
<li>バナー編集ページ</li>
</ul>
</li>
</ul>
<h4 id="user側"><a class="header" href="#user側">User側</a></h4>
<ul>
<li>トップページ</li>
<li>カテゴリ詳細ページ</li>
<li>連載一覧ページ</li>
<li>連載詳細ページ</li>
</ul>
<h3 id="user側の記事詳細画面を実装する"><a class="header" href="#user側の記事詳細画面を実装する">User側の記事詳細画面を実装する</a></h3>
<p>まずは、User側の記事詳細に使用するコントローラーを実装します。</p>
<p>[command]</p>
<pre><code class="language-bash">touch app/controllers/user/articles_controller.rb
</code></pre>
<p>[code]</p>
<p>Filename: app/controllers/user/articles_controller.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class User::ArticlesController &lt; User::ApplicationController
  def show
    @article = Article.preload(:author).find(params[:id])

    render &quot;/user/error_404&quot; and return unless @article.present?
  end
end
</code></pre>
<p>次に、User側の記事詳細に使用するビューを実装します。</p>
<p>[command]</p>
<pre><code class="language-bash">mkdir -p app/views/user/articles &amp;&amp; touch app/views/user/articles/show.html.erb
</code></pre>
<p>[code]</p>
<p>Filename: app/views/user/articles/show.html.erb</p>
<pre><code class="language-erb">&lt;main id=&quot;kiji-main&quot;&gt;
  &lt;div class=&quot;container max-width-980&quot;&gt;
    &lt;div class=&quot;article-main&quot;&gt;
      &lt;h1&gt;&lt;%= @article&amp;.title %&gt;&lt;/h1&gt;
      &lt;div class=&quot;article-main-author&quot;&gt;
        &lt;div class=&quot;article-main-author-img flex-center&quot;&gt;
          &lt;div class=&quot;flex-center&quot;&gt;
            &lt;%= @article&amp;.author&amp;.name[0] %&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;article-main-author-box&quot;&gt;
          &lt;div class=&quot;article-main-author-box-name&quot;&gt;
            &lt;%= @article&amp;.author&amp;.name %&gt;
          &lt;/div&gt;
          &lt;div class=&quot;article-main-author-box-note&quot;&gt;
            &lt;time datetime=&quot;&lt;%= @article&amp;.published_at %&gt;&quot;&gt;
              &lt;%= l(@article&amp;.published_at, format: :article_show) if @article&amp;.published_at.present? %&gt;
            &lt;/time&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;article-main-thumbnail&quot;&gt;
      &lt;/div&gt;
      &lt;div class=&quot;article-main-content mt-3&quot;&gt;
        &lt;%= @article&amp;.content %&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;footer-breadcrumb&quot;&gt;
      &lt;ul class=&quot;breadcrumb&quot;&gt;
        &lt;li&gt;
          &lt;%= link_to user_top_path do %&gt;
            &lt;%= t &quot;.breadcrumb.top&quot; %&gt;
          &lt;% end %&gt;
        &lt;/li&gt;
        &lt;li&gt;
          &lt;%= link_to article_path(id: @article[:id]) do %&gt;
            &lt;%= @article&amp;.title %&gt;
          &lt;% end %&gt;
        &lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/main&gt;
</code></pre>
<h3 id="管理画面から記事を作成する"><a class="header" href="#管理画面から記事を作成する">管理画面から記事を作成する</a></h3>
<p>管理画面に移動して記事を作成してみます。</p>
<h2 id="day2に向けて"><a class="header" href="#day2に向けて">Day2に向けて</a></h2>
<h3 id="rails開発でよく使うファイル場所やコマンド"><a class="header" href="#rails開発でよく使うファイル場所やコマンド">Rails開発でよく使うファイル場所やコマンド</a></h3>
<h3 id="gemfile"><a class="header" href="#gemfile">Gemfile</a></h3>
<p>Gemとは、Rubyで使えるライブラリのことです。Railsでは、GemfileにGemを記述することで、Gemを使用することができます。</p>
<p>RailsはGemのエコシステムが充実しているため、Gemを使用することで、簡単に機能を追加することができると言われています。</p>
<p>Filename: Gemfile</p>
<h4 id="よく使うコマンド集"><a class="header" href="#よく使うコマンド集">よく使うコマンド集</a></h4>
<ul>
<li><a href="day-1/../appendix/rails-dev-command.html">Rails開発でよく使うコマンド</a></li>
</ul>
<h4 id="cssを変更したい場合"><a class="header" href="#cssを変更したい場合">CSSを変更したい場合</a></h4>
<p>※今回CSSにふれませんが、以下にCSSのファイルが置かれています。</p>
<p>Directory: app/assets/stylesheets</p>
<h4 id="javascriptを変更したい場合"><a class="header" href="#javascriptを変更したい場合">JavaScriptを変更したい場合</a></h4>
<p>※今回JavaScriptに触れませんが、以下にJavaScriptのファイルが置かれています。</p>
<p>Directory: app/javascript</p>
<h4 id="bindingpry"><a class="header" href="#bindingpry">binding.pry</a></h4>
<p>デバックする際に役に立つ機能を紹介します。画面にアクセスした時に、どんな値が入っているかを確認したい場合など使用します。</p>
<p>[code]</p>
<p><code>Admin::TagsController#index</code>に<code>binding.pry</code>を追加します。</p>
<p>Filename: app/controllers/admin/tags_controller.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::TagsController &lt; Admin::ApplicationController
  def index
    @tags = Tag.all
    binding.pry
  end
end
</code></pre>
<p>[output]</p>
<p>画面にアクセスすると、Railsサーバーのコンソールを見ると、<code>binding.pry</code>を追加した箇所で処理が止まっています。</p>
<pre><code class="language-bash">From: /workspace/app/controllers/admin/tags_controller.rb:6 Admin::TagsController#index:

    4: def index
    5:   @tags = Tag.all
 =&gt; 6:   binding.pry
    7: end
</code></pre>
<p>[command]</p>
<p>以下を実行すると、<code>@tags</code>に入っている値を確認することができます。</p>
<pre><code class="language-bash">@tags
</code></pre>
<p>[output]</p>
<pre><code class="language-bash">[1] pry(#&lt;Admin::TagsController&gt;)&gt; @tags
=&gt;   Tag Load (2.7ms)  SELECT &quot;tags&quot;.* FROM &quot;tags&quot;
  ↳ app/controllers/admin/tags_controller.rb:6:in `index'
[#&lt;Tag:0x0000ffff7b0f0d40
  id: &quot;0fdd7c38-8f11-4965-b872-6ac55e437012&quot;,
  name: &quot;ポエム&quot;,
  created_at: Sun, 09 Jul 2023 01:24:47.937235000 JST +09:00,
  updated_at: Sun, 09 Jul 2023 01:24:47.937235000 JST +09:00&gt;,
 #&lt;Tag:0x0000ffff7b0f0c50
  id: &quot;0e431892-e797-4649-a596-be21b21374ce&quot;,
  name: &quot;非認知能力&quot;,
  created_at: Sun, 09 Jul 2023 01:24:47.942586000 JST +09:00,
  updated_at: Sun, 09 Jul 2023 01:24:47.942586000 JST +09:00&gt;]
[2] pry(#&lt;Admin::TagsController&gt;)&gt; 
</code></pre>
<h4 id="binrails-c"><a class="header" href="#binrails-c">bin/rails c</a></h4>
<p>実際にRailsコンソールを起動しながら、コードを実行してみます。</p>
<h4 id="binrails-routes"><a class="header" href="#binrails-routes">bin/rails routes</a></h4>
<p>実際にルーティングを確認しましょう。</p>
<h3 id="課題"><a class="header" href="#課題">課題</a></h3>
<p>実際に自分で手を動かしてみるのが一番身につきますので、以下の課題をやってみましょう。</p>
<ul>
<li>
<p>サンプルで用意したソースコードの復習</p>
<ul>
<li>不具合があれば皆さんに共有お願いします！そして修正してみてください！</li>
</ul>
</li>
<li>
<p>Day3に向けて実装したい機能を考えてみましょう。余裕があれば実装してください！</p>
<ul>
<li>フロントエンドの実装でも良いですし、</li>
<li>サーバーサイドの実装でも良いです</li>
<li>実装の方針が分からなければ、ぜひ聞いてください！</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day2に向けた課題"><a class="header" href="#day2に向けた課題">Day2に向けた課題</a></h1>
<p>実際に自分で手を動かしてみるのが一番身につきますので、以下の課題をやってみましょう。</p>
<ul>
<li>
<p>サンプルで用意したソースコードの復習</p>
<ul>
<li>不具合があれば皆さんに共有お願いします！そして修正してみてください！</li>
</ul>
</li>
<li>
<p>Day3に向けて実装したい機能を考えてみましょう。余裕があれば実装してください！</p>
<ul>
<li>フロントエンドの実装でも良いですし、</li>
<li>サーバーサイドの実装でも良いです</li>
<li>実装の方針が分からなければ、ぜひ聞いてください！</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day1-qa"><a class="header" href="#day1-qa">Day1 QA</a></h1>
<h2 id="q-デプロイサービス"><a class="header" href="#q-デプロイサービス">Q. デプロイサービス</a></h2>
<h3 id="a-簡単なのはheroku-render-flyioあたりかと思います"><a class="header" href="#a-簡単なのはheroku-render-flyioあたりかと思います">A. 簡単なのは、Heroku, render, Fly.ioあたりかと思います。</a></h3>
<ul>
<li><a href="https://mc.lolipop.jp/">LOLIPOP!マネージドクラウド</a></li>
<li><a href="https://jp.heroku.com/">Heroku</a></li>
<li><a href="https://render.com/">render</a></li>
<li><a href="https://fly.io/">Fly.io</a></li>
<li><a href="https://www.linode.com/ja/">Linode</a></li>
<li><a href="https://aws.amazon.com/jp/">AWS</a></li>
<li><a href="https://cloud.google.com/?hl=ja">GCP</a></li>
<li><a href="https://azure.microsoft.com/ja-jp">Azure</a></li>
</ul>
<h2 id="q-apiモード"><a class="header" href="#q-apiモード">Q. APIモード</a></h2>
<h3 id="a-rails6から追加されたモードですrailsの機能をapiとして提供することができます"><a class="header" href="#a-rails6から追加されたモードですrailsの機能をapiとして提供することができます">A. Rails6から追加されたモードです。Railsの機能をAPIとして提供することができます。</a></h3>
<ol>
<li><code>config/application.rb</code>に以下を追加すると、APIモードになります。</li>
</ol>
<pre><code class="language-ruby">config.api_only = true
</code></pre>
<ol start="2">
<li><code>app/controllers/application_controller.rb</code>を以下のように変更します。</li>
</ol>
<pre><code class="language-ruby">class ApplicationController &lt; ActionController::API
end
</code></pre>
<ol start="3">
<li>例えば、こんな感じです</li>
</ol>
<pre><code class="language-ruby">def index
  users = User.all
  render json: { data: users }
end
</code></pre>
<p>※ ActiveRecordは基本的には、すべてのデータを返してしまうので、Serializerを使って、必要なデータだけを返すようにすると良いかと思います。</p>
<h2 id="q-sqlがたくさん発生するケースは"><a class="header" href="#q-sqlがたくさん発生するケースは">Q. SQLがたくさん発生するケースは？</a></h2>
<h3 id="a-集計系や検索系"><a class="header" href="#a-集計系や検索系">A. 集計系や検索系</a></h3>
<p>お金やデータ集計などでSQLが大量に発生するケースがあります。その場合は、</p>
<ul>
<li>ActiveRecordで書く</li>
<li>直接SQLを書く
<ul>
<li><code>ActiveRecord::Base.connection.execute</code>などを使用します。</li>
</ul>
</li>
</ul>
<p>具体的には、会社ごとやユーザーごとに毎月の売上を集計するようなケースです。</p>
<h2 id="蛇足"><a class="header" href="#蛇足">蛇足</a></h2>
<p>ActiveRecordは、データベースと連携するためのライブラリです。データベースの操作を抽象化して、Rubyのコードでデータベースを操作できるようにしています。最終的には、SQLを発行してデータベースを操作しています。</p>
<p>流れとしては、</p>
<pre class="mermaid">graph TD;
  A[Ruby];
  B[ActiveRecord];
  C[SQL];
  D[Database]

  A--&gt;B
  B--&gt;C;
  C--&gt;D;
</pre>
<p>大量にデータを扱う際は、</p>
<ul>
<li>直接SQLを書く
<ul>
<li>そのまま配列などで扱う</li>
<li>※SQLからActiveRecordに戻すとコストがかかるので遅くなる</li>
</ul>
</li>
<li>DB設計を工夫する
<ul>
<li>マテリアライズドビューやビューを活用する</li>
<li>集計用のテーブルを作成する</li>
<li>データを分割する</li>
</ul>
</li>
<li>Redisなどのキャッシュを活用する</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day2-講義用ページ"><a class="header" href="#day2-講義用ページ">Day2 講義用ページ</a></h1>
<h2 id="このページの目的-1"><a class="header" href="#このページの目的-1">このページの目的</a></h2>
<p>「【G's EXPANSION】 爆速で身に着けるRuby on Rails：自分だけのCMSを開発しよう！」のDay2の講義用ページです。</p>
<h3 id="今日の講義の目的-1"><a class="header" href="#今日の講義の目的-1">今日の講義の目的</a></h3>
<ul>
<li>Railsの実践的な使い方を学ぶ
<ul>
<li>認証について</li>
<li>決済について</li>
</ul>
</li>
<li>実装してみたい機能を決める</li>
</ul>
<h3 id="day2講義の流れ"><a class="header" href="#day2講義の流れ">Day2講義の流れ</a></h3>
<ul>
<li>Day1の振り返り
<ul>
<li>Rails振り返り</li>
<li>皆さんの進捗シェアなど</li>
</ul>
</li>
<li>ハンズオン
<ul>
<li>認証機能の実装</li>
<li>決済機能の実装</li>
</ul>
</li>
<li>質問</li>
</ul>
<h2 id="day1の振り返り"><a class="header" href="#day1の振り返り">Day1の振り返り</a></h2>
<ul>
<li>Railsの振り返り
<ul>
<li><a href="day-2/./day-1-qa.html">Day1 QA</a></li>
</ul>
</li>
</ul>
<h2 id="ハンズオン-1"><a class="header" href="#ハンズオン-1">ハンズオン</a></h2>
<p>本日分は、以下のブランチに上げています。</p>
<p><a href="https://github.com/matakitanakajp09/gs-expansion-rails-sample/tree/lesson-day-2">https://github.com/matakitanakajp09/gs-expansion-rails-sample/tree/lesson-day-2</a></p>
<h3 id="認証機能の実装"><a class="header" href="#認証機能の実装">認証機能の実装</a></h3>
<ul>
<li><a href="day-2/./handson-auth-registration.html">認証機能: 新規登録</a></li>
<li><a href="day-2/./handson-auth-session.html">認証機能: ログイン</a></li>
</ul>
<h3 id="決済機能の実装"><a class="header" href="#決済機能の実装">決済機能の実装</a></h3>
<ul>
<li><a href="day-2/./handson-payment.html">決済機能: Stripeを使った基本的な使い方</a></li>
</ul>
<h2 id="質問会など"><a class="header" href="#質問会など">質問会など</a></h2>
<p>ご質問があれば、お答えします！</p>
<h2 id="day3に向けた課題"><a class="header" href="#day3に向けた課題">Day3に向けた課題</a></h2>
<ul>
<li>
<p>Railsを使って、自分が実装してみたい機能を作ってみましょう！</p>
</li>
<li>
<p>最終日は、皆さんの実装した機能を発表していただきます！</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day2-ハンズオン"><a class="header" href="#day2-ハンズオン">Day2 ハンズオン</a></h1>
<p>Day2のハンズオンページです。</p>
<h3 id="目次-1"><a class="header" href="#目次-1">目次</a></h3>
<ul>
<li>認証機能の実装</li>
<li>決済機能の実装</li>
</ul>
<h2 id="認証機能の実装-1"><a class="header" href="#認証機能の実装-1">認証機能の実装</a></h2>
<ul>
<li><a href="day-2/./handson-auth-registration.html">認証機能: 新規登録</a></li>
<li><a href="day-2/./handson-auth-session.html">認証機能: ログイン</a></li>
<li><a href="day-2/./handson-payment.html">決済機能: Stripe基本</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="認証機能-新規登録"><a class="header" href="#認証機能-新規登録">認証機能: 新規登録</a></h1>
<p>管理者アカウントの新規登録機能を実装します。</p>
<blockquote>
<p><a href="https://github.com/heartcombo/devise/blob/main/app/controllers/devise/registrations_controller.rb">Devise RegistrationsController</a></p>
</blockquote>
<h2 id="新規登録の流れ"><a class="header" href="#新規登録の流れ">新規登録の流れ</a></h2>
<ol>
<li>管理者アカウントの新規登録画面でメールアドレスを入力して送信</li>
<li>メールアドレスが登録済みかどうかを確認し、メールアドレスを認証するためのリンクが添付されたメールを送信</li>
<li>認証リンクをクリックし、管理者アカウント情報を入力して登録完了</li>
<li>ログインする</li>
</ol>
<h2 id="ルーティングの設定-1"><a class="header" href="#ルーティングの設定-1">ルーティングの設定</a></h2>
<p>[code]</p>
<p><code>config/routes/admin/devise.rb</code>に以下のルーティングを追加します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

Rails.application.routes.draw do
  # 省略

  # 以下パスに変更
  devise_scope :admin_registration do
    post &quot;admin/registration/finish&quot;, to: &quot;admin/registrations#finish&quot;, as: &quot;finish_admin_registration&quot;
  end
end
</code></pre>
<p>[command]</p>
<p><code>bin/rails routes -g admin/registration/finish</code>を実行して、ルーティングが追加されていることを確認します。</p>
<pre><code class="language-bash">bin/rails routes -g admin/registration/finish
</code></pre>
<p>[output]</p>
<pre><code class="language-bash">/workspace# bin/rails routes -g admin/registration/finish
                   Prefix Verb URI Pattern                          Controller#Action
finish_admin_registration POST /admin/registration/finish(.:format) admin/registrations#finish
</code></pre>
<p>ルーティングが追加されていることを確認することができました。</p>
<h2 id="コントローラーの作成"><a class="header" href="#コントローラーの作成">コントローラーの作成</a></h2>
<p>[command]</p>
<pre><code class="language-bash">touch app/controllers/admin/registrations_controller.rb
</code></pre>
<p>[code]</p>
<p><code>app/controllers/admin/registrations_controller.rb</code>を以下のように編集します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::RegistrationsController &lt; Devise::ConfirmationsController
  layout &quot;admin/auth&quot;

  # GET /resource/confirmation/new
  def new
    super
  end

  # POST /resource/confirmation
  def create
    registered = Admin::DatabaseAuthentication.where(email: params[:registration][:email]).exists?
    if registered
      flash[:error] = &quot;Given email address is already registered.&quot;
      return render :new
    end
    admin_registration = Admin::Registration.find_or_initialize_by(unconfirmed_email: params[:registration][:email])
    if admin_registration.save
      Admin::DeviseMailer.confirmation_instructions(admin_registration).deliver_now
      flash[:notice] = &quot;Sending an email confirmation instruction&quot;
      redirect_to new_admin_database_authentication_session_path and return
    else
      respond_with(admin_registration)
    end
  end

  # GET /resource/confirmation?confirmation_token=abcdef
  def show
    @admin = Admin.new
    @admin_database_authentication = Admin::DatabaseAuthentication.new
  end

  def finish
    admin_registration = Admin::Registration.confirm_by_token(params[:confirmation_token])
    ActiveRecord::Base.transaction do
      @admin = Admin.new(full_name: params[:full_name])
      @admin_database_authentication = Admin::DatabaseAuthentication.new(
        admin: @admin,
        email: admin_registration&amp;.unconfirmed_email,
        password: params[:password],
        password_confirmation: params[:password_confirmation]
      )
      @admin.save!
      @admin_database_authentication.save!
      admin_registration.destroy!
    end

    sign_in(:admin, @admin)
    sign_in(:database_authentication, @admin_database_authentication)

    redirect_to new_admin_database_authentication_session_path
  rescue StandardError
    render :show
  end
end
</code></pre>
<h2 id="ビューの作成-3"><a class="header" href="#ビューの作成-3">ビューの作成</a></h2>
<p>[command]</p>
<pre><code class="language-bash">mkdir -p app/views/admin/registrations &amp;&amp; touch app/views/admin/registrations/new.html.erb &amp;&amp; touch app/views/admin/registrations/show.html.erb
</code></pre>
<p>[code]</p>
<p><code>app/views/admin/registrations/new.html.erb</code>を以下のように編集します。</p>
<pre><code class="language-erb">&lt;main&gt;
  &lt;div class=&quot;&quot;&gt;
    &lt;div class=&quot;row&quot;&gt;
      &lt;div class=&quot;col&quot;&gt;
        &lt;div class=&quot;py-5 d-flex justify-content-center align-items-center&quot;&gt;
          MyCMSの新規登録画面
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;col&quot;&gt;
        &lt;div class=&quot;py-5 d-flex justify-content-center align-items-center&quot;&gt;
          &lt;div class=&quot;w-75 mx-3&quot;&gt;
            &lt;h1 class=&quot;text-center fw-bold&quot;&gt;ログイン&lt;/h1&gt;
            &lt;div class=&quot;w-100 mx-auto mt-5&quot;&gt;
              &lt;%= form_for(resource, as: resource_name, url: admin_registration_confirmation_path) do |f| %&gt;
                &lt;div class=&quot;mt-4&quot;&gt;
                  &lt;label for=&quot;email&quot; class=&quot;mb-1 form-label text-small text-muted&quot;&gt;メールアドレス&lt;/label&gt;
                  &lt;input type=&quot;email&quot; class=&quot;form-control&quot; id=&quot;email&quot; placeholder=&quot;name@example.com&quot; name=&quot;registration[email]&quot;&gt;
                &lt;/div&gt;
                &lt;div class=&quot;mt-4&quot;&gt;
                  &lt;button class=&quot;btn btn-dark w-100&quot;&gt;
                    メールアドレスで新規登録
                  &lt;/button&gt;
                &lt;/div&gt;
              &lt;% end %&gt;
              &lt;ul class=&quot;mt-4 d-flex&quot;&gt;
                &lt;li class=&quot;me-2 text-muted&quot;&gt;
                  &lt;a href=&quot;/terms&quot;&gt;利用規約&lt;/a&gt;
                &lt;/li&gt;
                &lt;li class=&quot;me-2 text-muted&quot;&gt;
                  &lt;a href=&quot;/privacy&quot;&gt;プライバシーポリシー&lt;/a&gt;
                &lt;/li&gt;
              &lt;/ul&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/main&gt;
</code></pre>
<p>[output]</p>
<p>以下にアクセスして、以下のような画面が表示されることを確認します。</p>
<p><a href="http://localhost:3000/admin/confirmation/new">http://localhost:3000/admin/confirmation/new</a></p>
<p><img src="day-2/./images/cms-day2-1.png" alt="img" /></p>
<hr />
<p>[code]</p>
<p><code>app/views/admin/registrations/show.html.erb</code>を以下のように編集します。</p>
<pre><code class="language-erb">&lt;main&gt;
  &lt;div class=&quot;&quot;&gt;
    &lt;div class=&quot;row&quot;&gt;
      &lt;div class=&quot;col&quot;&gt;
        &lt;div class=&quot;py-5 d-flex justify-content-center align-items-center&quot;&gt;
          MyCMSの新規登録画面
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;col&quot;&gt;
        &lt;div class=&quot;py-5 d-flex justify-content-center align-items-center&quot;&gt;
          &lt;div class=&quot;w-75 mx-3&quot;&gt;
            &lt;h1 class=&quot;text-center fw-bold&quot;&gt;管理者として登録する&lt;/h1&gt;
            &lt;div class=&quot;w-100 mx-auto mt-5&quot;&gt;
              &lt;%= form_tag(finish_admin_registration_path) do |f| %&gt;
                &lt;input type=&quot;hidden&quot; name=&quot;confirmation_token&quot; value=&quot;&lt;%= params[:confirmation_token] %&gt;&quot;&gt;
                &lt;div class=&quot;mt-4&quot;&gt;
                  &lt;label for=&quot;full_name&quot; class=&quot;mb-1 form-label text-small text-muted&quot;&gt;名前&lt;/label&gt;
                  &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;full_name&quot; placeholder=&quot;タナカユウキ&quot; name=&quot;full_name&quot;&gt;
                &lt;/div&gt;
                &lt;div class=&quot;mt-4&quot;&gt;
                  &lt;label for=&quot;password&quot; class=&quot;mb-1 form-label text-small text-muted&quot;&gt;パスワード&lt;/label&gt;
                  &lt;input type=&quot;password&quot; class=&quot;form-control&quot; id=&quot;password&quot; name=&quot;password&quot;&gt;
                &lt;/div&gt;
                &lt;div class=&quot;mt-4&quot;&gt;
                  &lt;label for=&quot;password_confirmation&quot; class=&quot;mb-1 form-label text-small text-muted&quot;&gt;パスワード確認&lt;/label&gt;
                  &lt;input type=&quot;password&quot; class=&quot;form-control&quot; id=&quot;password_confirmation&quot; name=&quot;password_confirmation&quot;&gt;
                &lt;/div&gt;
                &lt;div class=&quot;mt-4&quot;&gt;
                  &lt;button class=&quot;btn btn-dark w-100&quot;&gt;
                    管理者として登録する
                  &lt;/button&gt;
                &lt;/div&gt;
              &lt;% end %&gt;
              &lt;ul class=&quot;mt-4 d-flex&quot;&gt;
                &lt;li class=&quot;me-2 text-muted&quot;&gt;
                  &lt;a href=&quot;/terms&quot;&gt;利用規約&lt;/a&gt;
                &lt;/li&gt;
                &lt;li class=&quot;me-2 text-muted&quot;&gt;
                  &lt;a href=&quot;/privacy&quot;&gt;プライバシーポリシー&lt;/a&gt;
                &lt;/li&gt;
              &lt;/ul&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/main&gt;
</code></pre>
<p>[output]</p>
<p>以下にアクセスして、以下のような画面が表示されることを確認します。</p>
<p><a href="http://localhost:3000/admin/confirmation">http://localhost:3000/admin/confirmation</a></p>
<p><img src="day-2/./images/cms-day2-4.png" alt="img" /></p>
<h2 id="mailerの作成"><a class="header" href="#mailerの作成">Mailerの作成</a></h2>
<p>Railsでのメール送信には、<code>ActionMailer</code>を使います。<code>ActionMailer</code>は、メールの送信に必要なメソッドを提供します。</p>
<p>[command]</p>
<pre><code class="language-bash">touch app/mailers/admin/devise_mailer.rb
</code></pre>
<p>[code]</p>
<p><code>app/mailers/admin/devise_mailer.rb</code>を以下のように編集します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::DeviseMailer &lt; Admin::ApplicationMailer
  default from: &quot;from@example.com&quot;
  layout &quot;mailer&quot;

  def confirmation_instructions(resource)
    subject = &quot;会員登録のご案内&quot;
    template_path = &quot;admin/mailer/devise&quot;
    template_name = &quot;confirmation_instructions&quot;
    @token = resource&amp;.confirmation_token
    @email = resource&amp;.unconfirmed_email

    mail(
      to: @email,
      subject: subject,
      template_path: template_path,
      template_name: template_name
    )
  end
end
</code></pre>
<p><code>config/initilizers/devise.rb</code>に以下を追加します。</p>
<pre><code class="language-ruby">config.mailer = 'Admin::DeviseMailer'
</code></pre>
<h4 id="メールのテンプレートの作成"><a class="header" href="#メールのテンプレートの作成">メールのテンプレートの作成</a></h4>
<p>[command]</p>
<pre><code class="language-bash">mkdir -p app/views/admin/mailer/devise &amp;&amp; touch app/views/admin/mailer/devise/confirmation_instructions.html.erb
</code></pre>
<p>[code]</p>
<p><code>app/views/admin/mailer/devise/confirmation_instructions.html.erb</code>を以下のように編集します。</p>
<pre><code class="language-erb">&lt;p&gt;Welcome &lt;%= @email %&gt;!&lt;/p&gt;

&lt;p&gt;You can confirm your account email through the link below:&lt;/p&gt;

&lt;p&gt;&lt;%= link_to 'Confirm my account', admin_registration_confirmation_url(confirmation_token: @token) %&gt;&lt;/p&gt;

</code></pre>
<h4 id="letter-opener-webの設定"><a class="header" href="#letter-opener-webの設定">Letter Opener Webの設定</a></h4>
<p>Letter Opener Webを使って、メールの送信内容を確認できるようにします。</p>
<p>[code]</p>
<p><code>Gemfile</code>を以下のように編集します。</p>
<pre><code class="language-ruby">gem &quot;letter_opener_web&quot;, &quot;~&gt; 2.0&quot;
</code></pre>
<p>[command]</p>
<pre><code class="language-bash">bundle install
</code></pre>
<p>[code]</p>
<p><code>config/routes.rb</code>を以下のように編集します。</p>
<pre><code class="language-ruby">mount LetterOpenerWeb::Engine, at: &quot;/letter_opener&quot; if Rails.env.development? || Rails.env.staging?
</code></pre>
<p>[code]</p>
<p><code>config/environments/development.rb</code>に以下を追加します。</p>
<pre><code class="language-ruby">config.action_mailer.default_url_options = { host: &quot;localhost:3000&quot; }
config.action_mailer.delivery_method = :letter_opener_web
</code></pre>
<p>サーバーを再起動して、以下にアクセスして、以下のような画面が表示されることを確認します。</p>
<p><a href="http://localhost:3000/letter_opener">http://localhost:3000/letter_opener</a></p>
<p><img src="day-2/./images/cms-day2-2.png" alt="img" /></p>
<h2 id="管理者アカウント新規登録"><a class="header" href="#管理者アカウント新規登録">管理者アカウント新規登録</a></h2>
<p>[try]</p>
<p>以下の画面から、メールアドレスを入力して管理者アカウントの新規登録を行います。
<code>info@mycms.com</code>を入力してみます。</p>
<p><a href="http://localhost:3000/admin/confirmation/new">http://localhost:3000/admin/confirmation/new</a></p>
<p>メールアドレスを入力して送信すると、Letter Opener Webの画面で以下のようなメールが表示されます。</p>
<p><a href="http://localhost:3000/letter_opener/">http://localhost:3000/letter_opener/</a></p>
<p><img src="day-2/./images/cms-day2-3.png" alt="img" /></p>
<hr />
<p>メールのリンクをクリックすると、以下のような画面が表示されます。</p>
<p><code>app/controllers/admin/registrations_controller.rb</code>で定義した<code>show</code>アクションが呼び出されています。</p>
<p><img src="day-2/./images/cms-day2-4.png" alt="img" /></p>
<p>名前、パスワード、パスワード確認を入力して送信して、管理者アカウントの新規登録は完了です。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="認証機能-ログイン"><a class="header" href="#認証機能-ログイン">認証機能: ログイン</a></h1>
<p>管理者アカウントのログイン機能を実装します。</p>
<blockquote>
<p><a href="https://github.com/heartcombo/devise/blob/main/app/controllers/devise/sessions_controller.rb">Devise: SessionsController</a></p>
</blockquote>
<h2 id="新規登録の流れ-1"><a class="header" href="#新規登録の流れ-1">新規登録の流れ</a></h2>
<ol>
<li>管理者アカウントのログイン画面でメールアドレスとパスワードを入力して送信</li>
<li>メールアドレスとパスワードが正しいかどうかを確認し、ログインする</li>
</ol>
<h2 id="ルーティングの設定-2"><a class="header" href="#ルーティングの設定-2">ルーティングの設定</a></h2>
<p>すでに設定済みなので、特に設定する必要はありません。</p>
<h2 id="コントローラーの作成-1"><a class="header" href="#コントローラーの作成-1">コントローラーの作成</a></h2>
<p><code>app/controllers/admin/database_authentication/sessions_controller.rb</code>の<code>new</code>と<code>destroy</code>メソッドのコメントアウトを外します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::DatabaseAuthentication::SessionsController &lt; Devise::SessionsController
  # 省略

  def new
    super
  end

  def destroy
    super
  end
end
</code></pre>
<h2 id="ビューの作成-4"><a class="header" href="#ビューの作成-4">ビューの作成</a></h2>
<p>[code]</p>
<p><code>app/views/admin/database_authentication/sessions/new.html.erb</code>を作成します。</p>
<pre><code class="language-ruby">&lt;main&gt;
  &lt;div class=&quot;&quot;&gt;
    &lt;%= render :partial =&gt; &quot;admin/flash&quot; %&gt;
    &lt;div class=&quot;row&quot;&gt;
      &lt;div class=&quot;col&quot;&gt;
        &lt;div class=&quot;py-5 d-flex justify-content-center align-items-center&quot;&gt;
          MyCMSのログイン画面
          &lt;%= admin_signed_in? %&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;col&quot;&gt;
        &lt;div class=&quot;py-5 d-flex justify-content-center align-items-center&quot;&gt;
          &lt;div class=&quot;w-75 mx-3&quot;&gt;
            &lt;h1 class=&quot;text-center fw-bold&quot;&gt;ログイン&lt;/h1&gt;
            &lt;div class=&quot;w-100 mx-auto mt-5&quot;&gt;
              &lt;%= form_for(resource, as: resource_name, url: admin_database_authentication_session_path) do |f| %&gt;
                &lt;div class=&quot;mt-4&quot;&gt;
                  &lt;%= f.label :email, class: &quot;mb-1 form-label text-small text-muted&quot; do %&gt;
                    メールアドレス
                  &lt;% end %&gt;
                  &lt;%= f.email_field :email, autofocus: true, autocomplete: &quot;email&quot;, class: &quot;form-control&quot;, placeholder: &quot;info@mycms.com&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;mt-4&quot;&gt;
                  &lt;%= f.label :password, class: &quot;mb-1 form-label text-small text-muted&quot; do %&gt;
                    パスワード
                  &lt;% end %&gt;
                  &lt;%= f.password_field :password, autocomplete: &quot;current-password&quot;, class: &quot;form-control&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;mt-4&quot;&gt;
                  &lt;%= f.submit &quot;メールアドレスでログイン&quot;, class: &quot;btn btn-dark w-100&quot; %&gt;
                &lt;/div&gt;
              &lt;% end %&gt;
              &lt;ul class=&quot;mt-4 d-flex&quot;&gt;
                &lt;li class=&quot;me-2 text-muted&quot;&gt;
                  &lt;a href=&quot;/terms&quot;&gt;利用規約&lt;/a&gt;
                &lt;/li&gt;
                &lt;li class=&quot;me-2 text-muted&quot;&gt;
                  &lt;a href=&quot;/privacy&quot;&gt;プライバシーポリシー&lt;/a&gt;
                &lt;/li&gt;
              &lt;/ul&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/main&gt;
</code></pre>
<p>[output]</p>
<p>以下にアクセスして、以下のような画面が表示されることを確認します。</p>
<p><a href="http://localhost:3000/admin/sign_in">http://localhost:3000/admin/sign_in</a></p>
<p><img src="day-2/./images/cms-day2-5.png" alt="img" /></p>
<h2 id="管理者アカウントのログイン"><a class="header" href="#管理者アカウントのログイン">管理者アカウントのログイン</a></h2>
<p>email: info@mycms.com</p>
<p>password: password</p>
<p>ログイン後、以下のダッシュボード画面にリダイレクトすると、ログインが成功しています。</p>
<p><a href="http://localhost:3000/admin">http://localhost:3000/admin</a></p>
<h2 id="ログイン状態のみ"><a class="header" href="#ログイン状態のみ">ログイン状態のみ</a></h2>
<h2 id="アカウント設定画面"><a class="header" href="#アカウント設定画面">アカウント設定画面</a></h2>
<h3 id="ルーティング設定"><a class="header" href="#ルーティング設定">ルーティング設定</a></h3>
<p>[command]</p>
<pre><code class="language-bash">touch config/routes/settings.rb
</code></pre>
<pre><code class="language-ruby"># frozen_string_literal: true

Rails.application.routes.draw do
  namespace :admin do
    resources :settings
  end
end
</code></pre>
<h3 id="コントローラーの作成-2"><a class="header" href="#コントローラーの作成-2">コントローラーの作成</a></h3>
<p>[command]</p>
<pre><code class="language-bash">touch app/controllers/admin/settings_controller.rb
</code></pre>
<p>[code]</p>
<p><code>app/controllers/admin/settings_controller.rb</code>を作成します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::SettingsController &lt; Admin::ApplicationController
  def index; end
end
</code></pre>
<h3 id="ビューの作成-5"><a class="header" href="#ビューの作成-5">ビューの作成</a></h3>
<p>[command]</p>
<pre><code class="language-bash">mkdir -p app/views/admin/settings &amp;&amp; mkdir -p app/views/admin/settings/breadcrumb &amp;&amp; touch app/views/admin/settings/breadcrumb/_index.html.erb &amp;&amp; touch app/views/admin/settings/index.html.erb
</code></pre>
<p>[code]</p>
<p><code>app/views/admin/settings/index.html.erb</code>を作成します。</p>
<pre><code class="language-erb">&lt;div class=&quot;l-container&quot;&gt;
  &lt;%= render partial: &quot;layouts/admin/setting_menu&quot; %&gt;
  &lt;div class=&quot;l-main-view&quot;&gt;
    &lt;div class=&quot;sw-main-header&quot;&gt;
      &lt;div class=&quot;sw-main-header-title&quot;&gt;アカウント管理&lt;/div&gt;
      &lt;div class=&quot;sw-main-header-buttons&quot;&gt;
        &lt;div class=&quot;sw-main-header-button&quot;&gt;
          &lt;%= link_to destroy_admin_database_authentication_session_path, class: &quot;btn btn-danger&quot;, data: { turbo_method: :delete }  do %&gt;
            ログアウト
          &lt;% end %&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;sw-main-body&quot;&gt;
      &lt;ul class=&quot;breadcrumb p-3&quot;&gt;
        &lt;%= render partial: &quot;admin/settings/breadcrumb/index&quot; %&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>[code]</p>
<p><code>app/views/admin/settings/breadcrumb/_index.html.erb</code>を作成します。</p>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to admin_settings_path do %&gt;
    &lt;%= t &quot;.title&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<p>[command]</p>
<pre><code class="language-bash">touch app/views/layouts/admin/_setting_menu.html.erb
</code></pre>
<p>[code]</p>
<pre><code class="language-erb">&lt;div class=&quot;l-side&quot;&gt;
  &lt;div class=&quot;sw-main-header&quot;&gt;
    &lt;div class=&quot;sw-main-header-title&quot;&gt;メニュー&lt;/div&gt;
  &lt;/div&gt;
  &lt;div class=&quot;sw-main-body&quot;&gt;
    &lt;div class=&quot;user-links&quot;&gt;
      &lt;div class=&quot;sw-menu&quot;&gt;
        &lt;ul class=&quot;sw-menu-link&quot;&gt;
          &lt;li&gt;
            &lt;%= link_to admin_settings_path do %&gt;
              &lt;span&gt;&lt;%= t &quot;.setting&quot; %&gt;&lt;/span&gt;
            &lt;% end %&gt;
          &lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="翻訳ファイルの追加"><a class="header" href="#翻訳ファイルの追加">翻訳ファイルの追加</a></h3>
<p>[code]</p>
<p><code>config/locales/ja.yml</code>を以下のようにSettings部分を追加します。</p>
<pre><code class="language-yaml">    settings:
      breadcrumb:
        index:
          title: アカウント設定
      index:
        title: アカウント設定
</code></pre>
<p>[code]</p>
<p><code>config/locales/layouts/ja.yml</code>を以下のように追加します。</p>
<pre><code class="language-yaml">      setting_menu:
        setting: アカウント管理
</code></pre>
<h3 id="既存のリンクパスを修正"><a class="header" href="#既存のリンクパスを修正">既存のリンクパスを修正</a></h3>
<p>[code]</p>
<p><code>app/views/layouts/admin/_sidemenu.html.erb</code>を以下のように修正します。</p>
<pre><code class="language-erb">&lt;a class=&quot;function-button&quot; aria-current=&quot;true&quot; data-bs-placement=&quot;right&quot; data-bs-toggle=&quot;tooltip&quot; title=&quot;アカウント/設定&quot; href=&quot;/admin/settings&quot;&gt;
</code></pre>
<h3 id="画面の確認"><a class="header" href="#画面の確認">画面の確認</a></h3>
<p>以下にアクセスして、以下のような画面が表示されることを確認します。</p>
<p><a href="http://localhost:3000/admin/settings">http://localhost:3000/admin/settings</a></p>
<p><img src="day-2/./images/cms-day2-8.png" alt="img" /></p>
<h3 id="ログアウト"><a class="header" href="#ログアウト">ログアウト</a></h3>
<p>右上のログアウトボタンを押下して、ログアウトします。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="決済機能"><a class="header" href="#決済機能">決済機能</a></h1>
<blockquote>
<p><a href="https://stripe.com/docs/api?lang=ruby">Stripe API Reference</a>
<a href="https://stripe.com/docs">Stripe Docs</a></p>
</blockquote>
<h2 id="事前準備"><a class="header" href="#事前準備">事前準備</a></h2>
<p>今回は、Stripeというサービスを使って決済機能を実装します。</p>
<p><a href="https://stripe.com/jp">https://stripe.com/jp</a></p>
<h3 id="stripeアカウントの作成"><a class="header" href="#stripeアカウントの作成">Stripeアカウントの作成</a></h3>
<h4 id="1-stripeで登録する"><a class="header" href="#1-stripeで登録する">1. Stripeで登録する</a></h4>
<p>以下のStripeアカウント登録画面からアカウントを作成します。</p>
<p><a href="https://dashboard.stripe.com/register">https://dashboard.stripe.com/register</a></p>
<p><img src="day-2/./images/cms-day2-6.png" alt="img" /></p>
<p>入力したアカウントにメールが届くので、メール内のリンクをクリックしてアカウントを有効化します。</p>
<p><img src="day-2/./images/cms-day2-7.png" alt="img" /></p>
<h4 id="2-apiキーの取得"><a class="header" href="#2-apiキーの取得">2. APIキーの取得</a></h4>
<p>テストモードに切り替えて、テスト用のAPIキーを取得します。</p>
<p>PublicキーとSecretキーの2種類がありますが、2種類とも使いますので、メモしておいてください。</p>
<p><a href="https://dashboard.stripe.com/test/apikeys">https://dashboard.stripe.com/test/apikeys</a></p>
<h2 id="ライブラリをgemfileに追加する"><a class="header" href="#ライブラリをgemfileに追加する">ライブラリをGemfileに追加する</a></h2>
<p>Gemfileに、Stripeのgemを追加します。</p>
<blockquote>
<p><a href="https://github.com/stripe/stripe-ruby">Github: stripe-ruby</a></p>
</blockquote>
<pre><code class="language-ruby"># =========================================
# ビジネスに関連するもの
# =========================================
gem &quot;stripe&quot;
</code></pre>
<p>[command]</p>
<pre><code class="language-bash">bundle install
</code></pre>
<h2 id="秘匿情報用のファイルを設定"><a class="header" href="#秘匿情報用のファイルを設定">秘匿情報用のファイルを設定</a></h2>
<p>[command]</p>
<pre><code class="language-bash">rm config/master.key
rm config/credentials.yml.enc
</code></pre>
<p>[command]</p>
<p>以下のコマンドを実行すると、新しいファイルが作成されます。</p>
<pre><code class="language-bash">EDITOR=vim bin/rails credentials:edit -e development
</code></pre>
<p>[output]</p>
<pre><code class="language-console">/workspace# EDITOR=vim bin/rails credentials:edit -e development
Adding config/credentials/development.key to store the encryption key: 528a9463b0e8bc0440f7efc12cca7367

Save this in a password manager your team can access.

If you lose the key, no one, including you, can access anything encrypted with it.

      create  config/credentials/development.key

Ignoring config/credentials/development.key so it won't end up in Git history:

      append  .gitignore
</code></pre>
<p>[code]</p>
<p>vimが起動するので、以下のように編集します。</p>
<p>入力が終わったら、<code>:wq</code>で保存して終了します。</p>
<pre><code class="language-console">stripe:
  publishable_key: &quot;&quot;&quot;&lt;Stripeダッシュボードから取得した公開キー&gt;&quot;&quot;&quot;
  secret_key: &quot;&quot;&quot;&lt;Stripeダッシュボードから取得した秘密キー&gt;&quot;&quot;&quot;
</code></pre>
<p>例</p>
<pre><code class="language-console">stripe:
  publishable_key: pk_test_51NUK3XLQ6aqGA5PKRkYPqeJIMwl0zVSMcujZ4buf1RKC1N7UmDaMFocVqhwZ0uL8gjJtbmUatl045M7Bo0yE61No00mtTjAslk
  secret_key: sk_test_51NUK3XLQ6aqGA5PKuCHIo1N1i7vxQIpjxxMpjl3CZ6PW4Vu2kpmJHYFc0f28HSArDQhM7sHcm3g7zvpdBXlnsSYl004UtKMSo30
</code></pre>
<h3 id="確認"><a class="header" href="#確認">確認</a></h3>
<p>[command]</p>
<p>Railsコンソールを起動して、credentialsを読み込めるか確認します。</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>[command]</p>
<p><code>config/credentials.yml.enc</code>の暗号化された情報を取得するには、<code>Rails.application.credentials</code>を実行します。</p>
<pre><code class="language-ruby">Rails.application.credentials
Rails.application.credentials.stripe
Rails.application.credentials.stripe.public_key
</code></pre>
<p>[command]</p>
<p><code>Rails.application.credentials.stripe</code>を実行すると、以下のように表示されます。</p>
<pre><code class="language-ruby">pry(main)&gt; Rails.application.credentials.stripe
=&gt; {:public_key=&gt;
  &quot;pk_test_51NUK3XLQ6aqGA5PKRkYPqeJIMwl0zVSMcujZ4buf1RKC1N7UmDaMFocVqhwZ0uL8gjJtbmUatl045M7Bo0yE61No00mtTjAslk&quot;,
 :secret_key=&gt;
  &quot;sk_test_51NUK3XLQ6aqGA5PKuCHIo1N1i7vxQIpjxxMpjl3CZ6PW4Vu2kpmJHYFc0f28HSArDQhM7sHcm3g7zvpdBXlnsSYl004UtKMSo30&quot;}
</code></pre>
<h2 id="設定ファイルの作成"><a class="header" href="#設定ファイルの作成">設定ファイルの作成</a></h2>
<p>[command]</p>
<p><code>config/initializers</code>ディレクトリに、<code>stripe.rb</code>というファイルを作成します。</p>
<pre><code class="language-bash">touch config/initializers/stripe.rb
</code></pre>
<p>[code]</p>
<p><code>config/initializers/stripe.rb</code>に以下を追加します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

### Stripe::StripeConfigurationをオーバーライドして、Rails.application.credentialsから秘匿情報をセットする
module Stripe
  class StripeConfiguration
    def api_key=(key_value)
      @api_key = key_value || Rails.application.credentials.stripe.secret_key
    end
  end
end

Rails.configuration.stripe = {
  publishable_key: Rails.application.credentials.stripe.publishable_key,
  secret_key: Rails.application.credentials.stripe.secret_key
}

Stripe.api_key = Rails.configuration.stripe[:secret_key]
Stripe.api_version = &quot;2022-11-15&quot;
</code></pre>
<p>[command]</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>[code]</p>
<pre><code class="language-ruby">Stripe.api_key
#=&gt; &quot;sk_test_51NUK3XLQ6aqGA5PKuCHIo1N1i7vxQIpjxxMpjl3CZ6PW4Vu2kpmJHYFc0f28HSArDQhM7sHcm3g7zvpdBXlnsSYl004UtKMSo30&quot;
</code></pre>
<p>これで、StripeのAPIを使う準備が整いました。</p>
<h2 id="customerを作成する"><a class="header" href="#customerを作成する">Customerを作成する</a></h2>
<p>[code]</p>
<pre><code class="language-ruby"># frozen_string_literal: true

require &quot;stripe&quot;

module StripeCore
  class Customer
    def self.create
      Stripe::Customer.create(
        {
          preferred_locales: [&quot;ja-JP&quot;],
          email: &quot;info@mycms.com&quot;,
          name: &quot;My CMS管理者&quot;,
          description: &quot;My First Test Customer (created for API docs at https://www.stripe.com/docs/api)&quot;,
          metadata: {
            admin_id: 1
          }
        }
      )
    end
  end
end
</code></pre>
<p>[command]</p>
<p>Railsコンソールを起動して、<code>StripeCore::Customer.create</code>を実行します。</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>[code]</p>
<pre><code class="language-ruby">StripeCore::Customer.create
</code></pre>
<p>[output]</p>
<pre><code class="language-console">/workspace# bin/rails c
Loading development environment (Rails 7.0.3)
pry(main)&gt; StripeCore::Customer.create
=&gt; #&lt;Stripe::Customer:0x1151c id=cus_OGw7VTYwjcSDWw&gt; JSON: {
  &quot;id&quot;: &quot;cus_OGw7VTYwjcSDWw&quot;,
  &quot;object&quot;: &quot;customer&quot;,
  &quot;address&quot;: null,
  &quot;balance&quot;: 0,
  &quot;created&quot;: 1689488171,
  &quot;currency&quot;: null,
  &quot;default_source&quot;: null,
  &quot;delinquent&quot;: false,
  &quot;description&quot;: &quot;My First Test Customer (created for API docs at https://www.stripe.com/docs/api)&quot;,
  &quot;discount&quot;: null,
  &quot;email&quot;: &quot;info@mycms.com&quot;,
  &quot;invoice_prefix&quot;: &quot;9FCEB8AF&quot;,
  &quot;invoice_settings&quot;: {&quot;custom_fields&quot;:null,&quot;default_payment_method&quot;:null,&quot;footer&quot;:null,&quot;rendering_options&quot;:null},
  &quot;livemode&quot;: false,
  &quot;metadata&quot;: {&quot;admin_id&quot;:&quot;1&quot;},
  &quot;name&quot;: &quot;My CMS管理者&quot;,
  &quot;next_invoice_sequence&quot;: 1,
  &quot;phone&quot;: null,
  &quot;preferred_locales&quot;: [
    &quot;ja-JP&quot;
  ],
  &quot;shipping&quot;: null,
  &quot;tax_exempt&quot;: &quot;none&quot;,
  &quot;test_clock&quot;: null
}
</code></pre>
<p>ダッシュボードを確認する。</p>
<h2 id="customerからカード情報を作成する"><a class="header" href="#customerからカード情報を作成する">Customerからカード情報を作成する</a></h2>
<blockquote>
<p><a href="https://stripe.com/docs/api/cards/create">Stripe Docs: Create a card</a></p>
</blockquote>
<p>[code]</p>
<pre><code class="language-ruby">class Customer
  def self.create_source(customer_id)
    Stripe::Customer.create_source(
      customer_id,
      { source: &quot;tok_visa&quot; }
    )
  end
end
</code></pre>
<p>[command]</p>
<p>Railsコンソールを起動して、<code>StripeCore::Customer.create_source</code>を実行します。</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>[code]</p>
<pre><code class="language-ruby">StripeCore::Customer.create_source(&quot;cus_OGw7VTYwjcSDWw&quot;)
</code></pre>
<p>[output]</p>
<pre><code class="language-console">/workspace# bin/rails c
Loading development environment (Rails 7.0.3)
[1] pry(main)&gt; StripeCore::Customer.create_source(&quot;cus_OGw7VTYwjcSDWw&quot;)
=&gt; #&lt;Stripe::Card:0x1151c id=card_1NUOOlLQ6aqGA5PKYoYLQZWy&gt; JSON: {
  &quot;id&quot;: &quot;card_1NUOOlLQ6aqGA5PKYoYLQZWy&quot;,
  &quot;object&quot;: &quot;card&quot;,
  &quot;address_city&quot;: null,
  &quot;address_country&quot;: null,
  &quot;address_line1&quot;: null,
  &quot;address_line1_check&quot;: null,
  &quot;address_line2&quot;: null,
  &quot;address_state&quot;: null,
  &quot;address_zip&quot;: null,
  &quot;address_zip_check&quot;: null,
  &quot;brand&quot;: &quot;Visa&quot;,
  &quot;country&quot;: &quot;US&quot;,
  &quot;customer&quot;: &quot;cus_OGw7VTYwjcSDWw&quot;,
  &quot;cvc_check&quot;: null,
  &quot;dynamic_last4&quot;: null,
  &quot;exp_month&quot;: 7,
  &quot;exp_year&quot;: 2024,
  &quot;fingerprint&quot;: &quot;E0ZfxYqjvPhjsTOv&quot;,
  &quot;funding&quot;: &quot;credit&quot;,
  &quot;last4&quot;: &quot;4242&quot;,
  &quot;metadata&quot;: {},
  &quot;name&quot;: null,
  &quot;tokenization_method&quot;: null,
  &quot;wallet&quot;: null
}
</code></pre>
<p>ダッシュボードを確認する。</p>
<h2 id="chargeを作成する"><a class="header" href="#chargeを作成する">Chargeを作成する</a></h2>
<p>[code]</p>
<p><code>lib/stripe_core.rb</code>に、<code>Charge</code>クラスを作成します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

require &quot;stripe&quot;

module StripeCore
  class Charge
    def self.create(customer_id)
      Stripe::Charge.create(
        amount: 2000,
        currency: &quot;jpy&quot;,
        customer: customer_id,
        description: &quot;My First Test Charge (created for API docs at https://www.stripe.com/docs/api)&quot;,
        metadata: {
          user_id: 1,
          book_id: 1
        }
      )
    end
  end
end
</code></pre>
<p>[command]</p>
<p>Railsコンソールを起動して、<code>StripeCore::Charge.create</code>を実行します。</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>[code]</p>
<pre><code class="language-ruby">StripeCore::Charge.create(&quot;cus_OGw7VTYwjcSDWw&quot;)
</code></pre>
<p>[output]</p>
<p>以下のようなJSONが戻ってくれば成功です。Stripeのダッシュボードで確認してみましょう。</p>
<pre><code class="language-console">/workspace# bin/rails c
Loading development environment (Rails 7.0.3)
[1] pry(main)&gt; StripeCore::Charge.create(&quot;cus_OGw7VTYwjcSDWw&quot;)
=&gt; #&lt;Stripe::Charge:0x1151c id=ch_3NUORvLQ6aqGA5PK1TyDs95v&gt; JSON: {
  &quot;id&quot;: &quot;ch_3NUORvLQ6aqGA5PK1TyDs95v&quot;,
  &quot;object&quot;: &quot;charge&quot;,
  &quot;amount&quot;: 2000,
  &quot;amount_captured&quot;: 2000,
  &quot;amount_refunded&quot;: 0,
  &quot;application&quot;: null,
  &quot;application_fee&quot;: null,
  &quot;application_fee_amount&quot;: null,
  &quot;balance_transaction&quot;: &quot;txn_3NUORvLQ6aqGA5PK1V5XT7KW&quot;,
  &quot;billing_details&quot;: {&quot;address&quot;:{&quot;city&quot;:null,&quot;country&quot;:null,&quot;line1&quot;:null,&quot;line2&quot;:null,&quot;postal_code&quot;:null,&quot;state&quot;:null},&quot;email&quot;:null,&quot;name&quot;:null,&quot;phone&quot;:null},
  &quot;calculated_statement_descriptor&quot;: &quot;OH MY LIKE&quot;,
  &quot;captured&quot;: true,
  &quot;created&quot;: 1689488935,
  &quot;currency&quot;: &quot;jpy&quot;,
  &quot;customer&quot;: &quot;cus_OGw7VTYwjcSDWw&quot;,
  &quot;description&quot;: &quot;My First Test Charge (created for API docs at https://www.stripe.com/docs/api)&quot;,
  &quot;destination&quot;: null,
  &quot;dispute&quot;: null,
  &quot;disputed&quot;: false,
  &quot;failure_balance_transaction&quot;: null,
  &quot;failure_code&quot;: null,
  &quot;failure_message&quot;: null,
  &quot;fraud_details&quot;: {},
  &quot;invoice&quot;: null,
  &quot;livemode&quot;: false,
  &quot;metadata&quot;: {&quot;book_id&quot;:&quot;1&quot;,&quot;user_id&quot;:&quot;1&quot;},
  &quot;on_behalf_of&quot;: null,
  &quot;order&quot;: null,
  &quot;outcome&quot;: {&quot;network_status&quot;:&quot;approved_by_network&quot;,&quot;reason&quot;:null,&quot;risk_level&quot;:&quot;normal&quot;,&quot;risk_score&quot;:37,&quot;seller_message&quot;:&quot;Payment complete.&quot;,&quot;type&quot;:&quot;authorized&quot;},
  &quot;paid&quot;: true,
  &quot;payment_intent&quot;: null,
  &quot;payment_method&quot;: &quot;card_1NUOOlLQ6aqGA5PKYoYLQZWy&quot;,
  &quot;payment_method_details&quot;: {&quot;card&quot;:{&quot;brand&quot;:&quot;visa&quot;,&quot;checks&quot;:{&quot;address_line1_check&quot;:null,&quot;address_postal_code_check&quot;:null,&quot;cvc_check&quot;:null},&quot;country&quot;:&quot;US&quot;,&quot;exp_month&quot;:7,&quot;exp_year&quot;:2024,&quot;fingerprint&quot;:&quot;E0ZfxYqjvPhjsTOv&quot;,&quot;funding&quot;:&quot;credit&quot;,&quot;installments&quot;:null,&quot;last4&quot;:&quot;4242&quot;,&quot;mandate&quot;:null,&quot;network&quot;:&quot;visa&quot;,&quot;network_token&quot;:{&quot;used&quot;:false},&quot;three_d_secure&quot;:null,&quot;wallet&quot;:null},&quot;type&quot;:&quot;card&quot;},
  &quot;receipt_email&quot;: null,
  &quot;receipt_number&quot;: null,
  &quot;receipt_url&quot;: &quot;https://pay.stripe.com/receipts/payment/CAcaFwoVYWNjdF8xTlVLM1hMUTZhcUdBNVBLKKiczqUGMgY4n26pK546LBa2yiL8120g8JOHE1j6MJ1n1JPylN13T7CKD7CLyAJSu9yVUoLdhvuaQd91&quot;,
  &quot;refunded&quot;: false,
  &quot;review&quot;: null,
  &quot;shipping&quot;: null,
  &quot;source&quot;: {&quot;id&quot;:&quot;card_1NUOOlLQ6aqGA5PKYoYLQZWy&quot;,&quot;object&quot;:&quot;card&quot;,&quot;address_city&quot;:null,&quot;address_country&quot;:null,&quot;address_line1&quot;:null,&quot;address_line1_check&quot;:null,&quot;address_line2&quot;:null,&quot;address_state&quot;:null,&quot;address_zip&quot;:null,&quot;address_zip_check&quot;:null,&quot;brand&quot;:&quot;Visa&quot;,&quot;country&quot;:&quot;US&quot;,&quot;customer&quot;:&quot;cus_OGw7VTYwjcSDWw&quot;,&quot;cvc_check&quot;:null,&quot;dynamic_last4&quot;:null,&quot;exp_month&quot;:7,&quot;exp_year&quot;:2024,&quot;fingerprint&quot;:&quot;E0ZfxYqjvPhjsTOv&quot;,&quot;funding&quot;:&quot;credit&quot;,&quot;last4&quot;:&quot;4242&quot;,&quot;metadata&quot;:{},&quot;name&quot;:null,&quot;tokenization_method&quot;:null,&quot;wallet&quot;:null},
  &quot;source_transfer&quot;: null,
  &quot;statement_descriptor&quot;: null,
  &quot;statement_descriptor_suffix&quot;: null,
  &quot;status&quot;: &quot;succeeded&quot;,
  &quot;transfer_data&quot;: null,
  &quot;transfer_group&quot;: null
}
</code></pre>
<p>ダッシュボードを確認する。</p>
<h2 id="refundを作成する"><a class="header" href="#refundを作成する">Refundを作成する</a></h2>
<p>[code]</p>
<p><code>lib/stripe_core.rb</code>に、<code>Refund</code>クラスを作成します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

require &quot;stripe&quot;

module StripeCore
  class Refund
    def self.create(charge_id)
      Stripe::Refund.create(
        {
          charge: charge_id
        }
      )
    end
  end
end
</code></pre>
<p>[command]</p>
<p>Railsコンソールを起動して、<code>StripeCore::Refund.create</code>を実行します。</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>[code]</p>
<pre><code class="language-ruby">StripeCore::Refund.create(&quot;ch_3NUORvLQ6aqGA5PK1TyDs95v&quot;)
</code></pre>
<p>[output]</p>
<pre><code class="language-console">/workspace# bin/rails c
Loading development environment (Rails 7.0.3)
[1] pry(main)&gt; StripeCore::Refund.create(&quot;ch_3NUORvLQ6aqGA5PK1TyDs95v&quot;)
=&gt; #&lt;Stripe::Refund:0x11530 id=re_3NUORvLQ6aqGA5PK13KYgtGy&gt; JSON: {
  &quot;id&quot;: &quot;re_3NUORvLQ6aqGA5PK13KYgtGy&quot;,
  &quot;object&quot;: &quot;refund&quot;,
  &quot;amount&quot;: 2000,
  &quot;balance_transaction&quot;: &quot;txn_3NUORvLQ6aqGA5PK10GZV244&quot;,
  &quot;charge&quot;: &quot;ch_3NUORvLQ6aqGA5PK1TyDs95v&quot;,
  &quot;created&quot;: 1689494591,
  &quot;currency&quot;: &quot;jpy&quot;,
  &quot;metadata&quot;: {},
  &quot;payment_intent&quot;: null,
  &quot;reason&quot;: null,
  &quot;receipt_number&quot;: null,
  &quot;source_transfer_reversal&quot;: null,
  &quot;status&quot;: &quot;succeeded&quot;,
  &quot;transfer_reversal&quot;: null
}
</code></pre>
<p>ダッシュボードを確認する。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day3に向けた課題-1"><a class="header" href="#day3に向けた課題-1">Day3に向けた課題</a></h1>
<p>発表に向けた準備をしましょう！</p>
<ul>
<li>Day3に向けて実装したい機能を考えて実装してください！</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day3用ページ"><a class="header" href="#day3用ページ">Day3用ページ</a></h1>
<h2 id="このページの目的-2"><a class="header" href="#このページの目的-2">このページの目的</a></h2>
<p>「【G's EXPANSION】 爆速で身に着けるRuby on Rails：自分だけのCMSを開発しよう！」の最終日Day3の講義用ページです。</p>
<h3 id="今日の講義の目的-2"><a class="header" href="#今日の講義の目的-2">今日の講義の目的</a></h3>
<ol>
<li>
<p>課題発表と振り返り会</p>
</li>
<li>
<p>各自でハンズオンいただく</p>
</li>
</ol>
<h2 id="課題発表会"><a class="header" href="#課題発表会">課題発表会</a></h2>
<p>皆さんが実装した機能について発表していただきたく思います。</p>
<ul>
<li>
<p>実装した背景</p>
</li>
<li>
<p>実現したい機能の要件</p>
</li>
<li>
<p>実際に実装した機能をデモしていただく</p>
</li>
<li>
<p>こだわった点、質問したい点などあれば質問していただく</p>
</li>
</ul>
<h1 id="各自でハンズオン"><a class="header" href="#各自でハンズオン">各自でハンズオン</a></h1>
<p>本日分は、以下のブランチに上げています。</p>
<p>ハンズオンでは皆さんに準備いただくブランチを使用するので、pullしなくて大丈夫です。</p>
<p><a href="https://github.com/matakitanakajp09/gs-expansion-rails-sample/tree/lesson-day-3">https://github.com/matakitanakajp09/gs-expansion-rails-sample/tree/lesson-day-3</a></p>
<h2 id="短縮url機能"><a class="header" href="#短縮url機能">短縮URL機能</a></h2>
<p>皆さんに実装してみたい機能を実装いただきましたので、自分も「短縮URL機能」を実装してみました。</p>
<h2 id="機能要件"><a class="header" href="#機能要件">機能要件</a></h2>
<ul>
<li>管理画面で、URLを短縮することができます</li>
<li>短縮URLをクリックすると、外部サイトに遷移する確認画面が表示されます</li>
<li>確認画面で「遷移する」ボタンを押下すると、外部サイトに遷移します</li>
<li>インプレッション数、クリック数のカウントをすることができます</li>
<li>インプレッション数、クリック数は、Redisを用いて一時保存し、定期的にDBできるように、バッチ処理を実装します</li>
<li>短縮URLの出来上がりは、以下のようになります</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th></th><th>URL</th></tr></thead><tbody>
<tr><td>短縮前</td><td>https://www.kidsweekend.jp/portal</td></tr>
<tr><td>短縮後</td><td>http://localhost:3000/l/e09i1Zxhye</td></tr>
</tbody></table>
</div>
<h2 id="各自でハンズオン-1"><a class="header" href="#各自でハンズオン-1">各自でハンズオン</a></h2>
<p>最終日は皆さんに資料見ながらハンズオンをしていただきます（講義形式ではなくこの講義時間で皆さん自身が自分で行なっていく形式）。
随時質問は受け付けますので、わからないことがあれば遠慮なく質問してください。</p>
<h2 id="ハンズオン用ブランチの準備"><a class="header" href="#ハンズオン用ブランチの準備">ハンズオン用ブランチの準備</a></h2>
<p><code>lesson-day-3</code>というブランチを切ります。ブランチ名はお好きなようにつけていただいて大丈夫です。</p>
<pre><code class="language-bash">git switch -c lesson-day-3
</code></pre>
<h2 id="短縮url機能短縮urlトラッキング機能の実装"><a class="header" href="#短縮url機能短縮urlトラッキング機能の実装">短縮URL機能、短縮URLトラッキング機能の実装</a></h2>
<h3 id="概要図"><a class="header" href="#概要図">概要図</a></h3>
<p><img src="day-3/./images/short_url_6.jpg" alt="img" /></p>
<h3 id="各ハンズオン"><a class="header" href="#各ハンズオン">各ハンズオン</a></h3>
<ul>
<li><a href="day-3/./short-url.html">短縮URL機能</a></li>
<li><a href="day-3/./short-url-tracking.html">短縮URLトラッキング機能</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day3-短縮url管理画面"><a class="header" href="#day3-短縮url管理画面">Day3: 短縮URL管理画面</a></h1>
<h2 id="マイグレーション-1"><a class="header" href="#マイグレーション-1">マイグレーション</a></h2>
<p>今回、短縮URL <code>short_url</code> というモデル名で実装していきます。</p>
<p>マイグレーションファイルを作成します。</p>
<pre><code class="language-bash">bin/rails g migration CreateShortUrls
</code></pre>
<p>マイグレーションファイルを以下のように編集します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class CreateShortUrls &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :short_urls, id: :uuid do |t|
      t.references :admin, foreign_key: true, deferrable: :deferred, type: :uuid, comment: &quot;Adminテーブルの外部キー&quot;
      t.string :custom_key, null: false, comment: &quot;カスタムキー&quot;
      t.string :label_name, null: false, comment: &quot;URLラベルネーム&quot;
      t.text :original_url, null: false, comment: &quot;短縮元URL&quot;
      t.string :utm_source, null: false, comment: &quot;GA用参照元&quot;
      t.string :utm_medium, null: false, comment: &quot;GA用メディア&quot;
      t.string :utm_campaign, null: false, comment: &quot;GA用キャンペーン名&quot;
      t.timestamps
    end
  end
end
</code></pre>
<p>※データ取得でGoogle Analyticsを使用する前提で<code>utm_</code>の接頭辞が付くカラムを準備しています。</p>
<div class="table-wrapper"><table><thead><tr><th>カラム名</th><th>説明</th></tr></thead><tbody>
<tr><td>admin_id</td><td>Adminテーブルの外部キー</td></tr>
<tr><td>custom_key</td><td>リダイレクト時に使用するキー</td></tr>
<tr><td>label_name</td><td>管理画面で使用するラベル名</td></tr>
<tr><td>original_url</td><td>短縮元リンク</td></tr>
<tr><td>utm_source</td><td>GA用参照元</td></tr>
<tr><td>utm_medium</td><td>GA用メディア</td></tr>
<tr><td>utm_campaign</td><td>GA用キャンペーン名</td></tr>
</tbody></table>
</div>
<p>マイグレーションを実行します。</p>
<pre><code class="language-bash">bin/rails db:migrate
</code></pre>
<h2 id="モデル"><a class="header" href="#モデル">モデル</a></h2>
<p>モデルを作成します。</p>
<pre><code class="language-bash">touch app/models/short_url.rb
</code></pre>
<p>以下のように編集します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class ShortUrl &lt; ApplicationRecord
  belongs_to :admin

  validates :label_name, length: { maximum: 255, too_long: &quot;最大%&lt;count&gt;s文字まで使えます&quot; }, presence: true
  validates :original_url, presence: true
  validates :utm_source, presence: true, length: { maximum: 255, too_long: &quot;最大%&lt;count&gt;s文字まで使えます&quot; }, presence: true
  validates :utm_medium, presence: true, length: { maximum: 255, too_long: &quot;最大%&lt;count&gt;s文字まで使えます&quot; }, presence: true
  validates :utm_campaign, presence: true, length: { maximum: 255, too_long: &quot;最大%&lt;count&gt;s文字まで使えます&quot; }, presence: true

  before_create :fill_custom_key

  def fill_custom_key
    self.custom_key = loop do
      uuid = SecureRandom.alphanumeric(10) # JWlXD6cCxM
      break uuid unless self.class.exists?(custom_key: uuid)
    end
  end

  def short_url
    Rails.application.routes.url_helpers.short_url_url(
      id: custom_key,
      host: Rails.application.routes.default_url_options[:host],
      protocol: Rails.application.routes.default_url_options[:protocol]
    )
  end

  def parameter_url
    query = {
      utm_source: self&amp;.utm_source,
      utm_medium: self&amp;.utm_medium,
      utm_campaign: self&amp;.utm_campaign
    }
    uri = URI.parse(self&amp;.original_url)
    uri.query = query.to_param
    uri.to_s
  end
end
</code></pre>
<h2 id="ルーティング"><a class="header" href="#ルーティング">ルーティング</a></h2>
<p>続いて管理画面用のルーティングを設定していきます。</p>
<pre><code class="language-bash">touch config/routes/admin/short_urls.rb
</code></pre>
<p>以下のように編集します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

Rails.application.routes.draw do
  namespace :admin do
    resources :short_urls
  end
end
</code></pre>
<h2 id="コントローラー"><a class="header" href="#コントローラー">コントローラー</a></h2>
<p>続いてコントローラーを作成します。</p>
<pre><code class="language-bash">touch app/controllers/admin/short_urls_controller.rb
</code></pre>
<p>以下のように編集します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class Admin::ShortUrlsController &lt; Admin::ApplicationController
  def index
    @short_urls = ShortUrl.all
  end

  def show
    @short_url = ShortUrl.find(params[:id])
  end

  def new
    @short_url = ShortUrl.new
  end

  def create
    @short_url = ShortUrl.new(create_params)
    if @short_url.save
      flash.now.notice = t(&quot;admin.create.success&quot;)
      redirect_to admin_short_urls_path
    else
      flash.now.alert = t(&quot;admin.create.failed&quot;)
      render :new, status: :unprocessable_entity
    end
  end

  def edit
    @short_url = ShortUrl.find(params[:id])
  end

  def update
    @short_url = ShortUrl.find(params[:id])
    if @short_url.update(update_params)
      flash.now.notice = t(&quot;admin.update.success&quot;)
      redirect_to admin_short_url_path
    else
      flash.now.alert = t(&quot;admin.update.failed&quot;)
      render :edit, status: :unprocessable_entity
    end
  end

  private

  def create_params
    params.require(:short_url).permit(
      :admin_id,
      :label_name,
      :original_url,
      :utm_source,
      :utm_medium,
      :utm_campaign
    )
  end

  def update_params
    create_params
  end
end
</code></pre>
<h2 id="翻訳設定の追加"><a class="header" href="#翻訳設定の追加">翻訳設定の追加</a></h2>
<p>翻訳設定を追加しておきます。</p>
<p>Filename: <code>config/locales/models/ja.yml</code></p>
<pre><code class="language-yaml">short_url:
  id: ID
  custom_id: カスタムKey
  label_name: ラベル名
  original_url: 短縮元URL
  short_url: 短縮URL
  parameter_url: パラメータ付きURL
  utm_source: 広告主
  utm_medium: メディア名
  utm_campaign: キャンペーン名
</code></pre>
<p>Filename: <code>config/locales/views/admin/ja.yml</code></p>
<pre><code class="language-yaml">short_urls:
  breadcrumb:
    index:
      title: 短縮リンク
    new:
      title: 新規作成
  index:
    title: 短縮リンク設定
  new:
    title: 短縮リンクを作成する
</code></pre>
<h2 id="ビュー"><a class="header" href="#ビュー">ビュー</a></h2>
<p>まず一覧画面を作成します。</p>
<p>※サイドメニューに「短縮URL」を追加する場合は、ご自分で追加ください</p>
<pre><code class="language-bash">mkdir -p app/views/admin/short_urls &amp;&amp; mkdir -p app/views/admin/short_urls/breadcrumb &amp;&amp; touch app/views/admin/short_urls/breadcrumb/_index.html.erb &amp;&amp; touch app/views/admin/short_urls/index.html.erb &amp;&amp; touch app/views/admin/short_urls/_index_table.html.erb
</code></pre>
<h3 id="一覧画面-2"><a class="header" href="#一覧画面-2">一覧画面</a></h3>
<p>以下のように編集します。</p>
<p>Filename: <code>app/views/admin/short_urls/index.html.erb</code></p>
<pre><code class="language-erb">&lt;div class=&quot;l-container&quot;&gt;
  &lt;%= render partial: &quot;layouts/admin/article_menu&quot; %&gt;
  &lt;div class=&quot;l-main-view&quot;&gt;
    &lt;div class=&quot;sw-main-header&quot;&gt;
      &lt;div class=&quot;sw-main-header-title&quot;&gt;
        &lt;%= t &quot;.title&quot; %&gt;
      &lt;/div&gt;
      &lt;div class=&quot;sw-main-header-buttons&quot;&gt;
        &lt;div class=&quot;sw-main-header-button&quot;&gt;
          &lt;%= link_to new_admin_short_url_path, class: &quot;btn btn-primary&quot; do %&gt;
            &lt;%= t &quot;buttons.create&quot; %&gt;
          &lt;% end %&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;sw-main-body&quot;&gt;
      &lt;ul class=&quot;breadcrumb p-3&quot;&gt;
        &lt;%= render partial: &quot;admin/short_urls/breadcrumb/index&quot; %&gt;
      &lt;/ul&gt;
      &lt;%= render partial: &quot;admin/short_urls/index_table&quot; %&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="一覧テーブル"><a class="header" href="#一覧テーブル">一覧テーブル</a></h3>
<p>Filename: <code>app/views/admin/short_urls/_index_table.html.erb</code></p>
<pre><code class="language-erb">&lt;div class=&quot;sw-main-body-table table-responsive&quot;&gt;
  &lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;&lt;/th&gt;
        &lt;th&gt;名前&lt;/th&gt;
        &lt;th&gt;短縮元URL&lt;/th&gt;
        &lt;th&gt;作成日&lt;/th&gt;
      &lt;/tr&gt;
    &lt;/thead&gt;
    &lt;tbody&gt;
      &lt;% @short_urls.each do |short_url| %&gt;
        &lt;tr&gt;
          &lt;td class=&quot;rowlink&quot;&gt;
            &lt;%= link_to admin_short_url_path(id: short_url&amp;.id) do %&gt;
            &lt;% end %&gt;
          &lt;/td&gt;
          &lt;td style=&quot;min-width: 100px;&quot;&gt;
            &lt;%= short_url&amp;.label_name %&gt;
          &lt;/td&gt;
          &lt;td style=&quot;min-width: 100px;&quot;&gt;
            &lt;%= short_url&amp;.original_url %&gt;
          &lt;/td&gt;
          &lt;td style=&quot;min-width: 150px;&quot;&gt;
            &lt;%= short_url&amp;.created_at %&gt;
          &lt;/td&gt;
        &lt;/tr&gt;
      &lt;% end %&gt;
    &lt;/tbody&gt;
  &lt;/table&gt;
&lt;/div&gt;
</code></pre>
<h3 id="一覧画面のパンくずリスト"><a class="header" href="#一覧画面のパンくずリスト">一覧画面のパンくずリスト</a></h3>
<p>Filename: <code>app/views/admin/short_urls/breadcrumb/_index.html.erb</code></p>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to admin_short_urls_path do %&gt;
    &lt;%= t &quot;.title&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<p>以下にアクセスしてみます。</p>
<p>http://127.0.0.1:3000/admin/short_urls</p>
<p><img src="day-3/./images/short_url_2.png" alt="img" /></p>
<h3 id="作成画面"><a class="header" href="#作成画面">作成画面</a></h3>
<p>作成画面ファイルを作成します。</p>
<pre><code class="language-bash">touch app/views/admin/short_urls/new.html.erb &amp;&amp; touch app/views/admin/short_urls/_form_attributes.html.erb &amp;&amp; touch app/views/admin/short_urls/breadcrumb/_new.html.erb
</code></pre>
<h3 id="作成画面-1"><a class="header" href="#作成画面-1">作成画面</a></h3>
<pre><code class="language-erb">&lt;div class=&quot;l-container&quot;&gt;
  &lt;%= render partial: &quot;layouts/admin/article_menu&quot; %&gt;
  &lt;div class=&quot;l-main-view&quot;&gt;
    &lt;div class=&quot;sw-main-header&quot;&gt;
      &lt;div class=&quot;sw-main-header-title&quot;&gt;
        &lt;%= t &quot;.title&quot; %&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;sw-main-body&quot;&gt;
      &lt;ul class=&quot;breadcrumb p-3&quot;&gt;
        &lt;%= render partial: &quot;admin/short_urls/breadcrumb/index&quot; %&gt;
        &lt;%= render partial: &quot;admin/short_urls/breadcrumb/new&quot; %&gt;
      &lt;/ul&gt;
      &lt;div class=&quot;section&quot;&gt;
        &lt;%= render :partial =&gt; &quot;admin/flash&quot; %&gt;
      &lt;/div&gt;
      &lt;%= render :partial =&gt; &quot;admin/short_urls/form_attributes&quot; %&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="作成画面のパンくずリスト"><a class="header" href="#作成画面のパンくずリスト">作成画面のパンくずリスト</a></h3>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to new_admin_short_url_path do %&gt;
    &lt;%= t &quot;breadcrumb.new&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<h3 id="フォーム"><a class="header" href="#フォーム">フォーム</a></h3>
<pre><code class="language-erb">&lt;%= form_with model: [:admin, @short_url], local: true do |f| %&gt;
  &lt;%= f.hidden_field :admin_id, :value =&gt; current_admin&amp;.id %&gt;
  &lt;div class=&quot;section&quot;&gt;
    &lt;div class=&quot;d-flex justify-content-between border-bottom pb-3&quot;&gt;
      &lt;div&gt;&lt;/div&gt;
      &lt;div class=&quot;d-flex&quot;&gt;
        &lt;div&gt;
          &lt;button class=&quot;btn btn-primary&quot;&gt;&lt;%= t &quot;buttons.save&quot; %&gt;&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class=&quot;section&quot;&gt;
    &lt;div class=&quot;card border-0&quot;&gt;
      &lt;div class=&quot;card-body&quot;&gt;
        &lt;div class=&quot;row&quot;&gt;
          &lt;div class=&quot;col-md-12 mt-3&quot;&gt;
            &lt;%= f.label :label_name, class: &quot;mb-1 form-label text-small text-muted&quot; do %&gt;
              &lt;%= t &quot;activerecord.attributes.short_url.label_name&quot; %&gt;
            &lt;% end %&gt;
            &lt;%= f.text_field :label_name, autofocus: true, class: &quot;form-control&quot;, placeholder: &quot;&quot; %&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;row&quot;&gt;
          &lt;div class=&quot;col-md-12 mt-3&quot;&gt;
            &lt;%= f.label :original_url, class: &quot;mb-1 form-label text-small text-muted&quot; do %&gt;
              &lt;%= t &quot;activerecord.attributes.short_url.original_url&quot; %&gt;
            &lt;% end %&gt;
            &lt;%= f.text_field :original_url, autofocus: true, class: &quot;form-control&quot;, placeholder: &quot;&quot; %&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;row&quot;&gt;
          &lt;div class=&quot;col-md-4 mt-3&quot;&gt;
            &lt;%= f.label :utm_source, class: &quot;mb-1 form-label text-small text-muted&quot; do %&gt;
              &lt;%= t &quot;activerecord.attributes.short_url.utm_source&quot; %&gt;
            &lt;% end %&gt;
            &lt;%= f.text_field :utm_source, autofocus: true, class: &quot;form-control&quot;, placeholder: &quot;&quot; %&gt;
          &lt;/div&gt;
          &lt;div class=&quot;col-md-4 mt-3&quot;&gt;
            &lt;%= f.label :utm_medium, class: &quot;mb-1 form-label text-small text-muted&quot; do %&gt;
              &lt;%= t &quot;activerecord.attributes.short_url.utm_medium&quot; %&gt;
            &lt;% end %&gt;
            &lt;%= f.text_field :utm_medium, autofocus: true, class: &quot;form-control&quot;, placeholder: &quot;&quot; %&gt;
          &lt;/div&gt;
          &lt;div class=&quot;col-md-4 mt-3&quot;&gt;
            &lt;%= f.label :utm_campaign, class: &quot;mb-1 form-label text-small text-muted&quot; do %&gt;
              &lt;%= t &quot;activerecord.attributes.short_url.utm_campaign&quot; %&gt;
            &lt;% end %&gt;
            &lt;%= f.text_field :utm_campaign, autofocus: true, class: &quot;form-control&quot;, placeholder: &quot;&quot; %&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>
<p>以下にアクセスしてみます。</p>
<p>※実際に作成してみてください</p>
<p><img src="day-3/./images/short_url_3.png" alt="img" /></p>
<p>http://127.0.0.1:3000/admin/short_urls/new</p>
<h3 id="詳細画面ファイルを作成"><a class="header" href="#詳細画面ファイルを作成">詳細画面ファイルを作成</a></h3>
<pre><code class="language-bash">touch app/views/admin/short_urls/show.html.erb &amp;&amp; touch app/views/admin/short_urls/breadcrumb/_show.html.erb
</code></pre>
<h3 id="詳細画面-1"><a class="header" href="#詳細画面-1">詳細画面</a></h3>
<pre><code class="language-erb">&lt;div class=&quot;l-container&quot;&gt;
  &lt;%= render partial: &quot;layouts/admin/article_menu&quot; %&gt;
  &lt;div class=&quot;l-main-view&quot;&gt;
    &lt;div class=&quot;sw-main-header&quot;&gt;
      &lt;div class=&quot;sw-main-header-title&quot;&gt;
        &lt;%= @short_url&amp;.label_name %&gt;
      &lt;/div&gt;
      &lt;div class=&quot;sw-main-header-buttons&quot;&gt;
        &lt;div class=&quot;sw-main-header-button&quot;&gt;
          &lt;%= link_to edit_admin_short_url_path, class: &quot;btn btn-primary&quot; do %&gt;
            &lt;%= t &quot;buttons.edit&quot; %&gt;
          &lt;% end %&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;sw-main-body&quot;&gt;
      &lt;ul class=&quot;breadcrumb p-3&quot;&gt;
        &lt;%= render partial: &quot;admin/short_urls/breadcrumb/index&quot; %&gt;
        &lt;%= render partial: &quot;admin/short_urls/breadcrumb/show&quot; %&gt;
      &lt;/ul&gt;
      &lt;div class=&quot;section&quot;&gt;
        &lt;%= render :partial =&gt; &quot;admin/flash&quot; %&gt;
      &lt;/div&gt;
      &lt;div class=&quot;section&quot;&gt;
        &lt;h2 class=&quot;admin-title&quot;&gt;短縮リンク&lt;/h2&gt;
        &lt;div class=&quot;card&quot;&gt;
          &lt;div class=&quot;card-body&quot;&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-6 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.short_url.id&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.id %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-6 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.short_url.label_name&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.label_name %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-12 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.short_url.original_url&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.original_url %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-12 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.short_url.short_url&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.short_url %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-12 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.short_url.parameter_url&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.parameter_url %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-4 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.short_url.utm_source&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.utm_source %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;div class=&quot;col-md-4 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.short_url.utm_medium&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.utm_medium %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;div class=&quot;col-md-4 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;activerecord.attributes.short_url.utm_campaign&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.utm_campaign %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;row&quot;&gt;
              &lt;div class=&quot;col-md-6 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;common.created_at&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.created_at %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
              &lt;div class=&quot;col-md-6 mb-3&quot;&gt;
                &lt;div class=&quot;model-key&quot;&gt;
                  &lt;%= t &quot;common.updated_at&quot; %&gt;
                &lt;/div&gt;
                &lt;div class=&quot;model-value&quot;&gt;
                  &lt;%= @short_url&amp;.updated_at %&gt;
                &lt;/div&gt;
              &lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="詳細画面のパンくずリスト"><a class="header" href="#詳細画面のパンくずリスト">詳細画面のパンくずリスト</a></h3>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to admin_short_url_path do %&gt;
    &lt;%= t &quot;breadcrumb.show&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<p>以下にアクセスしてみます。</p>
<p>eg) http://127.0.0.1:3000/admin/short_urls/ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa # ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aaはご自分の環境で作成した短縮URLのIDに置き換えてください</p>
<p><img src="day-3/./images/short_url_5.png" alt="img" /></p>
<h3 id="編集画面のファイルを作成"><a class="header" href="#編集画面のファイルを作成">編集画面のファイルを作成</a></h3>
<pre><code class="language-bash">touch app/views/admin/short_urls/edit.html.erb &amp;&amp; touch app/views/admin/short_urls/breadcrumb/_edit.html.erb
</code></pre>
<h3 id="編集画面-1"><a class="header" href="#編集画面-1">編集画面</a></h3>
<pre><code class="language-erb">&lt;div class=&quot;l-container&quot;&gt;
  &lt;%= render partial: &quot;layouts/admin/article_menu&quot; %&gt;
  &lt;div class=&quot;l-main-view&quot;&gt;
    &lt;div class=&quot;sw-main-header&quot;&gt;
      &lt;div class=&quot;sw-main-header-title&quot;&gt;
        &lt;%= @short_url&amp;.label_name %&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;sw-main-body&quot;&gt;
      &lt;ul class=&quot;breadcrumb p-3&quot;&gt;
        &lt;%= render :partial =&gt; &quot;admin/short_urls/breadcrumb/index&quot; %&gt;
        &lt;%= render :partial =&gt; &quot;admin/short_urls/breadcrumb/show&quot; %&gt;
        &lt;%= render :partial =&gt; &quot;admin/short_urls/breadcrumb/edit&quot; %&gt;
      &lt;/ul&gt;
      &lt;div class=&quot;section&quot;&gt;
        &lt;%= render :partial =&gt; &quot;admin/flash&quot; %&gt;
      &lt;/div&gt;
      &lt;%= render :partial =&gt; &quot;admin/short_urls/form_attributes&quot; %&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="編集画面のパンくずリスト"><a class="header" href="#編集画面のパンくずリスト">編集画面のパンくずリスト</a></h3>
<pre><code class="language-erb">&lt;li&gt;
  &lt;%= link_to edit_admin_tag_path do %&gt;
    &lt;%= t &quot;breadcrumb.edit&quot; %&gt;
  &lt;% end %&gt;
&lt;/li&gt;
</code></pre>
<p>以下にアクセスしてみます。</p>
<p>eg) http://127.0.0.1:3000/admin/short_urls/ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa/edit # ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aaはご自分の環境で作成した短縮URLのIDに置き換えてください</p>
<p><img src="day-3/./images/short_url_4.png" alt="img" /></p>
<p>これで短縮URLの管理ができるようになりました。</p>
<p>次は短縮URLトラッキング機能について実装していきます。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="day3-短縮urlトラッキング機能"><a class="header" href="#day3-短縮urlトラッキング機能">Day3: 短縮URLトラッキング機能</a></h1>
<p>機能要件を再掲します。</p>
<ul>
<li>インプレッション数、クリック数のカウントをすることができます</li>
<li>インプレッション数、クリック数は、Redisを用いて一時保存し、定期的にDBできるように、バッチ処理を実装します</li>
</ul>
<h2 id="redisの説明と使用目的"><a class="header" href="#redisの説明と使用目的">Redisの説明と使用目的</a></h2>
<p>Redisは、インメモリ型のデータベースです。今回は、インプレッション数、クリック数をカウントするために使用します。
インプレッション数、クリック数をカウントするために、毎回データベースに保存すると、データベースに負荷がかかります。
一時的なデータを保存するために、Redisを使用して、定期的にデータベースに保存するようにします。</p>
<h2 id="redisサーバーの設定"><a class="header" href="#redisサーバーの設定">Redisサーバーの設定</a></h2>
<p>ターミナルで、以下のコマンドを実行します。</p>
<pre><code class="language-bash">apt-get update &amp;&amp; apt-get install -y redis-server
</code></pre>
<h3 id="dockerfileを更新"><a class="header" href="#dockerfileを更新">Dockerfileを更新</a></h3>
<p>L12行目の最後に、<code>redis-server</code>を追加します。</p>
<pre><code class="language-dockerfile">RUN apt-get update -qq &amp;&amp; apt-get install -y build-essential nodejs yarn vim zlib1g-dev liblzma-dev patch redis-server
</code></pre>
<h3 id="entrypointlocalshを更新"><a class="header" href="#entrypointlocalshを更新">entrypoint.local.shを更新</a></h3>
<p>Filename: <code>entrypoint.local.sh</code></p>
<pre><code class="language-sh">#!/bin/bash
set -e

redis-server --daemonize yes

# https://github.com/evanw/esbuild/issues/1511

# yarn build --watch &lt; /dev/zero &amp; yarn build:css --watch &amp; bundle exec rails s -b 0.0.0.0
yarn build --watch &lt; /dev/zero &amp; yarn build:css --watch
</code></pre>
<h2 id="redisサーバーの起動を確認する"><a class="header" href="#redisサーバーの起動を確認する">Redisサーバーの起動を確認する</a></h2>
<pre><code class="language-bash">redis-server
</code></pre>
<p>以下のように表示されればOKです。</p>
<pre><code class="language-console">/workspace# redis-server
14247:C 30 Jul 2023 15:31:58.500 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
14247:C 30 Jul 2023 15:31:58.500 # Redis version=6.0.16, bits=64, commit=00000000, modified=0, pid=14247, just started
14247:C 30 Jul 2023 15:31:58.500 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
                _._                                                  
           _.-``__ ''-._                                             
      _.-``    `.  `_.  ''-._           Redis 6.0.16 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ ''-._                                   
 (    '      ,       .-`  | `,    )     Running in standalone mode
 |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379
 |    `-._   `._    /     _.-'    |     PID: 14247
  `-._    `-._  `-./  _.-'    _.-'                                   
 |`-._`-._    `-.__.-'    _.-'_.-'|                                  
 |    `-._`-._        _.-'_.-'    |           http://redis.io        
  `-._    `-._`-.__.-'_.-'    _.-'                                   
 |`-._`-._    `-.__.-'    _.-'_.-'|                                  
 |    `-._`-._        _.-'_.-'    |                                  
  `-._    `-._`-.__.-'_.-'    _.-'                                   
      `-._    `-.__.-'    _.-'                                       
          `-._        _.-'                                           
              `-.__.-'                                               

14247:M 30 Jul 2023 15:31:58.509 # Server initialized
14247:M 30 Jul 2023 15:31:58.514 * Ready to accept connections
</code></pre>
<p>Ctrl + CでRedisサーバーを停止します。</p>
<h2 id="redis用の秘匿情報を設定"><a class="header" href="#redis用の秘匿情報を設定">Redis用の秘匿情報を設定</a></h2>
<p>ターミナルを開いて、以下のコマンドを実行します。</p>
<pre><code class="language-bash">EDITOR=vim bin/rails credentials:edit -e development
</code></pre>
<pre><code class="language-vim">redis:
  host: 127.0.0.1
  port: 6379
</code></pre>
<h3 id="redisの接続確認"><a class="header" href="#redisの接続確認">Redisの接続確認</a></h3>
<p><code>redis-server</code>を起動します。</p>
<pre><code class="language-bash">redis-server --daemonize yes
</code></pre>
<p>RailsコンソールからRedisに接続できることを確認します。</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>Redisクライアントを作成するコードを実行します。</p>
<pre><code class="language-ruby">Redis.current
=&gt; #&lt;Redis client v4.5.1 for redis://127.0.0.1:6379/0&gt;
</code></pre>
<p>OKの場合はRedisに接続できています。</p>
<pre><code class="language-ruby">Redis.current.set(&quot;test&quot;, &quot;test&quot;)
#=&gt; &quot;OK&quot;
</code></pre>
<p>上記でRedisに保存した値を取得する場合は、以下のコードを実行します。</p>
<pre><code class="language-ruby">Redis.current.get(&quot;test&quot;)
#=&gt; &quot;test&quot;
</code></pre>
<p>※Redisには色んな関数が用意されています。詳しくは、<a href="https://github.com/redis/redis-rb">https://github.com/redis/redis-rb</a>を参照してください。</p>
<h2 id="redisのラッパークラスを作成"><a class="header" href="#redisのラッパークラスを作成">Redisのラッパークラスを作成</a></h2>
<p><code>lib</code>ディレクトリ以下に作成していきます。</p>
<pre><code class="language-bash">mkdir -p lib/cms_redis &amp;&amp; touch lib/cms_redis/core.rb
</code></pre>
<p>以下のように編集します。</p>
<p>Filename: <code>lib/cms_redis/core.rb</code></p>
<pre><code class="language-ruby"># frozen_string_literal: true

module CmsRedis
  module Core
    RAILS_MAX_THREADS = 16
    REDIS_TIMEOUT = 1
    EXPIRES = 60 * 60

    class Pool
      class Wrapper &lt; ::ConnectionPool::Wrapper
        def initialize(pool)
          @pool = pool
        end
      end

      class &lt;&lt; self
        def with(&amp;block)
          pool.with(&amp;block)
        end

        def connect
          Wrapper.new(pool)
        end

        private

        def pool
          @pool ||= ::ConnectionPool.new(
            size: ENV.fetch(&quot;RAILS_MAX_THREADS&quot;, RAILS_MAX_THREADS).to_i,
            timeout: ENV.fetch(&quot;REDIS_TIMEOUT&quot;, REDIS_TIMEOUT).to_i
          ) do
            ::Redis.new(Rails.application.credentials.redis.try(&amp;:to_h))
          end
        end
      end
    end

    class Client
      # Redisクライアントを初期化する
      def initialize(cache_key = &quot;&quot;, expires = EXPIRES)
        @connection = ::CmsRedis::Core::Pool.connect
        @cache_key = cache_key
        @expires = expires
      end

      # Redisに保存されている値を取得する&amp;整形する
      def fetch
        return_array_with_sym = array_with_sym
        return return_array_with_sym unless return_array_with_sym.blank?

        return unless block_given?

        array = yield

        set(array)
        array_with_sym
      end

      # Redisに保存されている値を取得する
      def get
        @connection.get(@cache_key)
      end

      # Redisに保存する。その際、有効期限を設定する
      def set(array)
        @connection.with do |redis|
          redis.set(@cache_key, array.to_json)
          redis.expire(@cache_key, @expires)
        end
      end

      # Redisに保存されている値を削除する
      def del
        @connection.del(@cache_key)
      end

      # Redisにキャッシュされているかどうかを判定する
      def cache?
        get.present?
      end

      # Redisに保存されている値を取得し、JSONをパースして返す
      def array_with_sym
        result = get
        array = [&quot;[]&quot;, nil].include?(result) ? [] : result
        return [] if array.blank?

        JSON.parse(array, { symbolize_names: true })
      end
    end
  end
end
</code></pre>
<h2 id="railsコンソールからラッパークラスからredisに接続できることを確認"><a class="header" href="#railsコンソールからラッパークラスからredisに接続できることを確認">RailsコンソールからラッパークラスからRedisに接続できることを確認</a></h2>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>Railsコンソールでコードを実行してみましょう。</p>
<pre><code class="language-ruby">client = CmsRedis::Core::Client.new(&quot;test&quot;)
client.set(&quot;test&quot;)
#=&gt; true
client.get
# =&gt; &quot;\&quot;test\&quot;&quot;
client.fetch
#=&gt; &quot;test&quot;
client.del
#=&gt; 1
client.fetch
#=&gt; nil
client.set([1])
#=&gt; true
client.fetch
#=&gt; [1]
</code></pre>
<h2 id="インプレッション数クリック数のカウント方針"><a class="header" href="#インプレッション数クリック数のカウント方針">インプレッション数、クリック数のカウント方針</a></h2>
<ul>
<li>キャッシュキー<code>short-url:#{id}</code>を作成する</li>
<li>キャッシュする値は、<code>[{:short_url_id=&gt;&quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;, :tracking_type=&gt;&quot;imp&quot;, :created_at=&gt;1690700669}, {...}]</code>のような形式で保存する</li>
<li>キャッシュするcreated_atは、<code>Time.now.to_i</code>で保存する</li>
</ul>
<h2 id="マイグレーション-2"><a class="header" href="#マイグレーション-2">マイグレーション</a></h2>
<p>ターミナルで、以下のコマンドを実行します。</p>
<pre><code class="language-bash">bin/rails g migration CreateTrackingType
bin/rails g migration CreateShortUrlTrackings
</code></pre>
<p>以下のように編集します。</p>
<ol>
<li>Filename: <code>db/migrate/..._create_tracking_type.rb</code></li>
</ol>
<pre><code class="language-ruby"># frozen_string_literal: true

class CreateTrackingType &lt; ActiveRecord::Migration[7.0]
  def up
    create_enum :tracking_type, %w[imp click]
  end

  def down
    # While there is a `create_enum` method, there is no way to drop it. You can
    # how ever, use raw SQL to drop the enum type.
    execute &lt;&lt;-SQL
      DROP TYPE tracking_type;
    SQL
  end
end
</code></pre>
<ol start="2">
<li>Filename: <code>db/migrate/..._short_url_tracking.rb</code></li>
</ol>
<pre><code class="language-ruby"># frozen_string_literal: true

class CreateShortUrlTracking &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :short_url_trackings, id: :uuid do |t|
      t.references :short_url, foreign_key: true, deferrable: :deferred, type: :uuid, comment: &quot;ShortUrlテーブルの外部キー&quot;
      t.enum :tracking_type, enum_type: :tracking_type, default: :imp, comment: &quot;追跡タイプ&quot;
      t.datetime :created_at, null: false
    end
  end
end
</code></pre>
<p>マイグレーションを実行します。</p>
<pre><code class="language-bash">bin/rails db:migrate
</code></pre>
<h2 id="cmsredisshorturlを作成"><a class="header" href="#cmsredisshorturlを作成">CmsRedis::ShortUrlを作成</a></h2>
<pre><code class="language-bash">touch lib/cms_redis/short_url.rb
</code></pre>
<p>以下のように編集します。</p>
<p>Filename: <code>lib/cms_redis/short_url.rb</code></p>
<pre><code class="language-ruby"># frozen_string_literal: true

module CmsRedis
  class ShortUrl
    EXPIRES = 60 * 60 * 24
    CACHE_KEY = &quot;short-url&quot;

    def initialize(cache_key = &quot;&quot;, expires = EXPIRES)
      @cache_key = cache_key
      @expires = expires
      @connection = ::CmsRedis::Core::Client.new(@cache_key, @expires)
    end

    def fetch
      @connection.fetch do
        []
      end
    end

    def cache?
      @connection.cache?
    end

    def set(hash)
      array = fetch
      array &lt;&lt; hash
      @connection.set(array)
    end

    def del
      @connection.del
    end
  end
end
</code></pre>
<h2 id="shorturltrackingモデルを作成"><a class="header" href="#shorturltrackingモデルを作成">ShortUrlTrackingモデルを作成</a></h2>
<p>ShortUrlTrackingモデルを作成します。ターミナルで、以下のコマンドを実行します。</p>
<pre><code class="language-bash">touch app/models/short_url_tracking.rb
</code></pre>
<p>以下のように編集します。</p>
<p>Filename: <code>app/models/short_url_tracking.rb</code></p>
<pre><code class="language-ruby"># frozen_string_literal: true

class ShortUrlTracking &lt; ApplicationRecord
  belongs_to :short_url

  enum tracking_type: {
    imp: &quot;imp&quot;,
    click: &quot;click&quot;
  }

  scope :when_created_at, -&gt;(date) { where(created_at: date.beginning_of_day..date.end_of_day) }

  # キャッシュに保存されている値を取得して、データベースに保存する
  def self.import_all!
    targets = ShortUrl.fetch_all_from_redis.map { |hash| hash_to_attribute(hash) }
    result = import targets
    ShortUrl.del_all_redis if result.ids.present?
  end

  # キャッシュに保存されている値から、インスタンスを作成する
  def self.hash_to_attribute(hash)
    new(
      short_url_id: hash[:short_url_id],
      tracking_type: hash[:tracking_type],
      created_at: DateTime.strptime(hash[:created_at].to_s, &quot;%s&quot;)
    )
  end

  # 今日作成されたデータを取得する
  def self.created_today
    when_created_at(Date.today)
  end
end
</code></pre>
<h2 id="shorturlモデルの修正"><a class="header" href="#shorturlモデルの修正">ShortUrlモデルの修正</a></h2>
<pre><code class="language-ruby"># frozen_string_literal: true

class ShortUrl &lt; ApplicationRecord
  belongs_to :admin
  has_many :short_url_trackings

  validates :label_name, length: { maximum: 255, too_long: &quot;最大%&lt;count&gt;s文字まで使えます&quot; }
  validates :original_url, presence: true
  validates :utm_source, presence: true, length: { maximum: 255, too_long: &quot;最大%&lt;count&gt;s文字まで使えます&quot; }
  validates :utm_medium, presence: true, length: { maximum: 255, too_long: &quot;最大%&lt;count&gt;s文字まで使えます&quot; }
  validates :utm_campaign, presence: true, length: { maximum: 255, too_long: &quot;最大%&lt;count&gt;s文字まで使えます&quot; }

  before_create :fill_custom_key

  IMP = &quot;imp&quot;
  CLICK = &quot;click&quot;

  def fill_custom_key
    self.custom_key = loop do
      uuid = SecureRandom.alphanumeric(10) # JWlXD6cCxM
      break uuid unless self.class.exists?(custom_key: uuid)
    end
  end

  def short_url
    Rails.application.routes.url_helpers.short_url_url(
      id: custom_key,
      host: Rails.application.routes.default_url_options[:host],
      protocol: Rails.application.routes.default_url_options[:protocol]
    )
  end

  def parameter_url
    query = {
      utm_source: self&amp;.utm_source,
      utm_medium: self&amp;.utm_medium,
      utm_campaign: self&amp;.utm_campaign
    }
    uri = URI.parse(self&amp;.original_url)
    uri.query = query.to_param
    uri.to_s
  end

  # インプレッション数をカウントする
  def imp!
    tracking_to_redis!(tracking_type: IMP)
  end

  # クリック数をカウントする
  def click!
    tracking_to_redis!(tracking_type: CLICK)
  end

  # キャッシュキーを作成する
  def tracking_cache_key
    &quot;#{::CmsRedis::ShortUrl::CACHE_KEY}:#{id}&quot;
  end

  # Redisに接続する
  def connect_redis
    ::CmsRedis::ShortUrl.new(tracking_cache_key)
  end

  # Redisに保存する
  def tracking_to_redis!(tracking_type: IMP)
    hash = {
      short_url_id: id,
      tracking_type: tracking_type,
      created_at: Time.current.to_i
    }
    connect_redis.set(hash)
  end

  # Redisから取得する
  def fetch_from_redis
    connect_redis.fetch
  end

  # Redisから全て取得する
  def self.fetch_all_from_redis
    all.map do |short_url|
      short_url&amp;.fetch_from_redis
    end.flatten
  end

  # Redisから削除する
  def del_redis
    connect_redis.del
  end

  # Redisから全て削除する
  def self.del_all_redis
    all.map do |del_redis|
      del_redis&amp;.del_redis
    end
  end
end
</code></pre>
<h2 id="shorturltrackingを使用してインプレッション数クリック数をカウントする"><a class="header" href="#shorturltrackingを使用してインプレッション数クリック数をカウントする">ShortUrlTrackingを使用して、インプレッション数、クリック数をカウントする</a></h2>
<p>Railsコンソールを起動します。</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>以下のコードを実行します。</p>
<pre><code class="language-ruby">ShortUrl.last.imp!
#=&gt; true
ShortUrl.last.click!
#=&gt; true
ShortUrl.last.fetch_from_redis
#=&gt; [{:short_url_id=&gt;&quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;, :tracking_type=&gt;&quot;imp&quot;, :created_at=&gt;1690701910},
#  {:short_url_id=&gt;&quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;, :tracking_type=&gt;&quot;click&quot;, :created_at=&gt;1690701910}]
</code></pre>
<p><code>imp!</code>、<code>click!</code>メソッドを呼び出すと、Redisに保存され、<code>fetch_from_redis</code>メソッドを呼び出すと、Redisに保存されている値を取得できます。</p>
<p>このメソッドをコントローラーで呼び出すことができれば、インプレッション数、クリック数をカウントすることができます。</p>
<h2 id="ルーティングの設定-3"><a class="header" href="#ルーティングの設定-3">ルーティングの設定</a></h2>
<p>インプレッション数、クリック数のカウントをするために、ルーティングを設定します。</p>
<div class="table-wrapper"><table><thead><tr><th>パス</th><th>説明</th></tr></thead><tbody>
<tr><td><code>/l/:id</code></td><td>確認画面、インプレッション数のカウント</td></tr>
<tr><td><code>/l/:id/click</code></td><td>クリック数のカウント、リダイレクト</td></tr>
</tbody></table>
</div>
<pre><code class="language-bash">touch config/routes/user/short_urls.rb
</code></pre>
<p>Filename: <code>config/routes/user/short_urls.rb</code></p>
<pre><code class="language-ruby"># frozen_string_literal: true

Rails.application.routes.draw do
  get &quot;/l/:id&quot; =&gt; &quot;user/short_urls#show&quot;, as: :short_url
  get &quot;/l/:id/click&quot; =&gt; &quot;user/short_urls#click&quot;, as: :click_short_url
end
</code></pre>
<p><code>bin/rails routes</code>でルーティングが設定されていることを確認します。</p>
<pre><code class="language-bash">bin/rails routes -g short_url
</code></pre>
<p>以下が表示されればOKです。</p>
<pre><code class="language-console">           short_url GET    /l/:id(.:format)                     user/short_urls#show
     click_short_url GET    /l/:id/click(.:format)               user/short_urls#click
</code></pre>
<h2 id="shorturlコントローラー"><a class="header" href="#shorturlコントローラー">ShortUrlコントローラー</a></h2>
<p>ユーザー側のコントローラーを作成します。</p>
<pre><code class="language-bash">touch app/controllers/user/short_urls_controller.rb
</code></pre>
<p>以下のように編集します。</p>
<p>Filename: <code>app/controllers/user/short_urls_controller.rb</code></p>
<pre><code class="language-ruby"># frozen_string_literal: true

class User::ShortUrlsController &lt; User::ApplicationController
  def show
    redirect_to root_url and return unless params[:id].present? &amp;&amp; params[:id] =~ Regexp.new(&quot;\\A[a-zA-Z0-9]{10}+\\z&quot;)

    @short_url = ShortUrl.find_by(custom_key: params[:id])
    redirect_to root_url and return unless @short_url.present?

    # imp計測
    @short_url&amp;.imp!
  end

  def click
    redirect_to root_url and return unless params[:id].present? &amp;&amp; params[:id] =~ Regexp.new(&quot;\\A[a-zA-Z0-9]{10}+\\z&quot;)

    @short_url = ShortUrl.find_by(custom_key: params[:id])
    redirect_to root_url and return unless @short_url.present?

    # click計測
    @short_url&amp;.click!

    # click後のリダイレクト
    redirect_to @short_url&amp;.parameter_url, allow_other_host: true
  end
end
</code></pre>
<h2 id="確認画面を作成"><a class="header" href="#確認画面を作成">確認画面を作成</a></h2>
<pre><code class="language-bash">mkdir -p app/views/user/short_urls &amp;&amp; touch app/views/user/short_urls/show.html.erb
</code></pre>
<p>以下のように編集します。</p>
<p>Filename: <code>app/views/user/short_urls/show.html.erb</code></p>
<pre><code class="language-erb">&lt;main id=&quot;kiji-main&quot;&gt;
  &lt;div class=&quot;container max-width-980&quot;&gt;
    &lt;div class=&quot;article-main&quot;&gt;
      &lt;div class=&quot;article-main-content&quot;&gt;
        外部のサイトに移動します。
        &lt;div class=&quot;article-main-content mt-3&quot;&gt;
          &lt;%= @short_url&amp;.parameter_url %&gt;
        &lt;/div&gt;
        &lt;div class=&quot;article-main-content mt-3&quot;&gt;
          &lt;%= link_to click_short_url_path(id: params[:id]), target: &quot;_blank&quot;, class: &quot;btn&quot; do %&gt;
            外部サイトに移動する
          &lt;% end %&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;footer-breadcrumb&quot;&gt;
      &lt;ul class=&quot;breadcrumb&quot;&gt;
        &lt;li&gt;
          &lt;%= link_to user_top_path do %&gt;
            トップ
          &lt;% end %&gt;
        &lt;/li&gt;
      &lt;/ul&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/main&gt;
</code></pre>
<h2 id="ブラウザで確認してみます"><a class="header" href="#ブラウザで確認してみます">ブラウザで確認してみます</a></h2>
<pre><code class="language-bash">bin/rails s
</code></pre>
<p>別ターミナルで、<code>entrypoint.local.sh</code>を実行します。</p>
<pre><code class="language-bash">sh entrypoint.local.sh
</code></pre>
<p>eg) http://localhost:3000/l/e09i1Zxhye</p>
<p>※管理画面&gt;短縮URL一覧&gt;該当の短縮URL&gt;<code>短縮URL</code>の値をコピー(短縮URLを作成していなければ、作成してください。)</p>
<p>以下のような画面になればOKです。</p>
<p><img src="day-3/./images/short_url_1.png" alt="img" /></p>
<h2 id="再度railsコンソールで確認"><a class="header" href="#再度railsコンソールで確認">再度Railsコンソールで確認</a></h2>
<p>Railsコンソールを起動します。</p>
<pre><code class="language-bash">bin/rails c
</code></pre>
<p>ブラウザで確認した短縮URLのインプレッション数、クリック数がカウントされていることを確認します。</p>
<pre><code class="language-ruby">short_url = ShortUrl.find_by_custom_key(&quot;e09i1Zxhye&quot;) # 自分の環境の値に変更してください
short_url.fetch_from_redis
#=&gt; [{:short_url_id=&gt;&quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;, :tracking_type=&gt;&quot;imp&quot;, :created_at=&gt;1690701910},
#  {:short_url_id=&gt;&quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;, :tracking_type=&gt;&quot;click&quot;, :created_at=&gt;1690701910},
#  {:short_url_id=&gt;&quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;, :tracking_type=&gt;&quot;imp&quot;, :created_at=&gt;1690702930}]
</code></pre>
<h2 id="バッチ処理に必要なコードを実装"><a class="header" href="#バッチ処理に必要なコードを実装">バッチ処理に必要なコードを実装</a></h2>
<p>※バッチ処理の設定は行いません</p>
<pre><code class="language-bash">touch lib/tasks/short_url.rake
</code></pre>
<p>以下のように編集します。</p>
<p>Filename: <code>lib/tasks/short_url.rake</code></p>
<pre><code class="language-ruby"># frozen_string_literal: true

namespace :short_url do
  desc &quot;Insert short_url_tracking data from redis cache&quot;
  task insert: :environment do |task|
    start_message = &quot;#### START: #{task&amp;.name}. ####&quot;
    puts start_message
    Rails.logger.info start_message

    # インプレッション数、クリック数をRedisからデータベースに保存する
    ShortUrlTracking.import_all!

    end_message = &quot;#### END: #{task&amp;.name}. ####&quot;
    puts end_message
    Rails.logger.info end_message
  end
end
</code></pre>
<p>ターミナルを開き、コードを実行します。</p>
<pre><code class="language-bash">bin/rails short_url:insert
#### START: short_url:insert. ####
#### END: short_url:insert. ####
</code></pre>
<p>データベースを見ると、保存されていることが確認できます。</p>
<pre><code class="language-bash">bin/rails c

&gt; ShortUrlTracking.all
# =&gt;   ShortUrlTracking Load (0.5ms)  SELECT &quot;short_url_trackings&quot;.* FROM &quot;short_url_trackings&quot;
# [#&lt;ShortUrlTracking:0x0000ffffb04eda30
#   id: &quot;538c894f-45d7-46f9-9923-ab3922d98c53&quot;,
#   short_url_id: &quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;,
#   tracking_type: &quot;imp&quot;,
#   created_at: Sun, 30 Jul 2023 16:25:10.000000000 JST +09:00&gt;,
#  #&lt;ShortUrlTracking:0x0000ffffb04dbc68
#   id: &quot;4f2512c2-cd8a-4fda-b943-00f15b33cadf&quot;,
#   short_url_id: &quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;,
#   tracking_type: &quot;click&quot;,
#   created_at: Sun, 30 Jul 2023 16:25:10.000000000 JST +09:00&gt;,
#  #&lt;ShortUrlTracking:0x0000ffffb04dbba0
#   id: &quot;f841365e-f2f4-43e9-aa03-8cf7bfb85395&quot;,
#   short_url_id: &quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;,
#   tracking_type: &quot;imp&quot;,
#   created_at: Sun, 30 Jul 2023 16:42:10.000000000 JST +09:00&gt;,
#  #&lt;ShortUrlTracking:0x0000ffffb04dbad8
#   id: &quot;612767db-bc17-420c-a64e-cdc4fa9dd827&quot;,
#   short_url_id: &quot;ae8c2bec-9f69-4de2-bdfb-7dbf453ed3aa&quot;,
#   tracking_type: &quot;imp&quot;,
#   created_at: Sun, 30 Jul 2023 16:42:15.000000000 JST +09:00&gt;]
</code></pre>
<p>あとはバッチ処理を設定すれば、定期的にデータベースに保存されます。
※今回は、バッチ処理の設定は行いません</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="appendix"><a class="header" href="#appendix">Appendix</a></h1>
<ul>
<li><a href="appendix/./mvc-r.html">MVCとルーティング</a></li>
<li><a href="appendix/./routing.html">ルーティングについて</a></li>
<li><a href="appendix/./database-design.html">データベース構造と設計</a></li>
<li><a href="appendix/./database-migration.html">マイグレーション</a></li>
<li><a href="appendix/./active-record.html">ActiveRecordについて</a></li>
<li><a href="appendix/./controller.html">Controllerにまつわる処理ついて</a></li>
<li><a href="appendix/./rails-dev-command.html">Railsでよく使われるコマンド</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mvcとルーティング"><a class="header" href="#mvcとルーティング">MVCとルーティング</a></h1>
<p>MVCとルーティングの関係図</p>
<p><img src="appendix/./image/MVC-R.jpg" alt="img" /></p>
<h2 id="mvcとは"><a class="header" href="#mvcとは">MVCとは</a></h2>
<p>MVCモデルとは、プログラムを役割ごとにModel（モデル）・View（ビュー）・Controller（コントローラー）の3つに分けて管理するソフトウェア設計モデルのことです。
Model・View・Controllerの頭文字を取ってMVCモデルと呼ばれます。</p>
<h3 id="model"><a class="header" href="#model">Model</a></h3>
<p>Model(モデル)は、システムの中で扱うデータを管理する(ビジネスモデル)を担当します。</p>
<p>Webアプリケーションフレームワークは、一般的に <strong>ORM(Object Relational Mapping)</strong> という機能を使って、データベースのテーブルとモデルを紐付けています。
Railsでいえば、app/models/以下のファイルが該当し、ActiveRecordを継承したクラスがモデルとなります。</p>
<p>該当するファイル群: app/models/**</p>
<pre><code class="language-ruby">Article.where(title: '記事タイトル')
Article.find_by(title: '記事タイトル')
</code></pre>
<h3 id="view"><a class="header" href="#view">View</a></h3>
<p>View(ビュー)は、ユーザーが見る画面を担当します。</p>
<p>今回使用するテンプレートエンジンは <strong>ERB</strong> というものです。他には、HamlやSlimなどがあります。</p>
<p>該当するファイル群: app/views/**</p>
<pre><code class="language-ruby">&lt;main&gt;
  &lt;div class=&quot;container px-2 py-3 my-3&quot;&gt;
    &lt;div class=&quot;d-flex justify-content-between align-items-center&quot;&gt;
      &lt;div&gt;&lt;h2 class=&quot;fs-3 fw-bold&quot;&gt;&lt;%= title %&gt;&lt;/h2&gt;&lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/main&gt;
</code></pre>
<h3 id="controller"><a class="header" href="#controller">Controller</a></h3>
<p>Controller(コントローラー)は、ユーザーからのリクエストを受け取り、ModelとViewを制御します。</p>
<p>該当するファイル群: app/controllers/**</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class User::TopController &lt; User::ApplicationController
  def index; end

  def about
    file = File.open Rails.root.join(&quot;app/assets/files/about.md&quot;)
    @markdown = ::MarkdownRenderer.md_to_html(file.read)
  end

  def terms; end

  def privacy
    file = File.open(Rails.root.join(&quot;app/assets/files/privacy.md&quot;))
    @markdown = ::MarkdownRenderer.md_to_html(file.read)
  end
end

</code></pre>
<h2 id="ルーティングとは"><a class="header" href="#ルーティングとは">ルーティングとは</a></h2>
<p>Routing(ルーティング)は、ユーザーからのリクエストをControllerに振り分ける仕組みです。
基本的にはリクエストに応じて、どのControllerのどのActionを呼び出すかを定義します。</p>
<p>該当するファイル群:</p>
<p>config/routes/**</p>
<p>config/routes.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

Rails.application.routes.draw do
  get &quot;/&quot; =&gt; &quot;user/top#index&quot;, as: :user_top
  get &quot;/premium&quot; =&gt; &quot;user/top#premium&quot;, as: :premium
  get &quot;/about&quot; =&gt; &quot;user/top#about&quot;, as: :about
  get &quot;/terms&quot; =&gt; &quot;user/top#terms&quot;, as: :terms
  get &quot;/privacy&quot; =&gt; &quot;user/top#privacy&quot;, as: :privacy
end
</code></pre>
<h2 id="mvcとルーティングの関係"><a class="header" href="#mvcとルーティングの関係">MVCとルーティングの関係</a></h2>
<p>MVCとルーティングの関係を図にすると以下のようになります。
MVCのみ説明されることが多いですが、ルーティングも含めて理解することが大切です。</p>
<p><img src="appendix/./image/MVC-R-2.jpg" alt="img" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ルーティング-1"><a class="header" href="#ルーティング-1">ルーティング</a></h1>
<blockquote>
<p>参考：<a href="https://railsguides.jp/routing.html">Rails のルーティング</a></p>
</blockquote>
<h2 id="ルーティングの基本"><a class="header" href="#ルーティングの基本">ルーティングの基本</a></h2>
<p>ルーティングは、リクエストされたURLに対して、どのコントローラのどのアクションを呼び出すかを決定する仕組みです。</p>
<p>Railsでは、<code>config/routes.rb</code>にルーティングを記述します。</p>
<p>その際に使用するメソッドは、<code>Rails.application.routes.draw</code>です。
ルーティング定義をラップするRails.application.routes.draw do ... endブロックは、ルーターDSLのスコープを確定するのに不可欠です。</p>
<pre><code class="language-ruby">Rails.application.routes.draw do
  # ここにルーティングを記述する
end
</code></pre>
<p>※ <code>config/routes/*</code>にルーティングを記述することで、ファイルを分割することができます。今回の講義ではこちらの方法でルーティングを記述していきます。</p>
<pre><code class="language-console">/workspace/
└── config
    └── routes
        ├── admin
        │   ├── authors.rb
        │   └── categories.rb
        │   ...
        ...
        ├── user
        │   ├── top.rb
        │   ...
</code></pre>
<h3 id="基本的な例"><a class="header" href="#基本的な例">基本的な例</a></h3>
<pre><code class="language-ruby">Rails.application.routes.draw do
  root &quot;articles#index&quot;
  get 'articles/:id', to: 'articles#show'
  post &quot;articles&quot;, to: &quot;articles#create&quot;
end
</code></pre>
<h3 id="ルーティングの対応表"><a class="header" href="#ルーティングの対応表">ルーティングの対応表</a></h3>
<p>基本的にルーティングは、HTTPメソッドとパスに対して、コントローラーとアクションを紐付けます。</p>
<p>例えば、<code>Article</code>に関するリソースを扱う場合、以下のようなルーティングを定義することができます。</p>
<pre><code class="language-ruby">Rails.application.routes.draw do
  get 'articles', to: 'articles#index', as: 'articles'
  get 'articles/new', to: 'articles#new', as: 'new_article'
  post 'articles', to: 'articles#create'
  get 'articles/:id', to: 'articles#show', as: 'article'
  get 'articles/:id/edit', to: 'articles#edit', as: 'edit_article'
  patch 'articles/:id', to: 'articles#update'
  put 'articles/:id', to: 'articles#update'
  delete 'articles/:id', to: 'articles#destroy'
end
</code></pre>
<p>上記の定義では、以下のような対応表が作成されます。</p>
<div class="table-wrapper"><table><thead><tr><th>HTTP Verb</th><th>Path</th><th>Controller#Action</th><th>Named Route Helper</th></tr></thead><tbody>
<tr><td>GET</td><td>/admin/articles</td><td>articles#index</td><td>articles_path</td></tr>
<tr><td>GET</td><td>/admin/articles/new</td><td>articles#new</td><td>new_article_path</td></tr>
<tr><td>POST</td><td>/admin/articles</td><td>articles#create</td><td>articles_path</td></tr>
<tr><td>GET</td><td>/admin/articles/:id</td><td>articles#show</td><td>article_path(:id)</td></tr>
<tr><td>GET</td><td>/admin/articles/:id/edit</td><td>articles#edit</td><td>edit_article_path(:id)</td></tr>
<tr><td>PATCH/PUT</td><td>/admin/articles/:id</td><td>articles#update</td><td>article_path(:id)</td></tr>
<tr><td>DELETE</td><td>/admin/articles/:id</td><td>articles#destroy</td><td>article_path(:id)</td></tr>
</tbody></table>
</div>
<p>※ <code>:id</code>は、リクエストされたURLに含まれるIDを表します。</p>
<p>例）<code>/admin/articles/1</code>の場合、<code>:id</code>は<code>1</code>になります。</p>
<h3 id="recources"><a class="header" href="#recources">recources</a></h3>
<p>CRUDのアクションに対しては、<code>resources</code>メソッドを使用することで、一括でルーティングを定義することができます。</p>
<p>上記の対応表を<code>resources</code>メソッドを使用して定義すると、以下のようになります。</p>
<pre><code class="language-ruby">Rails.application.routes.draw do
  resources :articles
end
</code></pre>
<h3 id="namespace"><a class="header" href="#namespace">namespace</a></h3>
<p><code>namespace</code>を使用することで、コントローラーの名前空間を定義することができます。</p>
<p>例えば、<code>Admin::ArticlesController</code>の場合、以下のように定義することができます。</p>
<p>Filename: app/config/routes/admin/authors.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

Rails.application.routes.draw do
  # namespace :admin で、コントローラーの名前空間(今回の場合は、Admin::)を定義する
  namespace :admin do
    resources :authors
  end
end
</code></pre>
<div class="table-wrapper"><table><thead><tr><th>HTTP Verb</th><th>Path</th><th>Controller#Action</th><th>Named Route Helper</th></tr></thead><tbody>
<tr><td>GET</td><td>/admin/authors</td><td>admin/authors#index</td><td>admin_authors_path</td></tr>
<tr><td>POST</td><td>/admin/authors</td><td>admin/authors#create</td><td>admin_authors_path</td></tr>
<tr><td>GET</td><td>/admin/authors/new</td><td>admin/authors#new</td><td>new_admin_author_path</td></tr>
<tr><td>GET</td><td>/admin/authors/:id</td><td>admin/authors#show</td><td>admin_author_path(:id)</td></tr>
<tr><td>GET</td><td>/admin/authors/:id/edit</td><td>admin/authors#edit</td><td>edit_admin_author_path(:id)</td></tr>
<tr><td>PATCH/PUT</td><td>/admin/authors/:id</td><td>admin/authors#update</td><td>admin_author_path(:id)</td></tr>
<tr><td>DELETE</td><td>/admin/authors/:id</td><td>admin/authors#destroy</td><td>admin_author_path(:id)</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="データベース構造と設計"><a class="header" href="#データベース構造と設計">データベース構造と設計</a></h1>
<h2 id="rdbmsとnosql"><a class="header" href="#rdbmsとnosql">RDBMSとNoSQL</a></h2>
<p>今回使用するデータベースは、PostgreSQLというRDB(RDBMS)を使用します。</p>
<p>RDBMSは、RDBMSとNoSQLの2種類があります。</p>
<ul>
<li>
<p>RDBMS(RDB): MySQL, PostgreSQL, Oracle, SQL Server, SQLiteなど</p>
</li>
<li>
<p>NoSQL: MongoDB, Redis, Cassandra, HBase, Neo4jなど</p>
</li>
</ul>
<p>それぞれ様々な特徴を持ちますが、今回はRDBMSを使用してwebアプリケーションを作成していこうと考えています。</p>
<h2 id="データベースの構造"><a class="header" href="#データベースの構造">データベースの構造</a></h2>
<p>データベースは、データベースサーバと呼ばれるサーバ上で動作し、データベースを管理するためのソフトウェアです。データベースは複数のテーブルを持ち、テーブルは複数のカラムを持ちます。
テーブル同士が関連を持つことを、一般的にリレーションと呼びます。</p>
<h2 id="er図"><a class="header" href="#er図">ER図</a></h2>
<p>ER図は、データベースの構造を図で表したものです。ER図を作成することで、データベースの構造を可視化することができます。</p>
<pre class="mermaid">erDiagram
  authors ||--o{ articles : &quot;&quot;
  categories ||--o{ articles : &quot;&quot;
  articles ||--o{ article_tags : &quot;&quot;
  tags ||--o{ article_tags : &quot;&quot;
  articles ||--o{ article_series : &quot;&quot;
  series ||--o{ article_series : &quot;&quot;
</pre>
<h2 id="リレーション"><a class="header" href="#リレーション">リレーション</a></h2>
<p>基本的にリレーションには、1対1、1対多、多対多の3種類があります。データベースでは、この3種類のリレーションを組み合わせて設計します。
サービスの特性や要件によって、テーブル構造やリレーションは異なるので、それぞれのサービスに合わせて設計していきます。</p>
<h3 id="1対1"><a class="header" href="#1対1">1対1</a></h3>
<p>例）1人の人間は、1人のパートナーを持つことができます。1人のパートナーは、1人の人間を持つことができます。</p>
<pre class="mermaid">erDiagram
  person ||--o| partner : &quot;&quot;
</pre>
<p>Railsでの実装例</p>
<pre><code class="language-ruby">class Person &lt; ApplicationRecord
  has_one :partner
end

class Partner &lt; ApplicationRecord
  belongs_to :person
end
</code></pre>
<h3 id="1対多"><a class="header" href="#1対多">1対多</a></h3>
<p>例）1人の人間は、複数のパートナーを持つことができます。1人のパートナーは、1人の人間を持つことができます。</p>
<pre class="mermaid">erDiagram
  person ||--o{ partners : &quot;&quot;
</pre>
<p>Railsでの実装例</p>
<pre><code class="language-ruby">class Person &lt; ApplicationRecord
  has_many :partners
end

class Partner &lt; ApplicationRecord
  belongs_to :person
end
</code></pre>
<h3 id="多対多"><a class="header" href="#多対多">多対多</a></h3>
<p>例）1人の人間は、複数のパートナーを持つことができます。1人のパートナーは、複数の人間を持つことができます。</p>
<pre class="mermaid">erDiagram
  person ||--o{ person_partners : &quot;&quot;
  partner ||--o{ person_partners : &quot;&quot;
</pre>
<p>Railsでの実装例</p>
<pre><code class="language-ruby">class Person &lt; ApplicationRecord
  has_many :person_partners
  has_many :partners, through: :person_partners
end

class Partner &lt; ApplicationRecord
  has_many :person_partners
  has_many :people, through: :person_partners
end

class PersonPartner &lt; ApplicationRecord
  belongs_to :person
  belongs_to :partner
end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="マイグレーション-3"><a class="header" href="#マイグレーション-3">マイグレーション</a></h1>
<h2 id="マイグレーションとは"><a class="header" href="#マイグレーションとは">マイグレーションとは</a></h2>
<p>マイグレーションとは、データベースのスキーマを変更することです。
データベースのスキーマとは、データベースの構造のことです。</p>
<p>例えば、テーブルの追加や削除、カラムの追加や削除、インデックスの追加や削除などです。</p>
<h2 id="マイグレーションの図解"><a class="header" href="#マイグレーションの図解">マイグレーションの図解</a></h2>
<p>スライドにも記載していますが、マイグレーションは基本的に以下の手順で行います。</p>
<ol>
<li>マイグレーションファイルを作成する</li>
<li>マイグレーションファイルを実行する</li>
<li>データベースのスキーマが変更される</li>
</ol>
<p><img src="appendix/./image/migration.jpg" alt="img" /></p>
<!-- ## マイグレーションの注意点

### データベースのスキーマを変更するときは必ずマイグレーションを使う

### バージョン管理

### 実際のデータが消える場合があることに注意する -->
<h2 id="マイグレーションで使用するデータ型"><a class="header" href="#マイグレーションで使用するデータ型">マイグレーションで使用するデータ型</a></h2>
<div class="table-wrapper"><table><thead><tr><th>型</th><th>説明</th></tr></thead><tbody>
<tr><td><code>:binary</code></td><td>バイナリデータを保存するために使用します</td></tr>
<tr><td><code>:boolean</code></td><td>真偽値（真または偽）を保存するために使用します</td></tr>
<tr><td><code>:date</code></td><td>日付データを保存するために使用します</td></tr>
<tr><td><code>:datetime</code></td><td>日付と時間のデータを保存するために使用します</td></tr>
<tr><td><code>:decimal</code></td><td>有理数を保存するために使用し、小数点数の精度を指定することができます</td></tr>
<tr><td><code>:float</code></td><td>浮動小数点数を保存するために使用します</td></tr>
<tr><td><code>:integer</code></td><td>整数データを保存するために使用します</td></tr>
<tr><td><code>:bigint</code></td><td>大きな整数データを保存するために使用します</td></tr>
<tr><td><code>:primary_key</code></td><td>主キーを作成するために使用します</td></tr>
<tr><td><code>:references</code></td><td>別のモデルへの参照（外部キー）を作成するために使用します</td></tr>
<tr><td><code>:string</code></td><td>短い文字列データを保存するために使用します</td></tr>
<tr><td><code>:text</code></td><td>長い文字列データを保存するために使用します</td></tr>
<tr><td><code>:time</code></td><td>時間データを保存するために使用します</td></tr>
<tr><td><code>:timestamp</code></td><td>日付と時間のデータを保存するために使用します</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="activerecordについて"><a class="header" href="#activerecordについて">ActiveRecordについて</a></h1>
<p>ActiveRecordとは、RailsのORM(Object Relational Mapping)のことです。データベースのテーブルと、Rubyのオブジェクトをマッピングすることで、データベースの操作をRubyのコードで行うことができます。</p>
<p>例えば、<code>show</code>アクションのコードを見てみましょう。</p>
<pre><code class="language-ruby">def show
  @author = Author.find(params[:id])

  # `http://localhost:3000/admin/authors/1`というURLにアクセスした場合、
  # `params[:id]`は`1`という値になります。
  # そのため、`Author.find(params[:id])`というコードは、
  # `authors`テーブルから`id`が`1`のレコードを取得するという意味になります。
  # つまり、Author.find(&quot;1&quot;)となります。
end
</code></pre>
<ul>
<li>
<p><code>Author.find(params[:id])</code>というコードがありますが、これは、<code>authors</code>テーブルから<code>id</code>が<code>params[:id]</code>のレコードを取得するという意味です。</p>
</li>
<li>
<p><code>find</code>メソッドは、<code>ActiveRecord::Base</code>クラスのメソッドです。<code>Author</code>モデルは、<code>ActiveRecord::Base</code>クラスを継承しているので、<code>find</code>メソッドを使用することができます。<code>find</code>メソッドは、指定された<code>id</code>のレコードを取得することができます。</p>
</li>
<li>
<p>params[:id]は、URLのパスに含まれる<code>:id</code>という名前のパラメータの値を取得することができます。例えば、<code>http://localhost:3000/admin/authors/1</code>というURLの場合、<code>:id</code>の値は<code>1</code>になります。</p>
</li>
</ul>
<h2 id="save-updateメソッド"><a class="header" href="#save-updateメソッド">save, updateメソッド</a></h2>
<p>saveメソッドは、レコードを保存するメソッドです。<code>create</code>メソッドや<code>update</code>メソッドを実行すると、内部で<code>save</code>メソッドが実行されます。</p>
<pre><code class="language-ruby">def create
  @author = Author.new(create_params)
  # 以下の部分
  if @author.save
    flash.now.notice = t(&quot;admin.create.success&quot;)
    redirect_to admin_authors_path
  else
    flash.now.alert = t(&quot;admin.create.failed&quot;)
    render :new, status: :unprocessable_entity
  end
end
</code></pre>
<p>レコード保存関連のメソッドまとめ</p>
<p>戻り値が重要です。true/falseで判定したい場合は、saveメソッドを使用する。失敗した時に例外を投げたい場合は、ビックリマークが使用されているsave!やupdate!メソッドを使用します。</p>
<div class="table-wrapper"><table><thead><tr><th>メソッド名</th><th>使用例</th><th>戻り値</th><th>備考</th></tr></thead><tbody>
<tr><td>save</td><td><code>user.save</code></td><td>成功時は<code>true</code>、失敗時は<code>false</code></td><td>レコードを保存します。バリデーションに失敗した場合でも例外を投げません。</td></tr>
<tr><td>save!</td><td><code>user.save!</code></td><td>成功時は<code>true</code></td><td>レコードを保存します。バリデーションに失敗すると例外(ActiveRecord::RecordInvalid)を投げます。</td></tr>
<tr><td>create</td><td><code>User.create(name: 'Alice')</code></td><td>新規作成したオブジェクト</td><td>新規レコードを生成し、成功時に保存します。バリデーションに失敗した場合でも例外を投げません。</td></tr>
<tr><td>create!</td><td><code>User.create!(name: 'Alice')</code></td><td>新規作成したオブジェクト</td><td>新規レコードを生成し、保存します。バリデーションに失敗すると例外(ActiveRecord::RecordInvalid)を投げます。</td></tr>
<tr><td>update</td><td><code>user.update(name: 'Bob')</code></td><td>成功時は<code>true</code>、失敗時は<code>false</code></td><td>レコードを更新します。バリデーションに失敗した場合でも例外を投げません。</td></tr>
<tr><td>update!</td><td><code>user.update!(name: 'Bob')</code></td><td>成功時は<code>true</code></td><td>レコードを更新します。バリデーションに失敗すると例外(ActiveRecord::RecordInvalid)を投げます。</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="controllerにまつわる処理ついて"><a class="header" href="#controllerにまつわる処理ついて">Controllerにまつわる処理ついて</a></h1>
<h2 id="strong-parameters-2"><a class="header" href="#strong-parameters-2">Strong Parameters</a></h2>
<p>Strong Parametersとは、Railsで提供されている機能で、フォームから送信されたデータを安全に取得することができます。</p>
<p>[code]</p>
<pre><code class="language-ruby">private

def create_params
  params.require(:author).permit(
    :name,
    :bio
  )
end
</code></pre>
<ul>
<li>
<p><code>Parameters: {&quot;authenticity_token&quot;=&gt;&quot;[FILTERED]&quot;, &quot;author&quot;=&gt;{&quot;name&quot;=&gt;&quot;Yuki Tanaka&quot;, &quot;bio&quot;=&gt;&quot;Yuki Tanaka2&quot;}, &quot;id&quot;=&gt;&quot;326b474f-908b-490d-8d61-9b8d024a677f&quot;}</code>というようなデータがあるとします。このデータは、<code>params</code>というメソッドで取得することができます。</p>
</li>
<li>
<p><code>params</code>メソッドは、<code>ActionController::Parameters</code>クラスのインスタンスを返します。このクラスは、<code>Hash</code>クラスを継承しているので、<code>Hash</code>クラスのメソッドを使用することができます。</p>
</li>
<li>
<p><code>params</code>メソッドで取得したデータは、<code>require</code>メソッドで指定したキーの値を取得することができます。例えば、<code>params.require(:author)</code>とすると、<code>params</code>メソッドで取得したデータの<code>:author</code>というキーの値を取得することができます。</p>
</li>
<li>
<p><code>permit</code>メソッドは、<code>require</code>メソッドで取得したデータのうち、指定したキーの値を取得することができます。例えば、<code>params.require(:author).permit(:name, :bio)</code>とすると、<code>params</code>メソッドで取得したデータの<code>:author</code>というキーの値のうち、<code>:name</code>と<code>:bio</code>というキーの値のみ取得することができます。</p>
</li>
<li>
<p>ブラウザなどから予期しないデータが送信されたとしても、<code>permit</code>メソッドで指定したキーの値のみ取得することができるので、安全にデータを取得することができます。</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="railsでよく使われるコマンド"><a class="header" href="#railsでよく使われるコマンド">Railsでよく使われるコマンド</a></h1>
<h2 id="binrails-generate--binrails-g"><a class="header" href="#binrails-generate--binrails-g">bin/rails generate || bin/rails g</a></h2>
<h3 id="binrails-g-migration"><a class="header" href="#binrails-g-migration">bin/rails g migration</a></h3>
<p>マイグレーションファイルを作成します。マイグレーションは、データベースの構造を変更するためのファイルです。Railsでは、マイグレーションを使ってデータベースの構造を変更します。</p>
<ul>
<li>db/migrate/にマイグレーションファイルを作成します。</li>
</ul>
<p>[command]</p>
<pre><code class="language-console">bin/rails g migration CreateTags
</code></pre>
<pre><code class="language-console">/workspace# bin/rails g migration CreateTags
      invoke  active_record
      create    db/migrate/20230708053757_create_tags.rb
</code></pre>
<p>[output]</p>
<p>コマンドを実行すると以下のファイルが作成されます。</p>
<p>Filename: db/migrate/20230708053757_create_tags.rb</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class CreateTags &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :tags do |t|

      t.timestamps
    end
  end
end
</code></pre>
<p>テーブルに定義したいカラムを追加します。タグ名を管理するためにnameカラムを追加したい場合は、以下のように記述します。</p>
<pre><code class="language-ruby"># frozen_string_literal: true

class CreateTags &lt; ActiveRecord::Migration[7.0]
  def change
    create_table :tags, id: :uuid do |t|
      t.string :name, null: false, comment: &quot;タグ名&quot;
      t.timestamps
    end
  end
end
</code></pre>
<p>マイグレーションしたい場合は、<code>bin/rails db:migrate</code>を実行します。</p>
<h3 id="binrails-g-model"><a class="header" href="#binrails-g-model">bin/rails g model</a></h3>
<p><code>bin/rails g model</code>は、モデルを作成するコマンドです。モデルは、データベースのテーブルと対応するクラスです。モデルを作成すると、以下のファイルが作成されます。</p>
<ul>
<li>app/models/にモデルファイルを作成します。</li>
<li>db/migrate/にマイグレーションファイルを作成します。</li>
<li>test/models/にテストファイルを作成します。</li>
<li>test/fixtures/にテストデータを作成します。</li>
</ul>
<p>[command]</p>
<pre><code class="language-console">bin/rails g model Tag
</code></pre>
<p>モデル作成時に、カラムを指定することもできます。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails g model Tag name:string
</code></pre>
<h3 id="binrails-g-controller"><a class="header" href="#binrails-g-controller">bin/rails g controller</a></h3>
<p><code>bin/rails g controller</code>は、コントローラを作成するコマンドです。コントローラは、アクションと呼ばれるメソッドを定義するクラスです。コントローラを作成すると、以下のファイルが作成されます。</p>
<ul>
<li>app/controllers/にコントローラファイルを作成します。</li>
<li>app/views/にビューファイルを作成します。</li>
<li>test/controllers/にテストファイルを作成します。</li>
<li>app/helpers/にヘルパーファイルを作成します。</li>
<li>test/fixtures/にテストデータを作成します。</li>
<li>config/routes.rbにルーティングを追加します。</li>
<li>app/assets/stylesheets/にCSSファイルを作成します。</li>
<li>app/assets/javascripts/にJavaScriptファイルを作成します。</li>
</ul>
<p>[command]</p>
<pre><code class="language-console">bin/rails g controller Tags
</code></pre>
<p>名前空間を指定することもできます。</p>
<pre><code class="language-console">bin/rails g controller Admin::Tags
</code></pre>
<h2 id="binrails-server--binrails-s"><a class="header" href="#binrails-server--binrails-s">bin/rails server || bin/rails s</a></h2>
<p>Railsの開発用サーバー(Puma)を起動します。Railsの開発中によく使うコマンドで、ブラウザからアクセスすることができます。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails server
</code></pre>
<p>短縮形である<code>bin/rails s</code>でも起動できます。</p>
<pre><code class="language-console">bin/rails s
</code></pre>
<h3 id="ポート番号を指定する"><a class="header" href="#ポート番号を指定する">ポート番号を指定する</a></h3>
<p>デフォルトでは、Railsの開発用サーバーは3000番ポートで起動します。ポート番号を変更する場合は、<code>-p</code>オプションを使います。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails server -p 3001
</code></pre>
<h3 id="ホスト名を指定する"><a class="header" href="#ホスト名を指定する">ホスト名を指定する</a></h3>
<p>デフォルトでは、Railsの開発用サーバーは<code>localhost</code>のみからのアクセスを受け付けます。ホスト名を変更する場合は、<code>-b</code>オプションを使います。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails s -b 0.0.0.0
</code></pre>
<h2 id="binrails-console--binrails-c"><a class="header" href="#binrails-console--binrails-c">bin/rails console || bin/rails c</a></h2>
<p>Railsのコンソールを起動します。開発中によく使うコマンドで、Railsのコードを実行したり、データベースの操作を行ったりすることができます。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails console
</code></pre>
<p>短縮形である<code>bin/rails c</code>でも起動できます。</p>
<pre><code class="language-console">bin/rails c
</code></pre>
<h3 id="環境ごとのコンソールを起動する"><a class="header" href="#環境ごとのコンソールを起動する">環境ごとのコンソールを起動する</a></h3>
<p>webアプリケーションの開発では、開発環境と本番環境で動作が異なることがあります。Railsでは、開発環境と本番環境で動作を変えることができます。開発環境のコンソールを起動するには、<code>-e</code>オプションを使います。</p>
<pre><code class="language-console"># 環境を指定してコンソールを起動する
bin/rails c -e production
bin/rails c -e staging
</code></pre>
<p>環境を指定しない場合は、開発環境のコンソールが起動します。</p>
<pre><code class="language-console"># 環境を指定しない場合は、開発環境のコンソールが起動する
bin/rails c

# 以下のコマンドと同じ
bin/rails c -e development
</code></pre>
<h2 id="binrails-routes-1"><a class="header" href="#binrails-routes-1">bin/rails routes</a></h2>
<p>Railsのルーティングを確認することができます。</p>
<p>以下のコマンドでは、定義されている全てのルーティングを確認することができます。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails routes
</code></pre>
<h3 id="コントローラーごとにルーティングを確認する"><a class="header" href="#コントローラーごとにルーティングを確認する">コントローラーごとにルーティングを確認する</a></h3>
<p><code>--controller</code> or　<code>-c</code>オプションをつけると、コントローラーごとにルーティングを確認することができます。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails routes --controller tags
bin/rails routes -c tags
</code></pre>
<h3 id="ルーティングの一部を確認する"><a class="header" href="#ルーティングの一部を確認する">ルーティングの一部を確認する</a></h3>
<p><code>--grep</code> or　<code>-g</code>オプションをつけると、指定した文字列を含むルーティングを確認することができます。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails routes --grep tag
bin/rails routes -g tag
</code></pre>
<p><code>grep</code>コマンドを使っても同じことができます。</p>
<pre><code class="language-console"># bin/rails routes -g tagとほとんど同じ
bin/rails routes | grep tag
</code></pre>
<h2 id="binrails-dbmigratestatus"><a class="header" href="#binrails-dbmigratestatus">bin/rails db:migrate:status</a></h2>
<p>データベースのマイグレーションの状態を確認することができます。</p>
<p>RAILS_ENVを指定しない場合は、開発環境のマイグレーションの状態が確認できます。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails db:migrate:status

# 上記のコマンドの結果は以下のコマンドと同じ
bin/rails db:migrate:status RAILS_ENV=development
</code></pre>
<p>[output]</p>
<pre><code class="language-console">database: gs_expansion_rails_sample_db

 Status   Migration ID    Migration Name
--------------------------------------------------
   up     20230521111713  Create active storage tablesactive storage
   up     20230521112655  Create users
   up     20230521113755  Create user registrations
   up     20230521113756  Create user database authentications
   up     20230521113757  Create user account lockings
   up     20230521113758  Create user account trackings
   up     20230521113759  Create user password reset requests
   up     20230522112655  Create admins
   up     20230522113755  Create admin registrations
   up     20230522113756  Create admin database authentications
   up     20230522113757  Create admin account lockings
   up     20230522113758  Create admin account trackings
   up     20230522113759  Create admin password reset requests
   up     20230529075027  Create authors
   up     20230529085435  Create current status enum
   up     20230529085530  Create categories
   up     20230529113755  Create action text tablesaction text
</code></pre>
<h3 id="環境ごとのマイグレーションの状態を確認する"><a class="header" href="#環境ごとのマイグレーションの状態を確認する">環境ごとのマイグレーションの状態を確認する</a></h3>
<p>特定の環境に対してマイグレーションのステータスを確認したい場合は、環境変数RAILS_ENVを使用して環境を設定することができます。</p>
<pre><code class="language-console">RAILS_ENV=production bin/rails db:migrate:status
bin/rails db:migrate:status RAILS_ENV=production
</code></pre>
<p>※ 前後ろどちらで実行しても実行結果は同じです。</p>
<h2 id="binrails-dbmigrate"><a class="header" href="#binrails-dbmigrate">bin/rails db:migrate</a></h2>
<p>データベースのマイグレーションを実行します。RAILS_ENVを指定しない場合は、開発環境のマイグレーションが実行されます。</p>
<p>開発環境以外で誤ってマイグレーションを実行してしまっても、その環境のマイグレーションに影響はありません(RAILS_ENVが分けられている前提)。</p>
<p>[command]</p>
<pre><code class="language-console">bin/rails db:migrate

# 上記のコマンドの結果は以下のコマンドと同じ
bin/rails db:migrate RAILS_ENV=development
</code></pre>
<h3 id="環境ごとにマイグレーションを実行する"><a class="header" href="#環境ごとにマイグレーションを実行する">環境ごとにマイグレーションを実行する</a></h3>
<p>特定の環境に対してマイグレーションを実行したい場合は、環境変数RAILS_ENVを使用して環境を設定することができます。</p>
<pre><code class="language-console">RAILS_ENV=production bin/rails db:migrate
bin/rails db:migrate RAILS_ENV=production
</code></pre>
<p>※ 前後ろどちらで実行しても実行結果は同じです。</p>
<h2 id="binrails-dbrollback"><a class="header" href="#binrails-dbrollback">bin/rails db:rollback</a></h2>
<p>データベースのマイグレーションをロールバックします。RAILS_ENVを指定しない場合は、開発環境のマイグレーションがロールバックされます。</p>
<p>ロールバックは、一つ前のマイグレーションをロールバックすることができます。</p>
<pre><code class="language-console">bin/rails db:rollback

# 上記のコマンドの結果は以下のコマンドと同じ
bin/rails db:rollback RAILS_ENV=development
</code></pre>
<h4 id="例1-1"><a class="header" href="#例1-1">例1</a></h4>
<p>例えば、以下のようなマイグレーション([status])があった場合、<code>bin/rails db:rollback</code>を実行すると、<code>20230529113755  Create action text tablesaction text</code>がロールバックされます。</p>
<p>[status]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   up     20230529085530  Create categories
   up     20230529113755  Create action text tablesaction text
</code></pre>
<p>[command]</p>
<pre><code class="language-console">bin/rails db:rollback
</code></pre>
<p>[output]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   up     20230529085530  Create categories
   down     20230529113755  Create action text tablesaction text
</code></pre>
<h4 id="例2-1"><a class="header" href="#例2-1">例2</a></h4>
<p>また以下のようなマイグレーション([status])があった場合、<code>bin/rails db:rollback</code>を実行すると、<code>20230529085530  Create categories</code>がロールバックされます。</p>
<p>[status]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   up     20230529085530  Create categories
   down     20230529113755  Create action text tablesaction text
</code></pre>
<p>[command]</p>
<pre><code class="language-console">bin/rails db:rollback
</code></pre>
<p>[output]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   down     20230529085530  Create categories
   down     20230529113755  Create action text tablesaction text
</code></pre>
<h3 id="まとめてロールバックする"><a class="header" href="#まとめてロールバックする">まとめてロールバックする</a></h3>
<p><code>bin/rails db:rollback STEP=2</code>のようにSTEPオプションを指定することで、複数のマイグレーションをまとめてロールバックすることができます。</p>
<p>[status]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   up     20230529085530  Create categories
   up     20230529113755  Create action text tablesaction text
</code></pre>
<p>[command]</p>
<pre><code class="language-console">bin/rails db:rollback STEP=2
</code></pre>
<p>[output]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   down     20230529085530  Create categories
   down     20230529113755  Create action text tablesaction text
</code></pre>
<h3 id="特定のマイグレーションのみロールバックする"><a class="header" href="#特定のマイグレーションのみロールバックする">特定のマイグレーションのみロールバックする</a></h3>
<p><code>bin/rails db:migrate:down VERSION=20230529085530</code>のようにVERSIONオプションを指定することで、特定のマイグレーションのみロールバックすることができます。</p>
<p>[status]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   up     20230529085530  Create categories
   up     20230529113755  Create action text tablesaction text
</code></pre>
<p>[command]</p>
<pre><code class="language-console">bin/rails db:migrate:down VERSION=20230529085530
</code></pre>
<p>[output]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   down     20230529085530  Create categories
   up     20230529113755  Create action text tablesaction text
</code></pre>
<h2 id="binrails-dbmigrateup"><a class="header" href="#binrails-dbmigrateup">bin/rails db:migrate:up</a></h2>
<p>データベースのマイグレーションを実行します。RAILS_ENVを指定しない場合は、開発環境のマイグレーションが実行されます。</p>
<p>ロールバックしたマイグレーションを再度実行することができます。以下のように、<code>bin/rails db:migrate:up VERSION=20230529085530</code>のようにVERSIONオプションを指定することで、特定のマイグレーションのみ実行することができます。</p>
<p>[status]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   down     20230529085530  Create categories
   up     20230529113755  Create action text tablesaction text
</code></pre>
<p>[command]</p>
<pre><code class="language-console">bin/rails db:migrate:up VERSION=20230529085530
</code></pre>
<p>[output]</p>
<pre><code class="language-console"> Status   Migration ID    Migration Name
--------------------------------------------------
   up     20230529085530  Create categories
   up     20230529113755  Create action text tablesaction text
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
